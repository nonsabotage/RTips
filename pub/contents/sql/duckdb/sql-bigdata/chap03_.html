<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>データ加工のためのSQL – R Tips</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../contents/sql/duckdb/sql-bigdata/chap04_.html" rel="next">
<link href="../../../../contents/sql/duckdb/sql-bigdata/index.html" rel="prev">
<script src="../../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap-029eb6d98d0d67994351ddf54abe5c11.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;800&amp;display=swap" rel="stylesheet">


<link rel="stylesheet" href="../../../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">R Tips</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-home" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Home</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-home">    
        <li>
    <a class="dropdown-item" href="../../../../index.html">
 <span class="dropdown-text">Home</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-web-site" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Web Site</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-web-site">    
        <li class="dropdown-header">ALL</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/website/r4ds2e/index.html">
 <span class="dropdown-text">R for Data Science 2e</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/website/leaflet4r/index.html">
 <span class="dropdown-text">Leaflet for R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/website/analizeUSCensus/index.html">
 <span class="dropdown-text">Analyzing US Census Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/website/graphic_design_with_ggplot2/index.html">
 <span class="dropdown-text">Graphic Design with ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/website/udemy_database-specialist/am-2-note.html">
 <span class="dropdown-text">Udemyデータベーススペシャリスト</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/website/quarto/guide/index.html">
 <span class="dropdown-text">QuartoDashboard</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-books" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">books</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-books">    
        <li class="dropdown-header">note</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/books/13_教員のため教育データ分析/index.html">
 <span class="dropdown-text">教員のための教育データ分析</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/14_入門統計学/index.html">
 <span class="dropdown-text">入門統計学</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/15_プロになるためのWeb技術入門/index.html">
 <span class="dropdown-text">プロになるためのWeb技術入門</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">R</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/books/01_Rによる実証分析_2e/index.html">
 <span class="dropdown-text">Rによる実証分析2e</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/02_因果推論ミックステープ/index.html">
 <span class="dropdown-text">因果推論ミックステープ</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/03_数値シミュレーションで身につける統計の仕組み/index.html">
 <span class="dropdown-text">数値シミュレーションで学ぶ統計の仕組み</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/05_統計的因果推論の理論と実際/index.html">
 <span class="dropdown-text">統計的因果推論の理論と実際</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Python</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/books/06_Pythonではじめる数理最適化/index.html">
 <span class="dropdown-text">Pythonではじめる数理最適化 2nd</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/07_NumpyInfinity/ch01_Pythonの基礎.html">
 <span class="dropdown-text">Numpy Infinity</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/08_handbook_lightgbm/cl02_データ理解.html">
 <span class="dropdown-text">LightGBMハンドブック</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/09_Pythonで学ぶ数理最適化/ch01-基礎編.html">
 <span class="dropdown-text">Pythonで学ぶ数理最適化</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/10_爆速Python/ch02_組込み機能のパフォーマンスを最大限に引き出す.html">
 <span class="dropdown-text">爆速Python</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/11_Pythonではじめる時系列分析入門/index.html">
 <span class="dropdown-text">Pythonではじめる時系列分析</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/books/12_いきなりPython/index.html">
 <span class="dropdown-text">いきなりPython</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-libs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">libs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-libs">    
        <li class="dropdown-header">R</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/argparse/index.html">
 <span class="dropdown-text">argparse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/arrow/index.html">
 <span class="dropdown-text">arrow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/assertr/index.html">
 <span class="dropdown-text">assertr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/base/working.html">
 <span class="dropdown-text">base</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/corrr/working.html">
 <span class="dropdown-text">corrr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/ComplexHeatmap/working.html">
 <span class="dropdown-text">ComplexHeatmap</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/duckdb/working.html">
 <span class="dropdown-text">duckdb</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/dbplyr/working.html">
 <span class="dropdown-text">dbplyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/DBI/working.html">
 <span class="dropdown-text">DBI</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/ggspatial/working.html">
 <span class="dropdown-text">ggspatial</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/GGally/working.html">
 <span class="dropdown-text">GGally</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/ggtext/working.html">
 <span class="dropdown-text">ggtext</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/ggfittext/working.html">
 <span class="dropdown-text">ggfittext</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/gganimate/working.html">
 <span class="dropdown-text">gganimate</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/ggmosaic/working.html">
 <span class="dropdown-text">ggmosaic</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/ggplot2/index.html">
 <span class="dropdown-text">ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/legendry/index.html">
 <span class="dropdown-text">legendry</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/treemapify/working.html">
 <span class="dropdown-text">treemapify</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/tidyverse/index.html">
 <span class="dropdown-text">tidyverse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/sf/working.html">
 <span class="dropdown-text">sf</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/igraph/index.html">
 <span class="dropdown-text">igraph</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/patchwork/working.html">
 <span class="dropdown-text">pathcwork</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/plotly/index.html">
 <span class="dropdown-text">plotly</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/R/pointblank/index.html">
 <span class="dropdown-text">pointblank</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Python</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/Python/pydantic/index.html">
 <span class="dropdown-text">pydantic</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/Python/pandera/index.html">
 <span class="dropdown-text">pandera</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/Python/duckdb/index.html">
 <span class="dropdown-text">duckdb</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/Python/sqlite3/index.html">
 <span class="dropdown-text">sqlite3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/libs/Python/plotnine/index.html">
 <span class="dropdown-text">plotnine</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-notes">    
        <li class="dropdown-header">Notes</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/notes/ggplot2/index.html">
 <span class="dropdown-text">ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/notes/development/index.html">
 <span class="dropdown-text">development</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/notes/development/index.html">
 <span class="dropdown-text">bash</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-utils" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Utils</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-utils">    
        <li class="dropdown-header">Utils</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/utils/01_写真GPS/index.html">
 <span class="dropdown-text">01_写真GPS</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-sql" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">sql</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-sql">    
        <li class="dropdown-header">DuckDB</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/sql/duckdb/documentaion/index.html">
 <span class="dropdown-text">Documentaion</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/sql/duckdb/sql-bigdata/index.html">
 <span class="dropdown-text">ビッグデータレシピ</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/sql/duckdb/mytips/01_.html">
 <span class="dropdown-text">My Tips</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/sql/duckdb/SpatialDataAnalysiswithDuckDB/working.html">
 <span class="dropdown-text">Spatial DataAnalysis with DuckDB</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-test" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Test</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-test">    
        <li class="dropdown-header">Test</li>
        <li>
    <a class="dropdown-item" href="../../../../contents/test/bash/quick_sample.html">
 <span class="dropdown-text">Bash</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/test/R/renv.html">
 <span class="dropdown-text">R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/test/R2/renv.html">
 <span class="dropdown-text">R2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../contents/test/python/notebook.html">
 <span class="dropdown-text">Python</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">DuckDB</li><li class="breadcrumb-item"><a href="../../../../contents/sql/duckdb/sql-bigdata/index.html">ビッグデータレシピ</a></li><li class="breadcrumb-item"><a href="../../../../contents/sql/duckdb/sql-bigdata/chap03_.html">データ加工のためのSQL</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">DuckDB</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Documentaion</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/documentaion/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">はじめに</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/documentaion/guide_01_data_import_export.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Import &amp; Export</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/documentaion/guide_02_configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configuration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/documentaion/guide_04_sql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SQL</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/documentaion/guides_python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Jupyter Notebooks</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">ビッグデータレシピ</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/sql-bigdata/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">はじめに</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/sql-bigdata/chap03_.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">データ加工のためのSQL</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/sql-bigdata/chap04_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">売上を把握するためのデータ抽出</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/sql-bigdata/chap05_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ユーザーを把握するためのデータ抽出</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/sql-bigdata/chap06_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Webサイトでの行動を把握するためのデータ抽出</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/sql-bigdata/chap07_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">データ活用の精度を高めるための分析術</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">My Tips</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/mytips/01_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">交差演算</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/mytips/02_.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">クイックメモ</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Spatial DataAnalysis with DuckDB</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../contents/sql/duckdb/SpatialDataAnalysiswithDuckDB/working.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data Analytics With Duckdb</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">1</span> Setup</a></li>
  <li><a href="#つの値に対する操作" id="toc-つの値に対する操作" class="nav-link" data-scroll-target="#つの値に対する操作"><span class="header-section-number">2</span> 1つの値に対する操作</a>
  <ul class="collapse">
  <li><a href="#コード値をラベルに置き換える" id="toc-コード値をラベルに置き換える" class="nav-link" data-scroll-target="#コード値をラベルに置き換える"><span class="header-section-number">2.1</span> コード値をラベルに置き換える</a></li>
  <li><a href="#urlから要素を取り出す" id="toc-urlから要素を取り出す" class="nav-link" data-scroll-target="#urlから要素を取り出す"><span class="header-section-number">2.2</span> URLから要素を取り出す</a>
  <ul class="collapse">
  <li><a href="#urlからパスやクエリパラメータを取り出す" id="toc-urlからパスやクエリパラメータを取り出す" class="nav-link" data-scroll-target="#urlからパスやクエリパラメータを取り出す"><span class="header-section-number">2.2.1</span> URLからパスやクエリパラメータを取り出す</a></li>
  </ul></li>
  <li><a href="#文字列を配列に分解する" id="toc-文字列を配列に分解する" class="nav-link" data-scroll-target="#文字列を配列に分解する"><span class="header-section-number">2.3</span> 文字列を配列に分解する</a></li>
  <li><a href="#日付やタイムスタンプを扱う" id="toc-日付やタイムスタンプを扱う" class="nav-link" data-scroll-target="#日付やタイムスタンプを扱う"><span class="header-section-number">2.4</span> 日付やタイムスタンプを扱う</a>
  <ul class="collapse">
  <li><a href="#文字列の日付や時刻データを変換する" id="toc-文字列の日付や時刻データを変換する" class="nav-link" data-scroll-target="#文字列の日付や時刻データを変換する"><span class="header-section-number">2.4.1</span> 文字列の日付や時刻データを変換する</a></li>
  <li><a href="#日付時刻から特定のフィールドを取り出す" id="toc-日付時刻から特定のフィールドを取り出す" class="nav-link" data-scroll-target="#日付時刻から特定のフィールドを取り出す"><span class="header-section-number">2.4.2</span> 日付/時刻から特定のフィールドを取り出す</a></li>
  </ul></li>
  <li><a href="#欠損値をデフォルト値に置き換える" id="toc-欠損値をデフォルト値に置き換える" class="nav-link" data-scroll-target="#欠損値をデフォルト値に置き換える"><span class="header-section-number">2.5</span> 欠損値をデフォルト値に置き換える</a></li>
  </ul></li>
  <li><a href="#複数の値に対する操作" id="toc-複数の値に対する操作" class="nav-link" data-scroll-target="#複数の値に対する操作"><span class="header-section-number">3</span> 複数の値に対する操作</a>
  <ul class="collapse">
  <li><a href="#文字列を連結する" id="toc-文字列を連結する" class="nav-link" data-scroll-target="#文字列を連結する"><span class="header-section-number">3.1</span> 文字列を連結する</a></li>
  <li><a href="#複数の値を比較する" id="toc-複数の値を比較する" class="nav-link" data-scroll-target="#複数の値を比較する"><span class="header-section-number">3.2</span> 複数の値を比較する</a>
  <ul class="collapse">
  <li><a href="#年間の最大値をを見つける" id="toc-年間の最大値をを見つける" class="nav-link" data-scroll-target="#年間の最大値をを見つける"><span class="header-section-number">3.2.1</span> 年間の最大値をを見つける</a></li>
  <li><a href="#年間の平均四半期売上を計算する" id="toc-年間の平均四半期売上を計算する" class="nav-link" data-scroll-target="#年間の平均四半期売上を計算する"><span class="header-section-number">3.2.2</span> 年間の平均四半期売上を計算する</a></li>
  </ul></li>
  <li><a href="#つの値の比率を計算する" id="toc-つの値の比率を計算する" class="nav-link" data-scroll-target="#つの値の比率を計算する"><span class="header-section-number">3.3</span> 2つの値の比率を計算する</a>
  <ul class="collapse">
  <li><a href="#整数型のデータの除算" id="toc-整数型のデータの除算" class="nav-link" data-scroll-target="#整数型のデータの除算"><span class="header-section-number">3.3.1</span> 整数型のデータの除算</a></li>
  <li><a href="#除算を避ける" id="toc-除算を避ける" class="nav-link" data-scroll-target="#除算を避ける"><span class="header-section-number">3.3.2</span> 0除算を避ける</a></li>
  </ul></li>
  <li><a href="#つの値の距離を計算する" id="toc-つの値の距離を計算する" class="nav-link" data-scroll-target="#つの値の距離を計算する"><span class="header-section-number">3.4</span> 2つの値の距離を計算する</a>
  <ul class="collapse">
  <li><a href="#rms" id="toc-rms" class="nav-link" data-scroll-target="#rms"><span class="header-section-number">3.4.1</span> RMS</a></li>
  <li><a href="#xy平面上で2点間のユークリッド距離を計算する" id="toc-xy平面上で2点間のユークリッド距離を計算する" class="nav-link" data-scroll-target="#xy平面上で2点間のユークリッド距離を計算する"><span class="header-section-number">3.4.2</span> xy平面上で2点間のユークリッド距離を計算する</a></li>
  <li><a href="#arrayやlistを持ちいた距離" id="toc-arrayやlistを持ちいた距離" class="nav-link" data-scroll-target="#arrayやlistを持ちいた距離"><span class="header-section-number">3.4.3</span> arrayやlistを持ちいた距離</a></li>
  </ul></li>
  <li><a href="#日付時刻を計算する" id="toc-日付時刻を計算する" class="nav-link" data-scroll-target="#日付時刻を計算する"><span class="header-section-number">3.5</span> 日付・時刻を計算する</a>
  <ul class="collapse">
  <li><a href="#日付時刻データと定数の足し算引き算" id="toc-日付時刻データと定数の足し算引き算" class="nav-link" data-scroll-target="#日付時刻データと定数の足し算引き算"><span class="header-section-number">3.5.1</span> 日付・時刻データと定数の足し算・引き算</a></li>
  <li><a href="#日付データ同士の差分を計算する" id="toc-日付データ同士の差分を計算する" class="nav-link" data-scroll-target="#日付データ同士の差分を計算する"><span class="header-section-number">3.5.2</span> 日付データ同士の差分を計算する</a></li>
  <li><a href="#ユーザーの生年月日から年齢を計算する" id="toc-ユーザーの生年月日から年齢を計算する" class="nav-link" data-scroll-target="#ユーザーの生年月日から年齢を計算する"><span class="header-section-number">3.5.3</span> ユーザーの生年月日から年齢を計算する</a></li>
  </ul></li>
  <li><a href="#ipアドレスを扱う" id="toc-ipアドレスを扱う" class="nav-link" data-scroll-target="#ipアドレスを扱う"><span class="header-section-number">3.6</span> IPアドレスを扱う</a>
  <ul class="collapse">
  <li><a href="#整数値や文字列としてipアドレスを扱う" id="toc-整数値や文字列としてipアドレスを扱う" class="nav-link" data-scroll-target="#整数値や文字列としてipアドレスを扱う"><span class="header-section-number">3.6.1</span> 整数値や文字列としてIPアドレスを扱う</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#つのテーブルに対する操作" id="toc-つのテーブルに対する操作" class="nav-link" data-scroll-target="#つのテーブルに対する操作"><span class="header-section-number">4</span> 1つのテーブルに対する操作</a>
  <ul class="collapse">
  <li><a href="#グループの特徴を捉える" id="toc-グループの特徴を捉える" class="nav-link" data-scroll-target="#グループの特徴を捉える"><span class="header-section-number">4.1</span> グループの特徴を捉える。</a>
  <ul class="collapse">
  <li><a href="#テーブル全体の特徴量" id="toc-テーブル全体の特徴量" class="nav-link" data-scroll-target="#テーブル全体の特徴量"><span class="header-section-number">4.1.1</span> テーブル全体の特徴量</a></li>
  <li><a href="#グルーピングしたテーブル全体の特徴量" id="toc-グルーピングしたテーブル全体の特徴量" class="nav-link" data-scroll-target="#グルーピングしたテーブル全体の特徴量"><span class="header-section-number">4.1.2</span> グルーピングしたテーブル全体の特徴量</a></li>
  <li><a href="#集約関数を適用した値と集約前の値を同時に扱う" id="toc-集約関数を適用した値と集約前の値を同時に扱う" class="nav-link" data-scroll-target="#集約関数を適用した値と集約前の値を同時に扱う"><span class="header-section-number">4.1.3</span> 集約関数を適用した値と集約前の値を同時に扱う</a></li>
  </ul></li>
  <li><a href="#グループの中での順序を扱う" id="toc-グループの中での順序を扱う" class="nav-link" data-scroll-target="#グループの中での順序を扱う"><span class="header-section-number">4.2</span> グループの中での順序を扱う</a>
  <ul class="collapse">
  <li><a href="#order-byを使う" id="toc-order-byを使う" class="nav-link" data-scroll-target="#order-byを使う"><span class="header-section-number">4.2.1</span> ORDER BYを使う</a></li>
  <li><a href="#order-byと集約組み合わせる" id="toc-order-byと集約組み合わせる" class="nav-link" data-scroll-target="#order-byと集約組み合わせる"><span class="header-section-number">4.2.2</span> ORDER BYと集約組み合わせる</a></li>
  <li><a href="#partition-by-と-order-byを組み合わせる" id="toc-partition-by-と-order-byを組み合わせる" class="nav-link" data-scroll-target="#partition-by-と-order-byを組み合わせる"><span class="header-section-number">4.2.3</span> PARTITION BY と ORDER BYを組み合わせる</a></li>
  </ul></li>
  <li><a href="#縦持ちのデータを横持ちに変換する" id="toc-縦持ちのデータを横持ちに変換する" class="nav-link" data-scroll-target="#縦持ちのデータを横持ちに変換する"><span class="header-section-number">4.3</span> 縦持ちのデータを横持ちに変換する</a>
  <ul class="collapse">
  <li><a href="#行を区切りの文字列に集約する" id="toc-行を区切りの文字列に集約する" class="nav-link" data-scroll-target="#行を区切りの文字列に集約する"><span class="header-section-number">4.3.1</span> 行を区切りの文字列に集約する</a></li>
  </ul></li>
  <li><a href="#横持ちデータを縦持ちデータに変換する" id="toc-横持ちデータを縦持ちデータに変換する" class="nav-link" data-scroll-target="#横持ちデータを縦持ちデータに変換する"><span class="header-section-number">4.4</span> 横持ちデータを縦持ちデータに変換する</a>
  <ul class="collapse">
  <li><a href="#任意長の配列を行に展開する" id="toc-任意長の配列を行に展開する" class="nav-link" data-scroll-target="#任意長の配列を行に展開する"><span class="header-section-number">4.4.1</span> 任意長の配列を行に展開する</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#複数のテーブルに対する操作" id="toc-複数のテーブルに対する操作" class="nav-link" data-scroll-target="#複数のテーブルに対する操作"><span class="header-section-number">5</span> 複数のテーブルに対する操作</a>
  <ul class="collapse">
  <li><a href="#縦に並べる" id="toc-縦に並べる" class="nav-link" data-scroll-target="#縦に並べる"><span class="header-section-number">5.1</span> 縦に並べる</a></li>
  <li><a href="#複数のテーブルを横に並べる" id="toc-複数のテーブルを横に並べる" class="nav-link" data-scroll-target="#複数のテーブルを横に並べる"><span class="header-section-number">5.2</span> 複数のテーブルを横に並べる</a></li>
  <li><a href="#条件のフラグを0-1で表現する" id="toc-条件のフラグを0-1で表現する" class="nav-link" data-scroll-target="#条件のフラグを0-1で表現する"><span class="header-section-number">5.3</span> 条件のフラグを0, 1で表現する</a></li>
  <li><a href="#計算したテーブルに名前を付けて再利用する" id="toc-計算したテーブルに名前を付けて再利用する" class="nav-link" data-scroll-target="#計算したテーブルに名前を付けて再利用する"><span class="header-section-number">5.4</span> 計算したテーブルに名前を付けて再利用する</a></li>
  <li><a href="#擬似的なテーブルを作成する" id="toc-擬似的なテーブルを作成する" class="nav-link" data-scroll-target="#擬似的なテーブルを作成する"><span class="header-section-number">5.5</span> 擬似的なテーブルを作成する</a>
  <ul class="collapse">
  <li><a href="#任意のレコードを持つ" id="toc-任意のレコードを持つ" class="nav-link" data-scroll-target="#任意のレコードを持つ"><span class="header-section-number">5.5.1</span> 任意のレコードを持つ</a></li>
  <li><a href="#連番を用いてテーブルを作成する" id="toc-連番を用いてテーブルを作成する" class="nav-link" data-scroll-target="#連番を用いてテーブルを作成する"><span class="header-section-number">5.5.2</span> 連番を用いてテーブルを作成する</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#disconnect" id="toc-disconnect" class="nav-link" data-scroll-target="#disconnect"><span class="header-section-number">6</span> Disconnect</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">DuckDB</li><li class="breadcrumb-item"><a href="../../../../contents/sql/duckdb/sql-bigdata/index.html">ビッグデータレシピ</a></li><li class="breadcrumb-item"><a href="../../../../contents/sql/duckdb/sql-bigdata/chap03_.html">データ加工のためのSQL</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">データ加工のためのSQL</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta column-body">

    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">March 31, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>renv<span class="sc">::</span><span class="fu">activate</span>(here<span class="sc">::</span><span class="fu">here</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a></span>
<span id="cb2-2"><a href="#cb2-2"></a>cur_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"contents/sql/duckdb/sql-bigdata"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="fu">library</span>(DBI)</span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="fu">library</span>(arrow)</span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="fu">library</span>(showtext)</span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="fu">library</span>(here)</span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="fu">showtext_auto</span>()</span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="fu">font_add_google</span>(<span class="st">"Noto Sans"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="setup" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Setup</h1>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>sqlfiles <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">here</span>(cur_dir, <span class="st">"sql/SQL_Recipe_sample-code_20170325/Chapter3"</span>), </span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="at">pattern =</span> <span class="st">"*.sql"</span>, </span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>)</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="cf">for</span> (sql <span class="cf">in</span> sqlfiles) {</span>
<span id="cb4-8"><a href="#cb4-8"></a>  x <span class="ot">&lt;-</span> <span class="fu">read_file</span>(sql)</span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">str_detect</span>(x, <span class="st">"-- 必要なテーブルはありません"</span>)) {</span>
<span id="cb4-10"><a href="#cb4-10"></a>    x <span class="ot">&lt;-</span> <span class="fu">str_remove</span>(x, <span class="st">"SET CLIENT_ENCODING = 'UTF8';"</span>)</span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="fu">dbExecute</span>(con, x)</span>
<span id="cb4-12"><a href="#cb4-12"></a>  }</span>
<span id="cb4-13"><a href="#cb4-13"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1"></a>INSTALL icu;</span>
<span id="cb5-2"><a href="#cb5-2"></a>LOAD icu;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1"></a>SHOW <span class="kw">ALL</span> <span class="kw">TABLES</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<colgroup>
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 14%">
<col style="width: 36%">
<col style="width: 28%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">database</th>
<th style="text-align: left;">schema</th>
<th style="text-align: left;">name</th>
<th style="text-align: left;">column_names</th>
<th style="text-align: left;">column_types</th>
<th style="text-align: left;">temporary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">access_log</td>
<td style="text-align: left;">stamp , referrer, url</td>
<td style="text-align: left;">VARCHAR, VARCHAR, VARCHAR</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">advertising_stats</td>
<td style="text-align: left;">dt , ad_id , impressions, clicks</td>
<td style="text-align: left;">VARCHAR, VARCHAR, INTEGER, INTEGER</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">app1_mst_users</td>
<td style="text-align: left;">user_id, name , email</td>
<td style="text-align: left;">VARCHAR, VARCHAR, VARCHAR</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">app2_mst_users</td>
<td style="text-align: left;">user_id, name , phone</td>
<td style="text-align: left;">VARCHAR, VARCHAR, VARCHAR</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">category_sales</td>
<td style="text-align: left;">category_id, sales</td>
<td style="text-align: left;">INTEGER, INTEGER</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">daily_kpi</td>
<td style="text-align: left;">dt , indicator, val</td>
<td style="text-align: left;">VARCHAR, VARCHAR, INTEGER</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">location_1d</td>
<td style="text-align: left;">x1, x2</td>
<td style="text-align: left;">INTEGER, INTEGER</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">location_2d</td>
<td style="text-align: left;">x1, y1, x2, y2</td>
<td style="text-align: left;">INTEGER, INTEGER, INTEGER, INTEGER</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="odd">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">mst_categories</td>
<td style="text-align: left;">category_id, name</td>
<td style="text-align: left;">INTEGER, VARCHAR</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: left;">memory</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">mst_user_location</td>
<td style="text-align: left;">user_id , pref_name, city_name</td>
<td style="text-align: left;">VARCHAR, VARCHAR, VARCHAR</td>
<td style="text-align: left;">FALSE</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="op">*</span> <span class="kw">FROM</span> duckdb_functions() <span class="kw">WHERE</span> function_name <span class="kw">LIKE</span> <span class="st">'generate_%'</span> <span class="kw">ORDER</span> <span class="kw">BY</span> function_name;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<colgroup>
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 22%">
<col style="width: 2%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 16%">
<col style="width: 2%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 6%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">database_name</th>
<th style="text-align: left;">database_oid</th>
<th style="text-align: left;">schema_name</th>
<th style="text-align: left;">function_name</th>
<th style="text-align: left;">function_type</th>
<th style="text-align: left;">description</th>
<th style="text-align: left;">comment</th>
<th style="text-align: left;">return_type</th>
<th style="text-align: left;">parameters</th>
<th style="text-align: left;">parameter_types</th>
<th style="text-align: left;">varargs</th>
<th style="text-align: left;">macro_definition</th>
<th style="text-align: left;">has_side_effects</th>
<th style="text-align: left;">internal</th>
<th style="text-align: right;">function_oid</th>
<th style="text-align: left;">example</th>
<th style="text-align: left;">stability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">scalar</td>
<td style="text-align: left;">Create a list of values between start and stop - the stop parameter is inclusive</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">BIGINT[]</td>
<td style="text-align: left;">start</td>
<td style="text-align: left;">BIGINT</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">648</td>
<td style="text-align: left;">generate_series(2, 5, 3)</td>
<td style="text-align: left;">CONSISTENT</td>
</tr>
<tr class="even">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">scalar</td>
<td style="text-align: left;">Create a list of values between start and stop - the stop parameter is inclusive</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">BIGINT[]</td>
<td style="text-align: left;">start, stop , step</td>
<td style="text-align: left;">BIGINT, BIGINT, BIGINT</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">648</td>
<td style="text-align: left;">generate_series(2, 5, 3)</td>
<td style="text-align: left;">CONSISTENT</td>
</tr>
<tr class="odd">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">table</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">col0</td>
<td style="text-align: left;">BIGINT</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">78</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">scalar</td>
<td style="text-align: left;">Create a list of values between start and stop - the stop parameter is inclusive</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">BIGINT[]</td>
<td style="text-align: left;">start, stop</td>
<td style="text-align: left;">BIGINT, BIGINT</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">648</td>
<td style="text-align: left;">generate_series(2, 5, 3)</td>
<td style="text-align: left;">CONSISTENT</td>
</tr>
<tr class="odd">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">table</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">col0, col1, col2</td>
<td style="text-align: left;">BIGINT, BIGINT, BIGINT</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">78</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">table</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">col0, col1</td>
<td style="text-align: left;">BIGINT, BIGINT</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">78</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">table</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">col0, col1, col2</td>
<td style="text-align: left;">TIMESTAMP WITH TIME ZONE, TIMESTAMP WITH TIME ZONE, INTERVAL</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">78</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">table</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">col0, col1, col2</td>
<td style="text-align: left;">TIMESTAMP, TIMESTAMP, INTERVAL</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">78</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">scalar</td>
<td style="text-align: left;">Create a list of values between start and stop - the stop parameter is inclusive</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TIMESTAMP[]</td>
<td style="text-align: left;">start, stop , step</td>
<td style="text-align: left;">TIMESTAMP, TIMESTAMP, INTERVAL</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">648</td>
<td style="text-align: left;">generate_series(2, 5, 3)</td>
<td style="text-align: left;">CONSISTENT</td>
</tr>
<tr class="even">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">generate_series</td>
<td style="text-align: left;">scalar</td>
<td style="text-align: left;">Create a list of values between start and stop - the stop parameter is inclusive</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TIMESTAMP WITH TIME ZONE[]</td>
<td style="text-align: left;">start, stop , step</td>
<td style="text-align: left;">TIMESTAMP WITH TIME ZONE, TIMESTAMP WITH TIME ZONE, INTERVAL</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">648</td>
<td style="text-align: left;">generate_series(2, 5, 3)</td>
<td style="text-align: left;">CONSISTENT</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="つの値に対する操作" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> 1つの値に対する操作</h1>
<section id="コード値をラベルに置き換える" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="コード値をラベルに置き換える"><span class="header-section-number">2.1</span> コード値をラベルに置き換える</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">SELECT</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  user_id</span>
<span id="cb8-3"><a href="#cb8-3"></a>  , <span class="cf">CASE</span> </span>
<span id="cb8-4"><a href="#cb8-4"></a>      <span class="cf">WHEN</span> register_device <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'PC'</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>      <span class="cf">WHEN</span> register_device <span class="op">=</span> <span class="dv">2</span> <span class="cf">THEN</span> <span class="st">'SP'</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>      <span class="cf">WHEN</span> register_device <span class="op">=</span> <span class="dv">3</span> <span class="cf">THEN</span> <span class="st">'アプリ'</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="cf">END</span> device_name</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">FROM</span> mst_users;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">device_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">PC</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">SP</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">アプリ</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="urlから要素を取り出す" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="urlから要素を取り出す"><span class="header-section-number">2.2</span> URLから要素を取り出す</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">SELECT</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="op">*</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="kw">FROM</span> access_log;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<colgroup>
<col style="width: 17%">
<col style="width: 46%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">stamp</th>
<th style="text-align: left;">referrer</th>
<th style="text-align: left;">url</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:00</td>
<td style="text-align: left;">http://www.other.com/path1/index.php?k1=v1&amp;k2=v2#Ref1</td>
<td style="text-align: left;">http://www.example.com/video/detail?id=001</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.other.net/path1/index.php?k1=v1&amp;k2=v2#Ref1</td>
<td style="text-align: left;">http://www.example.com/video#ref</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">https://www.other.com/</td>
<td style="text-align: left;">http://www.example.com/book/detail?id=002</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>正規表現を使うことが出来る。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">SELECT</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  stamp</span>
<span id="cb10-3"><a href="#cb10-3"></a>  , regexp_extract(referrer , <span class="st">'https?://([^/]*)'</span>) referrer_host</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="kw">FROM</span> access_log;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">stamp</th>
<th style="text-align: left;">referrer_host</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:00</td>
<td style="text-align: left;">http://www.other.com</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.other.net</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">https://www.other.com</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="urlからパスやクエリパラメータを取り出す" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="urlからパスやクエリパラメータを取り出す"><span class="header-section-number">2.2.1</span> URLからパスやクエリパラメータを取り出す</h3>
<p>インデックスで取り出す必要がある。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">SELECT</span> </span>
<span id="cb11-2"><a href="#cb11-2"></a>  stamp</span>
<span id="cb11-3"><a href="#cb11-3"></a>  , url</span>
<span id="cb11-4"><a href="#cb11-4"></a>  , regexp_extract(url, <span class="st">'//[^/]+(?P&lt;name&gt;[^?#]+)'</span>, <span class="dv">1</span>) path</span>
<span id="cb11-5"><a href="#cb11-5"></a>  , regexp_extract(url, <span class="st">'id=([^&amp;]*)'</span>, <span class="dv">1</span>) <span class="kw">id</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="kw">FROM</span> access_log;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<colgroup>
<col style="width: 24%">
<col style="width: 53%">
<col style="width: 17%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">stamp</th>
<th style="text-align: left;">url</th>
<th style="text-align: left;">path</th>
<th style="text-align: left;">id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:00</td>
<td style="text-align: left;">http://www.example.com/video/detail?id=001</td>
<td style="text-align: left;">/video/detail</td>
<td style="text-align: left;">001</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.example.com/video#ref</td>
<td style="text-align: left;">/video</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.example.com/book/detail?id=002</td>
<td style="text-align: left;">/book/detail</td>
<td style="text-align: left;">002</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="文字列を配列に分解する" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="文字列を配列に分解する"><span class="header-section-number">2.3</span> 文字列を配列に分解する</h2>
<p><code>regex_extract</code>でホストと以下の部分を取得して, <code>split_part</code>で分割をおこなう。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">SELECT</span> </span>
<span id="cb12-2"><a href="#cb12-2"></a>  stamp</span>
<span id="cb12-3"><a href="#cb12-3"></a>  , url</span>
<span id="cb12-4"><a href="#cb12-4"></a>  , regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>) <span class="kw">as</span> A</span>
<span id="cb12-5"><a href="#cb12-5"></a>  , split_part(regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>), <span class="st">'/'</span>, <span class="dv">2</span>) path1</span>
<span id="cb12-6"><a href="#cb12-6"></a>  , split_part(regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>), <span class="st">'/'</span>, <span class="dv">3</span>) path2</span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="kw">FROM</span> </span>
<span id="cb12-8"><a href="#cb12-8"></a>  access_log;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<colgroup>
<col style="width: 22%">
<col style="width: 47%">
<col style="width: 15%">
<col style="width: 6%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">stamp</th>
<th style="text-align: left;">url</th>
<th style="text-align: left;">A</th>
<th style="text-align: left;">path1</th>
<th style="text-align: left;">path2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:00</td>
<td style="text-align: left;">http://www.example.com/video/detail?id=001</td>
<td style="text-align: left;">/video/detail</td>
<td style="text-align: left;">video</td>
<td style="text-align: left;">detail</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.example.com/video#ref</td>
<td style="text-align: left;">/video</td>
<td style="text-align: left;">video</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.example.com/book/detail?id=002</td>
<td style="text-align: left;">/book/detail</td>
<td style="text-align: left;">book</td>
<td style="text-align: left;">detail</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>非効率に見えるので次でもいいと思う。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">WITH</span> path_extracted <span class="kw">AS</span> (</span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="kw">SELECT</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>    stamp,</span>
<span id="cb13-4"><a href="#cb13-4"></a>    url,</span>
<span id="cb13-5"><a href="#cb13-5"></a>    regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>) <span class="kw">AS</span> extracted_path</span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="kw">FROM</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>    access_log</span>
<span id="cb13-8"><a href="#cb13-8"></a>)</span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="kw">SELECT</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>  stamp,</span>
<span id="cb13-11"><a href="#cb13-11"></a>  url,</span>
<span id="cb13-12"><a href="#cb13-12"></a>  extracted_path <span class="kw">AS</span> A,</span>
<span id="cb13-13"><a href="#cb13-13"></a>  split_part(extracted_path, <span class="st">'/'</span>, <span class="dv">2</span>) <span class="kw">AS</span> path1,</span>
<span id="cb13-14"><a href="#cb13-14"></a>  split_part(extracted_path, <span class="st">'/'</span>, <span class="dv">3</span>) <span class="kw">AS</span> path2</span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="kw">FROM</span></span>
<span id="cb13-16"><a href="#cb13-16"></a>  path_extracted;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<colgroup>
<col style="width: 22%">
<col style="width: 47%">
<col style="width: 15%">
<col style="width: 6%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">stamp</th>
<th style="text-align: left;">url</th>
<th style="text-align: left;">A</th>
<th style="text-align: left;">path1</th>
<th style="text-align: left;">path2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:00</td>
<td style="text-align: left;">http://www.example.com/video/detail?id=001</td>
<td style="text-align: left;">/video/detail</td>
<td style="text-align: left;">video</td>
<td style="text-align: left;">detail</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.example.com/video#ref</td>
<td style="text-align: left;">/video</td>
<td style="text-align: left;">video</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">2016-08-26 12:02:01</td>
<td style="text-align: left;">http://www.example.com/book/detail?id=002</td>
<td style="text-align: left;">/book/detail</td>
<td style="text-align: left;">book</td>
<td style="text-align: left;">detail</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="日付やタイムスタンプを扱う" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="日付やタイムスタンプを扱う"><span class="header-section-number">2.4</span> 日付やタイムスタンプを扱う</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1"></a>INSTALL icu;</span>
<span id="cb14-2"><a href="#cb14-2"></a>LOAD icu;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>タイムゾーンの設定はAisa/TokyoだけどTodayなどを使うとUTCの時間が取得される。 現地の時間が欲しければローカルタイムを使うこと。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> duckdb_settings() <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">'TimeZone'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">value</th>
<th style="text-align: left;">description</th>
<th style="text-align: left;">input_type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">TimeZone</td>
<td style="text-align: left;">Asia/Tokyo</td>
<td style="text-align: left;">The current time zone</td>
<td style="text-align: left;">VARCHAR</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>タイムゾーンの変更をおこなう。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">SET</span> TimeZone<span class="op">=</span><span class="st">'Asia/Tokyo'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">SELECT</span> </span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">CURRENT_DATE</span> <span class="kw">as</span> dt</span>
<span id="cb17-3"><a href="#cb17-3"></a>  , <span class="fu">CURRENT_TIMESTAMP</span> <span class="kw">as</span> stamp</span>
<span id="cb17-4"><a href="#cb17-4"></a>  , <span class="fu">LOCALTIMESTAMP</span> <span class="kw">as</span> lstamp</span>
<span id="cb17-5"><a href="#cb17-5"></a>  , now() <span class="kw">as</span> now</span>
<span id="cb17-6"><a href="#cb17-6"></a>  , today() <span class="kw">as</span> tdy</span>
<span id="cb17-7"><a href="#cb17-7"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<colgroup>
<col style="width: 13%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">stamp</th>
<th style="text-align: left;">lstamp</th>
<th style="text-align: left;">now</th>
<th style="text-align: left;">tdy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2024-03-31</td>
<td style="text-align: left;">2024-03-31 06:33:39</td>
<td style="text-align: left;">2024-03-31 15:33:39</td>
<td style="text-align: left;">2024-03-31 06:33:39</td>
<td style="text-align: left;">2024-03-31</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="文字列の日付や時刻データを変換する" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="文字列の日付や時刻データを変換する"><span class="header-section-number">2.4.1</span> 文字列の日付や時刻データを変換する</h3>
<p><code>CAST</code>のなかの<code>As</code>は必要なことに注意する。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">SELECT</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>    <span class="co">-- ■ PostgreSQL, Hive, Redshift, BigQuery, SparkSQLのすべてで、</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>    <span class="co">--   「CAST(value AS type)」の形式が利用できる</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>    <span class="fu">CAST</span>(<span class="st">'2016-01-30'</span> <span class="kw">AS</span> <span class="dt">date</span>) <span class="kw">AS</span> dt</span>
<span id="cb18-5"><a href="#cb18-5"></a>  , <span class="fu">CAST</span>(<span class="st">'2016-01-30 12:00:00'</span> <span class="kw">AS</span> <span class="dt">timestamp</span>) <span class="kw">AS</span> stamp;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">stamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-01-30</td>
<td style="text-align: left;">2016-01-30 12:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">WITH</span> tmp <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>    <span class="co">-- ■ PostgreSQL, Hive, Redshift, BigQuery, SparkSQLのすべてで、</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="co">--   「CAST(value AS type)」の形式が利用できる</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>    strptime(<span class="st">'2016-01-30'</span>, <span class="st">'%Y-%m-%d'</span>) <span class="kw">AS</span> dt</span>
<span id="cb19-5"><a href="#cb19-5"></a>  , strptime(<span class="st">'2016-01-30 12:00:00'</span>, <span class="st">'%Y-%m-%d %H:%M:%S'</span>) <span class="kw">AS</span> stamp</span>
<span id="cb19-6"><a href="#cb19-6"></a>) </span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="kw">FROM</span> tmp;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">stamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-01-30</td>
<td style="text-align: left;">2016-01-30 12:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">WITH</span> tmp <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>    <span class="co">-- ■ PostgreSQL, Hive, Redshift, BigQuery, SparkSQLのすべてで、</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>    <span class="co">--   「CAST(value AS type)」の形式が利用できる</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>    <span class="st">'2016-01-30'</span>:<span class="ch">:date</span> <span class="kw">AS</span> dt</span>
<span id="cb20-5"><a href="#cb20-5"></a>  , <span class="st">'2016-01-30 12:00:00'</span>:<span class="ch">:timestamp</span> <span class="kw">AS</span> stamp</span>
<span id="cb20-6"><a href="#cb20-6"></a>) </span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="kw">FROM</span> tmp;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">stamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-01-30</td>
<td style="text-align: left;">2016-01-30 12:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="日付時刻から特定のフィールドを取り出す" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="日付時刻から特定のフィールドを取り出す"><span class="header-section-number">2.4.2</span> 日付/時刻から特定のフィールドを取り出す</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">SELECT</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>  stamp</span>
<span id="cb21-3"><a href="#cb21-3"></a>  , <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span>  <span class="kw">FROM</span> stamp) <span class="kw">AS</span> <span class="dt">year</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>  , <span class="fu">EXTRACT</span>(<span class="dt">MONTH</span> <span class="kw">FROM</span> stamp) <span class="kw">AS</span> <span class="dt">month</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>  , <span class="fu">EXTRACT</span>(<span class="dt">DAY</span>   <span class="kw">FROM</span> stamp) <span class="kw">AS</span> <span class="dt">day</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>  , <span class="fu">EXTRACT</span>(<span class="kw">HOUR</span>  <span class="kw">FROM</span> stamp) <span class="kw">AS</span> <span class="kw">hour</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="kw">FROM</span>  (<span class="kw">SELECT</span> <span class="fu">CAST</span>(<span class="st">'2016-01-30 12:00:00'</span> <span class="kw">AS</span> <span class="dt">timestamp</span>) <span class="kw">as</span> stamp) <span class="kw">AS</span> t ;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">stamp</th>
<th style="text-align: right;">year</th>
<th style="text-align: right;">month</th>
<th style="text-align: right;">day</th>
<th style="text-align: right;">hour</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2016-01-30 12:00:00</td>
<td style="text-align: right;">2016</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">12</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="欠損値をデフォルト値に置き換える" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="欠損値をデフォルト値に置き換える"><span class="header-section-number">2.5</span> 欠損値をデフォルト値に置き換える</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">SELECT</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>  purchase_id</span>
<span id="cb22-3"><a href="#cb22-3"></a>  , amount</span>
<span id="cb22-4"><a href="#cb22-4"></a>  , coupon</span>
<span id="cb22-5"><a href="#cb22-5"></a>  , amount <span class="op">-</span> coupon discount_amount1</span>
<span id="cb22-6"><a href="#cb22-6"></a>  , amount <span class="op">-</span> <span class="fu">COALESCE</span>(coupon, <span class="dv">0</span>) discount_amount2</span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="kw">FROM</span> </span>
<span id="cb22-8"><a href="#cb22-8"></a>  purchase_log_with_coupon</span>
<span id="cb22-9"><a href="#cb22-9"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">purchase_id</th>
<th style="text-align: right;">amount</th>
<th style="text-align: right;">coupon</th>
<th style="text-align: right;">discount_amount1</th>
<th style="text-align: right;">discount_amount2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">10001</td>
<td style="text-align: right;">3280</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">3280</td>
</tr>
<tr class="even">
<td style="text-align: left;">10002</td>
<td style="text-align: right;">4650</td>
<td style="text-align: right;">500</td>
<td style="text-align: right;">4150</td>
<td style="text-align: right;">4150</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10003</td>
<td style="text-align: right;">3870</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">3870</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="複数の値に対する操作" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> 複数の値に対する操作</h1>
<section id="文字列を連結する" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="文字列を連結する"><span class="header-section-number">3.1</span> 文字列を連結する</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">SELECT</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>  user_id</span>
<span id="cb23-3"><a href="#cb23-3"></a>  , <span class="fu">CONCAT</span>(pref_name, city_name) pref_city</span>
<span id="cb23-4"><a href="#cb23-4"></a>  , pref_name <span class="op">||</span> city_name pref_city2</span>
<span id="cb23-5"><a href="#cb23-5"></a>  , CONCAT_WS(<span class="st">'/'</span>, pref_name, city_name) pref_city3</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="kw">FROM</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>  mst_user_location</span>
<span id="cb23-8"><a href="#cb23-8"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">pref_city</th>
<th style="text-align: left;">pref_city2</th>
<th style="text-align: left;">pref_city3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">東京都千代田区</td>
<td style="text-align: left;">東京都千代田区</td>
<td style="text-align: left;">東京都/千代田区</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">東京都渋谷区</td>
<td style="text-align: left;">東京都渋谷区</td>
<td style="text-align: left;">東京都/渋谷区</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">千葉県八千代区</td>
<td style="text-align: left;">千葉県八千代区</td>
<td style="text-align: left;">千葉県/八千代区</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="複数の値を比較する" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="複数の値を比較する"><span class="header-section-number">3.2</span> 複数の値を比較する</h2>
<p>横持ちのデータを比較することを考える。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">SELECT</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="dt">year</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>  , q1</span>
<span id="cb24-4"><a href="#cb24-4"></a>  , q2</span>
<span id="cb24-5"><a href="#cb24-5"></a>  , <span class="cf">CASE</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>      <span class="cf">WHEN</span> q1 <span class="op">&lt;</span> q2 <span class="cf">THEN</span> <span class="st">'+'</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>      <span class="cf">WHEN</span> q1 <span class="op">=</span> q2 <span class="cf">THEN</span> <span class="st">' '</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>      <span class="cf">ELSE</span> <span class="st">'-'</span></span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="cf">END</span> judge_q1_q2</span>
<span id="cb24-10"><a href="#cb24-10"></a>  , q2<span class="op">-</span>q1 diff_q2_q1</span>
<span id="cb24-11"><a href="#cb24-11"></a>  , <span class="fu">SIGN</span>(q2<span class="op">-</span>q1) sign_q2_q1</span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="kw">FROM</span></span>
<span id="cb24-13"><a href="#cb24-13"></a>  quarterly_sales</span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>  <span class="dt">year</span></span>
<span id="cb24-16"><a href="#cb24-16"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">year</th>
<th style="text-align: right;">q1</th>
<th style="text-align: right;">q2</th>
<th style="text-align: left;">judge_q1_q2</th>
<th style="text-align: right;">diff_q2_q1</th>
<th style="text-align: right;">sign_q2_q1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2015</td>
<td style="text-align: right;">82000</td>
<td style="text-align: right;">83000</td>
<td style="text-align: left;">+</td>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016</td>
<td style="text-align: right;">85000</td>
<td style="text-align: right;">85000</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017</td>
<td style="text-align: right;">92000</td>
<td style="text-align: right;">81000</td>
<td style="text-align: left;">-</td>
<td style="text-align: right;">-11000</td>
<td style="text-align: right;">-1</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="年間の最大値をを見つける" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="年間の最大値をを見つける"><span class="header-section-number">3.2.1</span> 年間の最大値をを見つける</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">SELECT</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="dt">year</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  , <span class="fu">greatest</span>(q1, q2, q3, q4) greatest_sales</span>
<span id="cb25-4"><a href="#cb25-4"></a>  , <span class="fu">least</span>(q1, q2, q3, q4) least_sales</span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="kw">FROM</span></span>
<span id="cb25-6"><a href="#cb25-6"></a>  quarterly_sales</span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="dt">year</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">year</th>
<th style="text-align: right;">greatest_sales</th>
<th style="text-align: right;">least_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2015</td>
<td style="text-align: right;">83000</td>
<td style="text-align: right;">78000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016</td>
<td style="text-align: right;">85000</td>
<td style="text-align: right;">80000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017</td>
<td style="text-align: right;">92000</td>
<td style="text-align: right;">81000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="年間の平均四半期売上を計算する" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="年間の平均四半期売上を計算する"><span class="header-section-number">3.2.2</span> 年間の平均四半期売上を計算する</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">SELECT</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="dt">year</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>  , (q1 <span class="op">+</span> q2 <span class="op">+</span> q3 <span class="op">+</span> q4) <span class="op">/</span> <span class="dv">4</span> average</span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="kw">FROM</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>  quarterly_sales</span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>  <span class="dt">year</span></span>
<span id="cb26-8"><a href="#cb26-8"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">year</th>
<th style="text-align: right;">average</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2015</td>
<td style="text-align: right;">81500</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016</td>
<td style="text-align: right;">82750</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017</td>
<td style="text-align: right;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>これはだるいのだが・・・？縦持ちに変換できれば出来そうだけど。</p>
<p>次は行ごとにNULLでないカラムでの平均値を求める。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">SELECT</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="dt">year</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  , (<span class="fu">COALESCE</span>(q1, <span class="dv">0</span>) <span class="op">+</span> <span class="fu">COALESCE</span>(q2, <span class="dv">0</span>) <span class="op">+</span> <span class="fu">COALESCE</span>(q3, <span class="dv">0</span>) <span class="op">+</span> <span class="fu">COALESCE</span>(q4, <span class="dv">0</span>)) </span>
<span id="cb27-4"><a href="#cb27-4"></a>    <span class="op">/</span> (<span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q1, <span class="dv">0</span>)) <span class="op">+</span> <span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q2, <span class="dv">0</span>)) <span class="op">+</span> <span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q3, <span class="dv">0</span>)) <span class="op">+</span> <span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q4, <span class="dv">0</span>))) average</span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="kw">FROM</span></span>
<span id="cb27-6"><a href="#cb27-6"></a>  quarterly_sales</span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb27-8"><a href="#cb27-8"></a>  <span class="dt">year</span></span>
<span id="cb27-9"><a href="#cb27-9"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">year</th>
<th style="text-align: right;">average</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2015</td>
<td style="text-align: right;">81500</td>
</tr>
<tr class="even">
<td style="text-align: left;">2016</td>
<td style="text-align: right;">82750</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017</td>
<td style="text-align: right;">86500</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>duckdbだと<code>PIVOT</code>と<code>UNPIVOT</code>があるので簡単におこなうことができる。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1"></a>UNPIVOT quarterly_sales</span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="kw">ON</span> q1, q2, q3, q4</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="kw">INTO</span> </span>
<span id="cb28-4"><a href="#cb28-4"></a>  NAME quarter</span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="fu">VALUE</span> sales;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: right;">year</th>
<th style="text-align: left;">quarter</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">82000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">83000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q3</td>
<td style="text-align: right;">78000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q4</td>
<td style="text-align: right;">83000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">85000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">85000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q3</td>
<td style="text-align: right;">80000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q4</td>
<td style="text-align: right;">81000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2017</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">92000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2017</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">81000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>正規表現とかを使うことも可能である。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">SELECT</span> </span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="kw">COLUMNS</span>(<span class="op">*</span>)</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="kw">FROM</span> (</span>
<span id="cb29-4"><a href="#cb29-4"></a>  UNPIVOT quarterly_sales</span>
<span id="cb29-5"><a href="#cb29-5"></a>  <span class="kw">ON</span> <span class="kw">COLUMNS</span>(<span class="st">'^q\d'</span>)</span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="kw">INTO</span> </span>
<span id="cb29-7"><a href="#cb29-7"></a>    NAME quarter</span>
<span id="cb29-8"><a href="#cb29-8"></a>    <span class="fu">VALUE</span> sales</span>
<span id="cb29-9"><a href="#cb29-9"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: right;">year</th>
<th style="text-align: left;">quarter</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">82000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">83000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q3</td>
<td style="text-align: right;">78000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q4</td>
<td style="text-align: right;">83000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">85000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">85000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q3</td>
<td style="text-align: right;">80000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q4</td>
<td style="text-align: right;">81000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2017</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">92000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2017</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">81000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="つの値の比率を計算する" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="つの値の比率を計算する"><span class="header-section-number">3.3</span> 2つの値の比率を計算する</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> advertising_stats;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>6 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">ad_id</th>
<th style="text-align: right;">impressions</th>
<th style="text-align: right;">clicks</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">001</td>
<td style="text-align: right;">100000</td>
<td style="text-align: right;">3000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">002</td>
<td style="text-align: right;">120000</td>
<td style="text-align: right;">1200</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">003</td>
<td style="text-align: right;">500000</td>
<td style="text-align: right;">10000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-04-02</td>
<td style="text-align: left;">001</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-04-02</td>
<td style="text-align: left;">002</td>
<td style="text-align: right;">130000</td>
<td style="text-align: right;">1400</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-04-02</td>
<td style="text-align: left;">003</td>
<td style="text-align: right;">620000</td>
<td style="text-align: right;">15000</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="整数型のデータの除算" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="整数型のデータの除算"><span class="header-section-number">3.3.1</span> 整数型のデータの除算</h3>
<p>CTR(Click Through Rate)を計算する。CTRの定義は「クリック数 / インプレッション数」である。 整数型同士の乗算は事前に実数型に変換しておく必要がある。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">SELECT</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>  dt</span>
<span id="cb31-3"><a href="#cb31-3"></a>  , ad_id</span>
<span id="cb31-4"><a href="#cb31-4"></a>  , clicks <span class="op">/</span> impressions ctr</span>
<span id="cb31-5"><a href="#cb31-5"></a>  , <span class="fl">100.</span> <span class="op">*</span> clicks <span class="op">/</span> impressions ctr_as_percent</span>
<span id="cb31-6"><a href="#cb31-6"></a>  , <span class="dv">100</span>  <span class="op">*</span> clicks <span class="op">/</span> impressions ctr_as_percent2</span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="kw">FROM</span></span>
<span id="cb31-8"><a href="#cb31-8"></a>  advertising_stats</span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="kw">WHERE</span></span>
<span id="cb31-10"><a href="#cb31-10"></a>  dt <span class="op">=</span> <span class="st">'2017-04-01'</span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb31-12"><a href="#cb31-12"></a>  dt, ad_id</span>
<span id="cb31-13"><a href="#cb31-13"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">ad_id</th>
<th style="text-align: right;">ctr</th>
<th style="text-align: right;">ctr_as_percent</th>
<th style="text-align: right;">ctr_as_percent2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">001</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">002</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">003</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="除算を避ける" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="除算を避ける"><span class="header-section-number">3.3.2</span> 0除算を避ける</h3>
<p>0除算を回避するにはCASE分を用いて分母の数が０かどうかを判定すること、 または、NULLを伝搬させることがある。<code>NULLIF(x, default)</code>は0のときに置き換える演算である。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">SELECT</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>  dt</span>
<span id="cb32-3"><a href="#cb32-3"></a>  , ad_id</span>
<span id="cb32-4"><a href="#cb32-4"></a>  , <span class="cf">CASE</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>      <span class="cf">WHEN</span> impressions <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="fl">100.</span> <span class="op">*</span> clicks <span class="op">/</span> impressions</span>
<span id="cb32-6"><a href="#cb32-6"></a>      <span class="cf">END</span> ctr_as_percent_by_case</span>
<span id="cb32-7"><a href="#cb32-7"></a>  , <span class="fl">100.</span> <span class="op">*</span> clicks <span class="op">/</span> <span class="fu">NULLIF</span>(impressions, <span class="dv">0</span>) ctr_as_percent_by_null</span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="kw">FROM</span> </span>
<span id="cb32-9"><a href="#cb32-9"></a>  advertising_stats</span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>  dt, ad_id</span>
<span id="cb32-12"><a href="#cb32-12"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>6 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">ad_id</th>
<th style="text-align: right;">ctr_as_percent_by_case</th>
<th style="text-align: right;">ctr_as_percent_by_null</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">001</td>
<td style="text-align: right;">3.000000</td>
<td style="text-align: right;">3.000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">002</td>
<td style="text-align: right;">1.000000</td>
<td style="text-align: right;">1.000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-04-01</td>
<td style="text-align: left;">003</td>
<td style="text-align: right;">2.000000</td>
<td style="text-align: right;">2.000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-04-02</td>
<td style="text-align: left;">001</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-04-02</td>
<td style="text-align: left;">002</td>
<td style="text-align: right;">1.076923</td>
<td style="text-align: right;">1.076923</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-04-02</td>
<td style="text-align: left;">003</td>
<td style="text-align: right;">2.419355</td>
<td style="text-align: right;">2.419355</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="つの値の距離を計算する" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="つの値の距離を計算する"><span class="header-section-number">3.4</span> 2つの値の距離を計算する</h2>
<section id="rms" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="rms"><span class="header-section-number">3.4.1</span> RMS</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw">SELECT</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="fu">abs</span>(x1<span class="op">-</span>x2) <span class="fu">abs</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>  , <span class="fu">sqrt</span>(<span class="fu">power</span>(x1<span class="op">-</span>x2, <span class="dv">2</span>)) rms</span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="kw">FROM</span> location_1d;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>5 records</caption>
<thead>
<tr class="header">
<th style="text-align: right;">abs</th>
<th style="text-align: right;">rms</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1"></a><span class="kw">SELECT</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>  x1</span>
<span id="cb34-3"><a href="#cb34-3"></a>  , <span class="fu">AVG</span>(x1) <span class="kw">OVER</span>()</span>
<span id="cb34-4"><a href="#cb34-4"></a>  , x1 <span class="op">-</span> <span class="fu">AVG</span>(x1) <span class="kw">over</span>()</span>
<span id="cb34-5"><a href="#cb34-5"></a>  , <span class="fu">POWER</span>(x1 <span class="op">-</span> <span class="fu">AVG</span>(x1) <span class="kw">over</span>(), <span class="dv">2</span>)</span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="kw">FROM</span> location_1d;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>5 records</caption>
<colgroup>
<col style="width: 4%">
<col style="width: 21%">
<col style="width: 30%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">x1</th>
<th style="text-align: right;">avg(x1) OVER ()</th>
<th style="text-align: right;">(x1 - avg(x1) OVER ())</th>
<th style="text-align: right;">power((x1 - avg(x1) OVER ()), 2)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">3.2</td>
<td style="text-align: right;">1.8</td>
<td style="text-align: right;">3.24</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">3.2</td>
<td style="text-align: right;">6.8</td>
<td style="text-align: right;">46.24</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-2</td>
<td style="text-align: right;">3.2</td>
<td style="text-align: right;">-5.2</td>
<td style="text-align: right;">27.04</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">3.2</td>
<td style="text-align: right;">-0.2</td>
<td style="text-align: right;">0.04</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">3.2</td>
<td style="text-align: right;">-3.2</td>
<td style="text-align: right;">10.24</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="xy平面上で2点間のユークリッド距離を計算する" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="xy平面上で2点間のユークリッド距離を計算する"><span class="header-section-number">3.4.2</span> xy平面上で2点間のユークリッド距離を計算する</h3>
<p>なし</p>
</section>
<section id="arrayやlistを持ちいた距離" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="arrayやlistを持ちいた距離"><span class="header-section-number">3.4.3</span> arrayやlistを持ちいた距離</h3>
<p>DBI経由だと計算できないが、コマンドラインからだと直接演算することが可能である。 どうやらarrayは0.10から追加されて、その後に</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb35-1"><a href="#cb35-1"></a>#| connection: con</span>
<span id="cb35-2"><a href="#cb35-2"></a></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> x;</span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> y;</span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> x (i <span class="dt">INT</span>, v <span class="dt">FLOAT</span>[<span class="dv">3</span>]);</span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> y (i <span class="dt">INT</span>, v <span class="dt">FLOAT</span>[<span class="dv">3</span>]);</span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> x <span class="kw">VALUES</span> (<span class="dv">1</span>, array_value(<span class="fl">1.0</span>:<span class="ch">:FLOAT</span>, <span class="fl">2.0</span>:<span class="ch">:FLOAT</span>, <span class="fl">3.0</span>:<span class="ch">:FLOAT</span>));</span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> y <span class="kw">VALUES</span> (<span class="dv">1</span>, array_value(<span class="fl">2.0</span>:<span class="ch">:FLOAT</span>, <span class="fl">3.0</span>:<span class="ch">:FLOAT</span>, <span class="fl">4.0</span>:<span class="ch">:FLOAT</span>));</span>
<span id="cb35-9"><a href="#cb35-9"></a><span class="co">-- compute cross product</span></span>
<span id="cb35-10"><a href="#cb35-10"></a><span class="kw">SELECT</span> array_cross_product(x.v, y.v)</span>
<span id="cb35-11"><a href="#cb35-11"></a><span class="kw">FROM</span> x, y</span>
<span id="cb35-12"><a href="#cb35-12"></a><span class="kw">WHERE</span> x.i <span class="op">=</span> y.i;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>リストは使えるのでリスで計算すればいいのかもしれない？？？</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb36-1"><a href="#cb36-1"></a><span class="kw">select</span> list_value(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">list_value(1, 2, 3)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1, 2, 3</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="日付時刻を計算する" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="日付時刻を計算する"><span class="header-section-number">3.5</span> 日付・時刻を計算する</h2>
<p>2つの日付・時刻データの差分を計算したり、１時間後の時刻を計算するなど、の手法をみる。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb37-1"><a href="#cb37-1"></a><span class="kw">SELECT</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="op">*</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="kw">FROM</span> mst_users_with_birthday;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">register_stamp</th>
<th style="text-align: left;">birth_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">2016-02-28 10:00:00</td>
<td style="text-align: left;">2000-02-29</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">2016-02-29 10:00:00</td>
<td style="text-align: left;">2000-02-29</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">2016-03-01 10:00:00</td>
<td style="text-align: left;">2000-02-29</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="日付時刻データと定数の足し算引き算" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="日付時刻データと定数の足し算引き算"><span class="header-section-number">3.5.1</span> 日付・時刻データと定数の足し算・引き算</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw">SELECT</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>  user_id</span>
<span id="cb38-3"><a href="#cb38-3"></a>  , register_stamp:<span class="ch">:timestamp</span> register_stamp</span>
<span id="cb38-4"><a href="#cb38-4"></a>  , register_stamp:<span class="ch">:timestamp</span> <span class="op">+</span> <span class="st">'1 hour'</span>:<span class="ch">:interval</span> after_1_hour</span>
<span id="cb38-5"><a href="#cb38-5"></a>  , register_stamp:<span class="ch">:timestamp</span> <span class="op">-</span> <span class="st">'30 minutes'</span>:<span class="ch">:interval</span> before_30_minutes</span>
<span id="cb38-6"><a href="#cb38-6"></a>  , register_stamp:<span class="ch">:date</span> register_date</span>
<span id="cb38-7"><a href="#cb38-7"></a>  , (register_stamp:<span class="ch">:date</span> <span class="op">+</span> <span class="st">'1 day'</span>:<span class="ch">:interval</span>):<span class="ch">:date</span> <span class="kw">AS</span> after_1_day</span>
<span id="cb38-8"><a href="#cb38-8"></a>  , (register_stamp:<span class="ch">:date</span> <span class="op">-</span> <span class="st">'1 month'</span>:<span class="ch">:interval</span>):<span class="ch">:date</span> <span class="kw">AS</span> before_1_month</span>
<span id="cb38-9"><a href="#cb38-9"></a>  , date_add(register_stamp:<span class="ch">:date</span>, <span class="st">'1 week'</span>:<span class="ch">:interval</span>) <span class="kw">as</span> after_1_week</span>
<span id="cb38-10"><a href="#cb38-10"></a>  , date_trunc(<span class="st">'month'</span>, register_stamp:<span class="ch">:date</span>) <span class="kw">as</span> trunc_month</span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="kw">FROM</span> mst_users_with_birthday;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<colgroup>
<col style="width: 5%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">register_stamp</th>
<th style="text-align: left;">after_1_hour</th>
<th style="text-align: left;">before_30_minutes</th>
<th style="text-align: left;">register_date</th>
<th style="text-align: left;">after_1_day</th>
<th style="text-align: left;">before_1_month</th>
<th style="text-align: left;">after_1_week</th>
<th style="text-align: left;">trunc_month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">2016-02-28 10:00:00</td>
<td style="text-align: left;">2016-02-28 11:00:00</td>
<td style="text-align: left;">2016-02-28 09:30:00</td>
<td style="text-align: left;">2016-02-28</td>
<td style="text-align: left;">2016-02-29</td>
<td style="text-align: left;">2016-01-28</td>
<td style="text-align: left;">2016-03-06</td>
<td style="text-align: left;">2016-02-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">2016-02-29 10:00:00</td>
<td style="text-align: left;">2016-02-29 11:00:00</td>
<td style="text-align: left;">2016-02-29 09:30:00</td>
<td style="text-align: left;">2016-02-29</td>
<td style="text-align: left;">2016-03-01</td>
<td style="text-align: left;">2016-01-29</td>
<td style="text-align: left;">2016-03-07</td>
<td style="text-align: left;">2016-02-01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">2016-03-01 10:00:00</td>
<td style="text-align: left;">2016-03-01 11:00:00</td>
<td style="text-align: left;">2016-03-01 09:30:00</td>
<td style="text-align: left;">2016-03-01</td>
<td style="text-align: left;">2016-03-02</td>
<td style="text-align: left;">2016-02-01</td>
<td style="text-align: left;">2016-03-08</td>
<td style="text-align: left;">2016-03-01</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="日付データ同士の差分を計算する" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="日付データ同士の差分を計算する"><span class="header-section-number">3.5.2</span> 日付データ同士の差分を計算する</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw">SELECT</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>  user_id</span>
<span id="cb39-3"><a href="#cb39-3"></a>  , <span class="fu">CURRENT_DATE</span> today</span>
<span id="cb39-4"><a href="#cb39-4"></a>  , register_stamp:<span class="ch">:date</span> register_date</span>
<span id="cb39-5"><a href="#cb39-5"></a>  , <span class="fu">CURRENT_DATE</span> <span class="op">-</span> register_stamp:<span class="ch">:date</span> diff_days</span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="kw">FROM</span> mst_users_with_birthday;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">today</th>
<th style="text-align: left;">register_date</th>
<th style="text-align: right;">diff_days</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">2024-03-31</td>
<td style="text-align: left;">2016-02-28</td>
<td style="text-align: right;">2954</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">2024-03-31</td>
<td style="text-align: left;">2016-02-29</td>
<td style="text-align: right;">2953</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">2024-03-31</td>
<td style="text-align: left;">2016-03-01</td>
<td style="text-align: right;">2952</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="ユーザーの生年月日から年齢を計算する" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="ユーザーの生年月日から年齢を計算する"><span class="header-section-number">3.5.3</span> ユーザーの生年月日から年齢を計算する</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb40-1"><a href="#cb40-1"></a><span class="kw">SELECT</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>  user_id</span>
<span id="cb40-3"><a href="#cb40-3"></a>  , <span class="fu">CURRENT_DATE</span> today</span>
<span id="cb40-4"><a href="#cb40-4"></a>  , register_stamp:<span class="ch">:date</span> register_date</span>
<span id="cb40-5"><a href="#cb40-5"></a>  , birth_date:<span class="ch">:date</span> birth_date</span>
<span id="cb40-6"><a href="#cb40-6"></a>  , age(birth_date:<span class="ch">:date</span>) age</span>
<span id="cb40-7"><a href="#cb40-7"></a>  , age(register_stamp:<span class="ch">:date</span>, birth_date:<span class="ch">:date</span>) age2</span>
<span id="cb40-8"><a href="#cb40-8"></a>  , <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> age(birth_date:<span class="ch">:date</span>)) current_age</span>
<span id="cb40-9"><a href="#cb40-9"></a>  , <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> age(register_stamp:<span class="ch">:date</span>, birth_date:<span class="ch">:date</span>)) register_age</span>
<span id="cb40-10"><a href="#cb40-10"></a><span class="kw">FROM</span> mst_users_with_birthday;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<colgroup>
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 11%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 12%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">today</th>
<th style="text-align: left;">register_date</th>
<th style="text-align: left;">birth_date</th>
<th style="text-align: left;">age</th>
<th style="text-align: left;">age2</th>
<th style="text-align: right;">current_age</th>
<th style="text-align: right;">register_age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">2024-03-31</td>
<td style="text-align: left;">2016-02-28</td>
<td style="text-align: left;">2000-02-29</td>
<td style="text-align: left;">749284420 secs</td>
<td style="text-align: left;">497491200 secs</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">2024-03-31</td>
<td style="text-align: left;">2016-02-29</td>
<td style="text-align: left;">2000-02-29</td>
<td style="text-align: left;">749284420 secs</td>
<td style="text-align: left;">497664000 secs</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">2024-03-31</td>
<td style="text-align: left;">2016-03-01</td>
<td style="text-align: left;">2000-02-29</td>
<td style="text-align: left;">749284420 secs</td>
<td style="text-align: left;">497750400 secs</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">16</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="ipアドレスを扱う" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="ipアドレスを扱う"><span class="header-section-number">3.6</span> IPアドレスを扱う</h2>
<p>duckdbには<code>inet</code>型はないみたいである。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb41-1"><a href="#cb41-1"></a>#| connection: con</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="kw">SELECT</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">CAST</span>(<span class="st">'172.16.4.46'</span> <span class="kw">as</span> inet) <span class="op">&lt;</span> <span class="fu">cast</span>(<span class="st">'172.17.49.127'</span> <span class="kw">as</span> inet ) <span class="kw">as</span> lt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="整数値や文字列としてipアドレスを扱う" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="整数値や文字列としてipアドレスを扱う"><span class="header-section-number">3.6.1</span> 整数値や文字列としてIPアドレスを扱う</h3>
<p>BIT型が存在しているらしいがここでは使うことができなかった。ｓｓ</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb42-1"><a href="#cb42-1"></a><span class="kw">SELECT</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>  ip</span>
<span id="cb42-3"><a href="#cb42-3"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">1</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_1</span>
<span id="cb42-4"><a href="#cb42-4"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">2</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_2</span>
<span id="cb42-5"><a href="#cb42-5"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">3</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_3</span>
<span id="cb42-6"><a href="#cb42-6"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">4</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_4</span>
<span id="cb42-7"><a href="#cb42-7"></a>  </span>
<span id="cb42-8"><a href="#cb42-8"></a>  <span class="co">-- ０パディング</span></span>
<span id="cb42-9"><a href="#cb42-9"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">1</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_1</span>
<span id="cb42-10"><a href="#cb42-10"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">2</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_2</span>
<span id="cb42-11"><a href="#cb42-11"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">3</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_3</span>
<span id="cb42-12"><a href="#cb42-12"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">4</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_4</span>
<span id="cb42-13"><a href="#cb42-13"></a>  </span>
<span id="cb42-14"><a href="#cb42-14"></a>  <span class="co">-- , CAST(split_part(ip, '.',  1) AS integer) bit_part_1</span></span>
<span id="cb42-15"><a href="#cb42-15"></a>  <span class="co">-- , CAST(split_part(ip, '.',  2) AS integer)::BIT bit_part_2</span></span>
<span id="cb42-16"><a href="#cb42-16"></a>  <span class="co">-- , CAST(split_part(ip, '.',  3) AS integer)::BIT bit_part_3</span></span>
<span id="cb42-17"><a href="#cb42-17"></a>  <span class="co">-- , CAST(split_part(ip, '.',  4) AS integer)::BIT bit_part_4</span></span>
<span id="cb42-18"><a href="#cb42-18"></a><span class="kw">FROM</span> (</span>
<span id="cb42-19"><a href="#cb42-19"></a>  <span class="kw">SELECT</span> <span class="st">'192.168.0.1'</span> <span class="kw">AS</span> ip</span>
<span id="cb42-20"><a href="#cb42-20"></a>) <span class="kw">as</span> t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<colgroup>
<col style="width: 17%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">ip</th>
<th style="text-align: right;">part_1</th>
<th style="text-align: right;">part_2</th>
<th style="text-align: right;">part_3</th>
<th style="text-align: right;">part_4</th>
<th style="text-align: left;">part_1</th>
<th style="text-align: left;">part_2</th>
<th style="text-align: left;">part_3</th>
<th style="text-align: left;">part_4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">192.168.0.1</td>
<td style="text-align: right;">192</td>
<td style="text-align: right;">168</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">192</td>
<td style="text-align: left;">168</td>
<td style="text-align: left;">000</td>
<td style="text-align: left;">001</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
<section id="つのテーブルに対する操作" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> 1つのテーブルに対する操作</h1>
<p><code>SQL:2003</code>から複数レコードにまたがるデータを同時に取り合うことができる。</p>
<section id="グループの特徴を捉える" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="グループの特徴を捉える"><span class="header-section-number">4.1</span> グループの特徴を捉える。</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> review;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>9 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="テーブル全体の特徴量" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="テーブル全体の特徴量"><span class="header-section-number">4.1.1</span> テーブル全体の特徴量</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">SELECT</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) total_count</span>
<span id="cb44-3"><a href="#cb44-3"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> user_id) user_count</span>
<span id="cb44-4"><a href="#cb44-4"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> product_id) product_count</span>
<span id="cb44-5"><a href="#cb44-5"></a>  , <span class="fu">SUM</span>(score) <span class="fu">sum</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>  , <span class="fu">AVG</span>(score) <span class="fu">avg</span></span>
<span id="cb44-7"><a href="#cb44-7"></a>  , <span class="fu">MIN</span>(score) <span class="fu">min</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>  , <span class="fu">MAX</span>(score) <span class="fu">max</span></span>
<span id="cb44-9"><a href="#cb44-9"></a>  , <span class="fu">LN</span>(<span class="fu">SUM</span>(<span class="fu">EXP</span>(score))) log_sum_exp</span>
<span id="cb44-10"><a href="#cb44-10"></a><span class="kw">FROM</span> </span>
<span id="cb44-11"><a href="#cb44-11"></a>  review</span>
<span id="cb44-12"><a href="#cb44-12"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<colgroup>
<col style="width: 17%">
<col style="width: 15%">
<col style="width: 20%">
<col style="width: 5%">
<col style="width: 12%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">total_count</th>
<th style="text-align: right;">user_count</th>
<th style="text-align: right;">product_count</th>
<th style="text-align: right;">sum</th>
<th style="text-align: right;">avg</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">log_sum_exp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">6.556499</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="グルーピングしたテーブル全体の特徴量" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="グルーピングしたテーブル全体の特徴量"><span class="header-section-number">4.1.2</span> グルーピングしたテーブル全体の特徴量</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb45-1"><a href="#cb45-1"></a><span class="kw">SELECT</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) total_count</span>
<span id="cb45-3"><a href="#cb45-3"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> user_id) user_count</span>
<span id="cb45-4"><a href="#cb45-4"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> product_id) product_count</span>
<span id="cb45-5"><a href="#cb45-5"></a>  , <span class="fu">SUM</span>(score) <span class="fu">sum</span></span>
<span id="cb45-6"><a href="#cb45-6"></a>  , <span class="fu">AVG</span>(score) <span class="fu">avg</span></span>
<span id="cb45-7"><a href="#cb45-7"></a>  , <span class="fu">MIN</span>(score) <span class="fu">min</span></span>
<span id="cb45-8"><a href="#cb45-8"></a>  , <span class="fu">MAX</span>(score) <span class="fu">max</span></span>
<span id="cb45-9"><a href="#cb45-9"></a>  , <span class="fu">LN</span>(<span class="fu">SUM</span>(<span class="fu">EXP</span>(score))) log_sum_exp</span>
<span id="cb45-10"><a href="#cb45-10"></a><span class="kw">FROM</span> </span>
<span id="cb45-11"><a href="#cb45-11"></a>  review</span>
<span id="cb45-12"><a href="#cb45-12"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb45-13"><a href="#cb45-13"></a>  user_id</span>
<span id="cb45-14"><a href="#cb45-14"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<colgroup>
<col style="width: 17%">
<col style="width: 15%">
<col style="width: 20%">
<col style="width: 5%">
<col style="width: 12%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">total_count</th>
<th style="text-align: right;">user_count</th>
<th style="text-align: right;">product_count</th>
<th style="text-align: right;">sum</th>
<th style="text-align: right;">avg</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">log_sum_exp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">3.333333</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4.551445</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">4.333333</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5.551445</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">4.666667</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5.861995</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="集約関数を適用した値と集約前の値を同時に扱う" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="集約関数を適用した値と集約前の値を同時に扱う"><span class="header-section-number">4.1.3</span> 集約関数を適用した値と集約前の値を同時に扱う</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb46-1"><a href="#cb46-1"></a><span class="kw">SELECT</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>  user_id</span>
<span id="cb46-3"><a href="#cb46-3"></a>  , product_id</span>
<span id="cb46-4"><a href="#cb46-4"></a>  , score</span>
<span id="cb46-5"><a href="#cb46-5"></a>  , <span class="fu">AVG</span>(score) <span class="kw">OVER</span>() avg_score</span>
<span id="cb46-6"><a href="#cb46-6"></a>  , <span class="fu">AVG</span>(score) <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> user_id) user_avg_score</span>
<span id="cb46-7"><a href="#cb46-7"></a>  , score <span class="op">-</span> <span class="fu">AVG</span>(score) <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> user_id) user_avg_score_diff</span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="kw">FROM</span> </span>
<span id="cb46-9"><a href="#cb46-9"></a>  review</span>
<span id="cb46-10"><a href="#cb46-10"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>9 records</caption>
<colgroup>
<col style="width: 11%">
<col style="width: 15%">
<col style="width: 8%">
<col style="width: 14%">
<col style="width: 21%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">score</th>
<th style="text-align: right;">avg_score</th>
<th style="text-align: right;">user_avg_score</th>
<th style="text-align: right;">user_avg_score_diff</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">3.333333</td>
<td style="text-align: right;">-0.3333333</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">3.333333</td>
<td style="text-align: right;">-0.3333333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">3.333333</td>
<td style="text-align: right;">0.6666667</td>
</tr>
<tr class="even">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">4.333333</td>
<td style="text-align: right;">0.6666667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">4.333333</td>
<td style="text-align: right;">-0.3333333</td>
</tr>
<tr class="even">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">4.333333</td>
<td style="text-align: right;">-0.3333333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">4.666667</td>
<td style="text-align: right;">-0.6666667</td>
</tr>
<tr class="even">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">4.666667</td>
<td style="text-align: right;">0.3333333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">4.111111</td>
<td style="text-align: right;">4.666667</td>
<td style="text-align: right;">0.3333333</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="グループの中での順序を扱う" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="グループの中での順序を扱う"><span class="header-section-number">4.2</span> グループの中での順序を扱う</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb47-1"><a href="#cb47-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> popular_products;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>8 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">product_id</th>
<th style="text-align: left;">category</th>
<th style="text-align: right;">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A001</td>
<td style="text-align: left;">action</td>
<td style="text-align: right;">94</td>
</tr>
<tr class="even">
<td style="text-align: left;">A002</td>
<td style="text-align: left;">action</td>
<td style="text-align: right;">81</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A003</td>
<td style="text-align: left;">action</td>
<td style="text-align: right;">78</td>
</tr>
<tr class="even">
<td style="text-align: left;">A004</td>
<td style="text-align: left;">action</td>
<td style="text-align: right;">64</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D001</td>
<td style="text-align: left;">drama</td>
<td style="text-align: right;">90</td>
</tr>
<tr class="even">
<td style="text-align: left;">D002</td>
<td style="text-align: left;">drama</td>
<td style="text-align: right;">82</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D003</td>
<td style="text-align: left;">drama</td>
<td style="text-align: right;">78</td>
</tr>
<tr class="even">
<td style="text-align: left;">D004</td>
<td style="text-align: left;">drama</td>
<td style="text-align: right;">58</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="order-byを使う" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="order-byを使う"><span class="header-section-number">4.2.1</span> ORDER BYを使う</h3>
<p>ウインドウ関数のなかで「ORDER BY」を使う。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb48-1"><a href="#cb48-1"></a><span class="kw">SELECT</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>  product_id</span>
<span id="cb48-3"><a href="#cb48-3"></a>  </span>
<span id="cb48-4"><a href="#cb48-4"></a>  , score</span>
<span id="cb48-5"><a href="#cb48-5"></a>  </span>
<span id="cb48-6"><a href="#cb48-6"></a>  , <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> <span class="kw">row</span></span>
<span id="cb48-7"><a href="#cb48-7"></a>  </span>
<span id="cb48-8"><a href="#cb48-8"></a>  , <span class="fu">RANK</span>() <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> <span class="fu">rank</span></span>
<span id="cb48-9"><a href="#cb48-9"></a>  </span>
<span id="cb48-10"><a href="#cb48-10"></a>  , <span class="fu">DENSE_RANK</span>() <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="fu">dense_rank</span></span>
<span id="cb48-11"><a href="#cb48-11"></a>  </span>
<span id="cb48-12"><a href="#cb48-12"></a>  , <span class="fu">LAG</span>(product_id) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lag1</span>
<span id="cb48-13"><a href="#cb48-13"></a>  </span>
<span id="cb48-14"><a href="#cb48-14"></a>  , <span class="fu">LAG</span>(product_id, <span class="dv">2</span>) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lag2</span>
<span id="cb48-15"><a href="#cb48-15"></a>  </span>
<span id="cb48-16"><a href="#cb48-16"></a>  , <span class="fu">LEAD</span>(product_id) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lead1</span>
<span id="cb48-17"><a href="#cb48-17"></a>  </span>
<span id="cb48-18"><a href="#cb48-18"></a>  , <span class="fu">LEAD</span>(product_id, <span class="dv">2</span>) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lead2</span>
<span id="cb48-19"><a href="#cb48-19"></a></span>
<span id="cb48-20"><a href="#cb48-20"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb48-21"><a href="#cb48-21"></a></span>
<span id="cb48-22"><a href="#cb48-22"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">row</span></span>
<span id="cb48-23"><a href="#cb48-23"></a></span>
<span id="cb48-24"><a href="#cb48-24"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>8 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">score</th>
<th style="text-align: right;">row</th>
<th style="text-align: right;">rank</th>
<th style="text-align: right;">dense_rank</th>
<th style="text-align: left;">lag1</th>
<th style="text-align: left;">lag2</th>
<th style="text-align: left;">lead1</th>
<th style="text-align: left;">lead2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A001</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">D001</td>
<td style="text-align: left;">D002</td>
</tr>
<tr class="even">
<td style="text-align: left;">D001</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">A001</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">D002</td>
<td style="text-align: left;">A002</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D002</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">D001</td>
<td style="text-align: left;">A001</td>
<td style="text-align: left;">A002</td>
<td style="text-align: left;">A003</td>
</tr>
<tr class="even">
<td style="text-align: left;">A002</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">D002</td>
<td style="text-align: left;">D001</td>
<td style="text-align: left;">A003</td>
<td style="text-align: left;">D003</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A003</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">A002</td>
<td style="text-align: left;">D002</td>
<td style="text-align: left;">D003</td>
<td style="text-align: left;">A004</td>
</tr>
<tr class="even">
<td style="text-align: left;">D003</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">A003</td>
<td style="text-align: left;">A002</td>
<td style="text-align: left;">A004</td>
<td style="text-align: left;">D004</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A004</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">D003</td>
<td style="text-align: left;">A003</td>
<td style="text-align: left;">D004</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">D004</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">7</td>
<td style="text-align: left;">A004</td>
<td style="text-align: left;">D003</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="order-byと集約組み合わせる" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="order-byと集約組み合わせる"><span class="header-section-number">4.2.2</span> ORDER BYと集約組み合わせる</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">SELECT</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>  product_id</span>
<span id="cb49-3"><a href="#cb49-3"></a>  </span>
<span id="cb49-4"><a href="#cb49-4"></a>  , score</span>
<span id="cb49-5"><a href="#cb49-5"></a>  </span>
<span id="cb49-6"><a href="#cb49-6"></a>  , <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> <span class="kw">row</span></span>
<span id="cb49-7"><a href="#cb49-7"></a>  </span>
<span id="cb49-8"><a href="#cb49-8"></a>  , <span class="fu">SUM</span>(score) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span></span>
<span id="cb49-9"><a href="#cb49-9"></a>                    <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">CURRENT</span> <span class="kw">ROW</span>) cum_score</span>
<span id="cb49-10"><a href="#cb49-10"></a>                    </span>
<span id="cb49-11"><a href="#cb49-11"></a>  , <span class="fu">AVG</span>(score) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span> </span>
<span id="cb49-12"><a href="#cb49-12"></a>                    <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="dv">1</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="dv">1</span> <span class="kw">FOLLOWING</span>) local_avg</span>
<span id="cb49-13"><a href="#cb49-13"></a>                    </span>
<span id="cb49-14"><a href="#cb49-14"></a>  <span class="co">-- ランキング上位の商品IDを取得する</span></span>
<span id="cb49-15"><a href="#cb49-15"></a>  , <span class="fu">FIRST_VALUE</span>(product_id) <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span></span>
<span id="cb49-16"><a href="#cb49-16"></a>                                 <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span>) <span class="kw">as</span> <span class="fu">first_value</span></span>
<span id="cb49-17"><a href="#cb49-17"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb49-18"><a href="#cb49-18"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">row</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>8 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">score</th>
<th style="text-align: right;">row</th>
<th style="text-align: right;">cum_score</th>
<th style="text-align: right;">local_avg</th>
<th style="text-align: left;">first_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A001</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">92.00000</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="even">
<td style="text-align: left;">D001</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">184</td>
<td style="text-align: right;">88.66667</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D002</td>
<td style="text-align: right;">82</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">266</td>
<td style="text-align: right;">84.33333</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="even">
<td style="text-align: left;">A002</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">347</td>
<td style="text-align: right;">80.33333</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A003</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">425</td>
<td style="text-align: right;">79.00000</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="even">
<td style="text-align: left;">D003</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">503</td>
<td style="text-align: right;">73.33333</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A004</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">567</td>
<td style="text-align: right;">66.66667</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="even">
<td style="text-align: left;">D004</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">625</td>
<td style="text-align: right;">61.00000</td>
<td style="text-align: left;">A001</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>商品の集約をおこなおうことも可能である</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1"></a><span class="kw">SELECT</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>  product_id</span>
<span id="cb50-3"><a href="#cb50-3"></a>  </span>
<span id="cb50-4"><a href="#cb50-4"></a>  , <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> <span class="kw">row</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>  </span>
<span id="cb50-6"><a href="#cb50-6"></a>  , <span class="kw">list</span>(product_id) </span>
<span id="cb50-7"><a href="#cb50-7"></a>      <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span> </span>
<span id="cb50-8"><a href="#cb50-8"></a>           <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span>) <span class="kw">list</span></span>
<span id="cb50-9"><a href="#cb50-9"></a>  </span>
<span id="cb50-10"><a href="#cb50-10"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb50-11"><a href="#cb50-11"></a><span class="kw">WHERE</span> <span class="kw">category</span> <span class="op">=</span> <span class="st">'action'</span></span>
<span id="cb50-12"><a href="#cb50-12"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">row</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>4 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">row</th>
<th style="text-align: left;">list</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A001</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">A001, A002, A003, A004</td>
</tr>
<tr class="even">
<td style="text-align: left;">A002</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">A001, A002, A003, A004</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A003</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">A001, A002, A003, A004</td>
</tr>
<tr class="even">
<td style="text-align: left;">A004</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">A001, A002, A003, A004</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>DuckdDBだと配列で距離を計算できる。version 0.10以降なのに注意する。</p>
</section>
<section id="partition-by-と-order-byを組み合わせる" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="partition-by-と-order-byを組み合わせる"><span class="header-section-number">4.2.3</span> PARTITION BY と ORDER BYを組み合わせる</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb51-1"><a href="#cb51-1"></a><span class="kw">SELECT</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>  <span class="kw">category</span></span>
<span id="cb51-3"><a href="#cb51-3"></a>  , product_id</span>
<span id="cb51-4"><a href="#cb51-4"></a>  , score</span>
<span id="cb51-5"><a href="#cb51-5"></a>  , <span class="fu">ROW_NUMBER</span>() </span>
<span id="cb51-6"><a href="#cb51-6"></a>    <span class="kw">OVER</span>(</span>
<span id="cb51-7"><a href="#cb51-7"></a>        <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">category</span></span>
<span id="cb51-8"><a href="#cb51-8"></a>        <span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> <span class="kw">row</span></span>
<span id="cb51-9"><a href="#cb51-9"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb51-10"><a href="#cb51-10"></a><span class="kw">WHERE</span> <span class="kw">category</span> <span class="op">=</span> <span class="st">'action'</span></span>
<span id="cb51-11"><a href="#cb51-11"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">row</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>4 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">category</th>
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">score</th>
<th style="text-align: right;">row</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">action</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">action</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">action</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">action</td>
<td style="text-align: left;">A004</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>カテゴリごとに最上位ランクの商品を取り出す。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb52-1"><a href="#cb52-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> </span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="kw">category</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>  , <span class="fu">FIRST_VALUE</span>(product_id)</span>
<span id="cb52-4"><a href="#cb52-4"></a>      <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">category</span> <span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>           <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span>)</span>
<span id="cb52-6"><a href="#cb52-6"></a>      product_id</span>
<span id="cb52-7"><a href="#cb52-7"></a><span class="kw">FROM</span> popular_products;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>2 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">category</th>
<th style="text-align: left;">product_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">drama</td>
<td style="text-align: left;">D001</td>
</tr>
<tr class="even">
<td style="text-align: left;">action</td>
<td style="text-align: left;">A001</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="縦持ちのデータを横持ちに変換する" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="縦持ちのデータを横持ちに変換する"><span class="header-section-number">4.3</span> 縦持ちのデータを横持ちに変換する</h2>
<p>duckdbは<code>PIVOT</code>を使えるので問題ない。他のSQLおこなう方法について示す。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb53-1"><a href="#cb53-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> daily_kpi;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>6 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: left;">indicator</th>
<th style="text-align: right;">val</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: left;">impressions</td>
<td style="text-align: right;">1800</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: left;">sessions</td>
<td style="text-align: right;">500</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: left;">users</td>
<td style="text-align: right;">200</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-01-02</td>
<td style="text-align: left;">impressions</td>
<td style="text-align: right;">2000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-01-02</td>
<td style="text-align: left;">sessions</td>
<td style="text-align: right;">700</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-01-02</td>
<td style="text-align: left;">users</td>
<td style="text-align: right;">250</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1"></a><span class="kw">SELECT</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>  dt</span>
<span id="cb54-3"><a href="#cb54-3"></a>  , <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="kw">indicator</span> <span class="op">=</span> <span class="st">'impressions'</span> <span class="cf">THEN</span> val <span class="cf">END</span>) impressions</span>
<span id="cb54-4"><a href="#cb54-4"></a>  , <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="kw">indicator</span> <span class="op">=</span> <span class="st">'sessions'</span> <span class="cf">THEN</span> val <span class="cf">END</span>) sessions</span>
<span id="cb54-5"><a href="#cb54-5"></a>  , <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="kw">indicator</span> <span class="op">=</span> <span class="st">'users'</span> <span class="cf">THEN</span> val <span class="cf">END</span>) users</span>
<span id="cb54-6"><a href="#cb54-6"></a><span class="kw">FROM</span> daily_kpi</span>
<span id="cb54-7"><a href="#cb54-7"></a><span class="kw">GROUP</span> <span class="kw">BY</span> dt</span>
<span id="cb54-8"><a href="#cb54-8"></a><span class="kw">ORDER</span> <span class="kw">BY</span> dt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>2 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">dt</th>
<th style="text-align: right;">impressions</th>
<th style="text-align: right;">sessions</th>
<th style="text-align: right;">users</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: right;">1800</td>
<td style="text-align: right;">500</td>
<td style="text-align: right;">200</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-01-02</td>
<td style="text-align: right;">2000</td>
<td style="text-align: right;">700</td>
<td style="text-align: right;">250</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="行を区切りの文字列に集約する" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="行を区切りの文字列に集約する"><span class="header-section-number">4.3.1</span> 行を区切りの文字列に集約する</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb55-1"><a href="#cb55-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> purchase_detail_log;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>6 records</caption>
<thead>
<tr class="header">
<th style="text-align: right;">purchase_id</th>
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">100001</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="even">
<td style="text-align: right;">100001</td>
<td style="text-align: left;">A002</td>
<td style="text-align: right;">400</td>
</tr>
<tr class="odd">
<td style="text-align: right;">100001</td>
<td style="text-align: left;">A003</td>
<td style="text-align: right;">200</td>
</tr>
<tr class="even">
<td style="text-align: right;">100002</td>
<td style="text-align: left;">D001</td>
<td style="text-align: right;">500</td>
</tr>
<tr class="odd">
<td style="text-align: right;">100002</td>
<td style="text-align: left;">D002</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="even">
<td style="text-align: right;">100003</td>
<td style="text-align: left;">A001</td>
<td style="text-align: right;">300</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1"></a><span class="kw">SELECT</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>  purchase_id</span>
<span id="cb56-3"><a href="#cb56-3"></a>  , string_agg(product_id, <span class="st">','</span>) prudct_ids</span>
<span id="cb56-4"><a href="#cb56-4"></a><span class="kw">FROM</span> purchase_detail_log</span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="kw">GROUP</span> <span class="kw">BY</span> purchase_id</span>
<span id="cb56-6"><a href="#cb56-6"></a><span class="kw">ORDER</span> <span class="kw">BY</span> purchase_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">purchase_id</th>
<th style="text-align: left;">prudct_ids</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">100001</td>
<td style="text-align: left;">A001,A002,A003</td>
</tr>
<tr class="even">
<td style="text-align: left;">100002</td>
<td style="text-align: left;">D001,D002</td>
</tr>
<tr class="odd">
<td style="text-align: left;">100003</td>
<td style="text-align: left;">A001</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb57-1"><a href="#cb57-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="op">*</span> <span class="kw">FROM</span> duckdb_functions() <span class="kw">WHERE</span> function_name <span class="kw">LIKE</span> <span class="st">'%nest'</span> <span class="kw">ORDER</span> <span class="kw">BY</span> function_name;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<colgroup>
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 3%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 3%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">database_name</th>
<th style="text-align: left;">database_oid</th>
<th style="text-align: left;">schema_name</th>
<th style="text-align: left;">function_name</th>
<th style="text-align: left;">function_type</th>
<th style="text-align: left;">description</th>
<th style="text-align: left;">comment</th>
<th style="text-align: left;">return_type</th>
<th style="text-align: left;">parameters</th>
<th style="text-align: left;">parameter_types</th>
<th style="text-align: left;">varargs</th>
<th style="text-align: left;">macro_definition</th>
<th style="text-align: left;">has_side_effects</th>
<th style="text-align: left;">internal</th>
<th style="text-align: right;">function_oid</th>
<th style="text-align: left;">example</th>
<th style="text-align: left;">stability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">system</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">main</td>
<td style="text-align: left;">unnest</td>
<td style="text-align: left;">table</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">col0</td>
<td style="text-align: left;">TABLE</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">84</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="横持ちデータを縦持ちデータに変換する" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="横持ちデータを縦持ちデータに変換する"><span class="header-section-number">4.4</span> 横持ちデータを縦持ちデータに変換する</h2>
<p>組合せを作成しておいて、1つ1つ設定することになる。</p>
<p>CROSS JOINをしているがつまりは直積集合であるのでFROM A, Bでも大丈夫ななず。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb58-1"><a href="#cb58-1"></a><span class="kw">select</span></span>
<span id="cb58-2"><a href="#cb58-2"></a>    q.<span class="dt">year</span></span>
<span id="cb58-3"><a href="#cb58-3"></a>    , <span class="cf">case</span></span>
<span id="cb58-4"><a href="#cb58-4"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span> <span class="st">'q1'</span></span>
<span id="cb58-5"><a href="#cb58-5"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span> <span class="st">'q2'</span></span>
<span id="cb58-6"><a href="#cb58-6"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">3</span> <span class="cf">then</span> <span class="st">'q3'</span></span>
<span id="cb58-7"><a href="#cb58-7"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">4</span> <span class="cf">then</span> <span class="st">'q4'</span></span>
<span id="cb58-8"><a href="#cb58-8"></a>    <span class="cf">end</span> <span class="kw">as</span> name</span>
<span id="cb58-9"><a href="#cb58-9"></a>    , <span class="cf">case</span></span>
<span id="cb58-10"><a href="#cb58-10"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span> q.q1</span>
<span id="cb58-11"><a href="#cb58-11"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span> q.q2</span>
<span id="cb58-12"><a href="#cb58-12"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">3</span> <span class="cf">then</span> q.q3</span>
<span id="cb58-13"><a href="#cb58-13"></a>        <span class="cf">when</span> p.idx <span class="op">=</span> <span class="dv">4</span> <span class="cf">then</span> q.q4</span>
<span id="cb58-14"><a href="#cb58-14"></a>    <span class="cf">end</span> <span class="kw">as</span> <span class="fu">value</span></span>
<span id="cb58-15"><a href="#cb58-15"></a><span class="kw">from</span></span>
<span id="cb58-16"><a href="#cb58-16"></a>    quarterly_sales <span class="kw">as</span> q</span>
<span id="cb58-17"><a href="#cb58-17"></a>    <span class="kw">cross</span> <span class="kw">join</span> (</span>
<span id="cb58-18"><a href="#cb58-18"></a>        <span class="kw">select</span> <span class="dv">1</span> <span class="kw">as</span> idx</span>
<span id="cb58-19"><a href="#cb58-19"></a>        <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> <span class="dv">2</span> idx</span>
<span id="cb58-20"><a href="#cb58-20"></a>        <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> <span class="dv">3</span> idx</span>
<span id="cb58-21"><a href="#cb58-21"></a>        <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> <span class="dv">4</span> idx</span>
<span id="cb58-22"><a href="#cb58-22"></a>    ) <span class="kw">as</span> p</span>
<span id="cb58-23"><a href="#cb58-23"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: right;">year</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">82000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">85000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2017</td>
<td style="text-align: left;">q1</td>
<td style="text-align: right;">92000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">83000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">85000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2017</td>
<td style="text-align: left;">q2</td>
<td style="text-align: right;">81000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q3</td>
<td style="text-align: right;">78000</td>
</tr>
<tr class="even">
<td style="text-align: right;">2016</td>
<td style="text-align: left;">q3</td>
<td style="text-align: right;">80000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2017</td>
<td style="text-align: left;">q3</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">2015</td>
<td style="text-align: left;">q4</td>
<td style="text-align: right;">83000</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="任意長の配列を行に展開する" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="任意長の配列を行に展開する"><span class="header-section-number">4.4.1</span> 任意長の配列を行に展開する</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb59-1"><a href="#cb59-1"></a><span class="kw">WITH</span> <span class="kw">NESTED</span> <span class="kw">AS</span> (</span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="kw">SELECT</span></span>
<span id="cb59-3"><a href="#cb59-3"></a>    purchase_id</span>
<span id="cb59-4"><a href="#cb59-4"></a>    , string_agg(product_id, <span class="st">','</span>) prudct_ids</span>
<span id="cb59-5"><a href="#cb59-5"></a>  <span class="kw">FROM</span> purchase_detail_log</span>
<span id="cb59-6"><a href="#cb59-6"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> purchase_id</span>
<span id="cb59-7"><a href="#cb59-7"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> purchase_id</span>
<span id="cb59-8"><a href="#cb59-8"></a>)</span>
<span id="cb59-9"><a href="#cb59-9"></a><span class="kw">SELECT</span></span>
<span id="cb59-10"><a href="#cb59-10"></a>  purchase_id</span>
<span id="cb59-11"><a href="#cb59-11"></a>  , UNNEST(string_split(prudct_ids, <span class="st">','</span>)) product_id</span>
<span id="cb59-12"><a href="#cb59-12"></a><span class="kw">FROM</span> <span class="kw">NESTED</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>6 records</caption>
<thead>
<tr class="header">
<th style="text-align: right;">purchase_id</th>
<th style="text-align: left;">product_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">100001</td>
<td style="text-align: left;">A001</td>
</tr>
<tr class="even">
<td style="text-align: right;">100001</td>
<td style="text-align: left;">A002</td>
</tr>
<tr class="odd">
<td style="text-align: right;">100001</td>
<td style="text-align: left;">A003</td>
</tr>
<tr class="even">
<td style="text-align: right;">100002</td>
<td style="text-align: left;">D001</td>
</tr>
<tr class="odd">
<td style="text-align: right;">100002</td>
<td style="text-align: left;">D002</td>
</tr>
<tr class="even">
<td style="text-align: right;">100003</td>
<td style="text-align: left;">A001</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
<section id="複数のテーブルに対する操作" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> 複数のテーブルに対する操作</h1>
<section id="縦に並べる" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="縦に並べる"><span class="header-section-number">5.1</span> 縦に並べる</h2>
<p><code>UNION</code>か<code>UNION ALL</code>句を使う。</p>
<p>結合するときには同じカラム構造にしておく必要がある。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1"></a><span class="kw">SELECT</span> <span class="st">'app1'</span> <span class="kw">AS</span> app_name, user_id, name, email <span class="kw">FROM</span> app1_mst_users</span>
<span id="cb60-2"><a href="#cb60-2"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb60-3"><a href="#cb60-3"></a><span class="kw">SELECT</span> <span class="st">'app2'</span> <span class="kw">AS</span> app_name, user_id, name, <span class="kw">NULL</span> <span class="kw">AS</span> email <span class="kw">FROM</span> app2_mst_users;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>4 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">app_name</th>
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">name</th>
<th style="text-align: left;">email</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">app1</td>
<td style="text-align: left;">U001</td>
<td style="text-align: left;">Sato</td>
<td style="text-align: left;">sato@example.com</td>
</tr>
<tr class="even">
<td style="text-align: left;">app1</td>
<td style="text-align: left;">U002</td>
<td style="text-align: left;">Suzuki</td>
<td style="text-align: left;">suzuki@example.com</td>
</tr>
<tr class="odd">
<td style="text-align: left;">app2</td>
<td style="text-align: left;">U001</td>
<td style="text-align: left;">Ito</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">app2</td>
<td style="text-align: left;">U002</td>
<td style="text-align: left;">Tanaka</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="複数のテーブルを横に並べる" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="複数のテーブルを横に並べる"><span class="header-section-number">5.2</span> 複数のテーブルを横に並べる</h2>
<p><code>JOIN</code>句を使う。一般に単に<code>JOIN</code>とした場合には<code>inner JOIN</code>がおこなわれる。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb61-1"><a href="#cb61-1"></a><span class="kw">SELECT</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>  m.category_id</span>
<span id="cb61-3"><a href="#cb61-3"></a>  , m.name</span>
<span id="cb61-4"><a href="#cb61-4"></a>  , s.sales</span>
<span id="cb61-5"><a href="#cb61-5"></a>  , r.product_id sales_product</span>
<span id="cb61-6"><a href="#cb61-6"></a><span class="kw">FROM</span></span>
<span id="cb61-7"><a href="#cb61-7"></a>  mst_categories <span class="kw">as</span> m</span>
<span id="cb61-8"><a href="#cb61-8"></a>  <span class="kw">JOIN</span></span>
<span id="cb61-9"><a href="#cb61-9"></a>    category_sales <span class="kw">as</span> s</span>
<span id="cb61-10"><a href="#cb61-10"></a>    <span class="kw">ON</span> m.category_id <span class="op">=</span> s.category_id</span>
<span id="cb61-11"><a href="#cb61-11"></a>  <span class="kw">JOIN</span></span>
<span id="cb61-12"><a href="#cb61-12"></a>    product_sale_ranking <span class="kw">as</span> r</span>
<span id="cb61-13"><a href="#cb61-13"></a>    <span class="kw">ON</span> m.category_id <span class="op">=</span> r.category_id</span>
<span id="cb61-14"><a href="#cb61-14"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>6 records</caption>
<thead>
<tr class="header">
<th style="text-align: right;">category_id</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">sales</th>
<th style="text-align: left;">sales_product</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">dvd</td>
<td style="text-align: right;">850000</td>
<td style="text-align: left;">D001</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">dvd</td>
<td style="text-align: right;">850000</td>
<td style="text-align: left;">D002</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">dvd</td>
<td style="text-align: right;">850000</td>
<td style="text-align: left;">D003</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">cd</td>
<td style="text-align: right;">500000</td>
<td style="text-align: left;">C001</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;">cd</td>
<td style="text-align: right;">500000</td>
<td style="text-align: left;">C002</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">cd</td>
<td style="text-align: right;">500000</td>
<td style="text-align: left;">C003</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><code>相関サブクエリ</code>が使える場合には、JOINをも居て複数のテーブルの値を横に並べることが可能である。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1"></a><span class="kw">SELECT</span></span>
<span id="cb62-2"><a href="#cb62-2"></a>  m.category_id</span>
<span id="cb62-3"><a href="#cb62-3"></a>  , m.name</span>
<span id="cb62-4"><a href="#cb62-4"></a>  <span class="co">---相関サブクエリを使いカテゴリー別の売上額を取得</span></span>
<span id="cb62-5"><a href="#cb62-5"></a>  , (<span class="kw">SELECT</span> s.sales <span class="kw">FROM</span> category_sales <span class="kw">as</span> s <span class="kw">WHERE</span> m.category_id <span class="op">=</span> s.category_id) sales</span>
<span id="cb62-6"><a href="#cb62-6"></a>  , (<span class="kw">SELECT</span> r.product_id <span class="kw">FROM</span> product_sale_ranking r <span class="kw">WHERE</span> m.category_id <span class="op">=</span> r.category_id</span>
<span id="cb62-7"><a href="#cb62-7"></a>     <span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">1</span>) top_sale_product</span>
<span id="cb62-8"><a href="#cb62-8"></a><span class="kw">FROM</span></span>
<span id="cb62-9"><a href="#cb62-9"></a>  mst_categories <span class="kw">as</span> m</span>
<span id="cb62-10"><a href="#cb62-10"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">category_id</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">sales</th>
<th style="text-align: left;">top_sale_product</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">dvd</td>
<td style="text-align: right;">850000</td>
<td style="text-align: left;">D001</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">cd</td>
<td style="text-align: right;">500000</td>
<td style="text-align: left;">C001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">book</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="条件のフラグを0-1で表現する" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="条件のフラグを0-1で表現する"><span class="header-section-number">5.3</span> 条件のフラグを0, 1で表現する</h2>
<p>CASE式で場合分けをするのが、SIGN関数で0と1に変換する方法がある。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb63-1"><a href="#cb63-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mst_users_with_card_number;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">card_number</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">1234-xxxx-xxxx-xxxx</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">5678-xxxx-xxxx-xxxx</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb64-1"><a href="#cb64-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> purchase_log;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>5 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">purchase_id</th>
<th style="text-align: left;">user_id</th>
<th style="text-align: right;">amount</th>
<th style="text-align: left;">stamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">10001</td>
<td style="text-align: left;">U001</td>
<td style="text-align: right;">200</td>
<td style="text-align: left;">2017-01-30 10:00:00</td>
</tr>
<tr class="even">
<td style="text-align: left;">10002</td>
<td style="text-align: left;">U001</td>
<td style="text-align: right;">500</td>
<td style="text-align: left;">2017-02-10 10:00:00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10003</td>
<td style="text-align: left;">U001</td>
<td style="text-align: right;">200</td>
<td style="text-align: left;">2017-02-12 10:00:00</td>
</tr>
<tr class="even">
<td style="text-align: left;">10004</td>
<td style="text-align: left;">U002</td>
<td style="text-align: right;">800</td>
<td style="text-align: left;">2017-03-01 10:00:00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10005</td>
<td style="text-align: left;">U002</td>
<td style="text-align: right;">400</td>
<td style="text-align: left;">2017-03-02 10:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb65-1"><a href="#cb65-1"></a><span class="kw">SELECT</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>  m.user_id</span>
<span id="cb65-3"><a href="#cb65-3"></a>  , m.card_number</span>
<span id="cb65-4"><a href="#cb65-4"></a>  , <span class="fu">COUNT</span>(p.user_id) <span class="kw">as</span> purchase_count</span>
<span id="cb65-5"><a href="#cb65-5"></a>  , <span class="cf">CASE</span> <span class="cf">WHEN</span> m.card_number <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span> <span class="kw">as</span> has_card</span>
<span id="cb65-6"><a href="#cb65-6"></a>  , <span class="fu">SIGN</span>(<span class="fu">COUNT</span>(p.user_id)) <span class="kw">as</span> has_purchased</span>
<span id="cb65-7"><a href="#cb65-7"></a><span class="kw">FROM</span> </span>
<span id="cb65-8"><a href="#cb65-8"></a>  mst_users_with_card_number <span class="kw">as</span> m</span>
<span id="cb65-9"><a href="#cb65-9"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb65-10"><a href="#cb65-10"></a>    purchase_log <span class="kw">as</span> p</span>
<span id="cb65-11"><a href="#cb65-11"></a>    <span class="kw">ON</span> m.user_id <span class="op">=</span> p.user_id</span>
<span id="cb65-12"><a href="#cb65-12"></a><span class="kw">GROUP</span> <span class="kw">BY</span> m.user_id, m.card_number</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">user_id</th>
<th style="text-align: left;">card_number</th>
<th style="text-align: right;">purchase_count</th>
<th style="text-align: right;">has_card</th>
<th style="text-align: right;">has_purchased</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">U003</td>
<td style="text-align: left;">5678-xxxx-xxxx-xxxx</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">U002</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">U001</td>
<td style="text-align: left;">1234-xxxx-xxxx-xxxx</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="計算したテーブルに名前を付けて再利用する" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="計算したテーブルに名前を付けて再利用する"><span class="header-section-number">5.4</span> 計算したテーブルに名前を付けて再利用する</h2>
<p>SQL99におけるCTE(Common Table Expression)を用いると１つのクエリの中で使える 一時的なテーブルに名前を付けて利用できるため、クエリの可読性が大きく向上する。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb66-1"><a href="#cb66-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_sales;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">category_name</th>
<th style="text-align: left;">product_id</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">dvd</td>
<td style="text-align: left;">D001</td>
<td style="text-align: right;">50000</td>
</tr>
<tr class="even">
<td style="text-align: left;">dvd</td>
<td style="text-align: left;">D002</td>
<td style="text-align: right;">20000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dvd</td>
<td style="text-align: left;">D003</td>
<td style="text-align: right;">10000</td>
</tr>
<tr class="even">
<td style="text-align: left;">cd</td>
<td style="text-align: left;">C001</td>
<td style="text-align: right;">30000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cd</td>
<td style="text-align: left;">C002</td>
<td style="text-align: right;">20000</td>
</tr>
<tr class="even">
<td style="text-align: left;">cd</td>
<td style="text-align: left;">C003</td>
<td style="text-align: right;">10000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">book</td>
<td style="text-align: left;">B001</td>
<td style="text-align: right;">20000</td>
</tr>
<tr class="even">
<td style="text-align: left;">book</td>
<td style="text-align: left;">B002</td>
<td style="text-align: right;">15000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">book</td>
<td style="text-align: left;">B003</td>
<td style="text-align: right;">10000</td>
</tr>
<tr class="even">
<td style="text-align: left;">book</td>
<td style="text-align: left;">B004</td>
<td style="text-align: right;">5000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>カテゴリーごとにランキングを付ける。そして、同じ順位の商品を横並びにする。</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb67-1"><a href="#cb67-1"></a><span class="kw">WITH</span></span>
<span id="cb67-2"><a href="#cb67-2"></a></span>
<span id="cb67-3"><a href="#cb67-3"></a>product_sale_ranking <span class="kw">as</span> (</span>
<span id="cb67-4"><a href="#cb67-4"></a>  <span class="kw">SELECT</span></span>
<span id="cb67-5"><a href="#cb67-5"></a>    category_name</span>
<span id="cb67-6"><a href="#cb67-6"></a>    , product_id</span>
<span id="cb67-7"><a href="#cb67-7"></a>    , sales</span>
<span id="cb67-8"><a href="#cb67-8"></a>    , <span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> category_name <span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span>) <span class="fu">rank</span></span>
<span id="cb67-9"><a href="#cb67-9"></a>  <span class="kw">FROM</span> </span>
<span id="cb67-10"><a href="#cb67-10"></a>    product_sales</span>
<span id="cb67-11"><a href="#cb67-11"></a>)</span>
<span id="cb67-12"><a href="#cb67-12"></a>, mst_rank <span class="kw">as</span> (</span>
<span id="cb67-13"><a href="#cb67-13"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="fu">rank</span></span>
<span id="cb67-14"><a href="#cb67-14"></a>  <span class="kw">FROM</span> product_sale_ranking</span>
<span id="cb67-15"><a href="#cb67-15"></a>)</span>
<span id="cb67-16"><a href="#cb67-16"></a><span class="kw">SELECT</span></span>
<span id="cb67-17"><a href="#cb67-17"></a>  m.<span class="fu">rank</span></span>
<span id="cb67-18"><a href="#cb67-18"></a>  , r1.product_id <span class="kw">as</span> dvd</span>
<span id="cb67-19"><a href="#cb67-19"></a>  , r1.sales <span class="kw">as</span> dvd_sales</span>
<span id="cb67-20"><a href="#cb67-20"></a>  , r2.product_id <span class="kw">as</span> cd</span>
<span id="cb67-21"><a href="#cb67-21"></a>  , r2.sales <span class="kw">as</span> cd_sales</span>
<span id="cb67-22"><a href="#cb67-22"></a>  , r3.product_id <span class="kw">as</span> book</span>
<span id="cb67-23"><a href="#cb67-23"></a>  , r3.sales <span class="kw">as</span> book_sales</span>
<span id="cb67-24"><a href="#cb67-24"></a><span class="kw">FROM</span></span>
<span id="cb67-25"><a href="#cb67-25"></a>  mst_rank <span class="kw">as</span> m</span>
<span id="cb67-26"><a href="#cb67-26"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb67-27"><a href="#cb67-27"></a>    product_sale_ranking r1</span>
<span id="cb67-28"><a href="#cb67-28"></a>    <span class="kw">on</span> m.<span class="fu">rank</span> <span class="op">=</span> r1.<span class="fu">rank</span></span>
<span id="cb67-29"><a href="#cb67-29"></a>    <span class="kw">AND</span> r1.category_name <span class="op">=</span> <span class="st">'dvd'</span></span>
<span id="cb67-30"><a href="#cb67-30"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb67-31"><a href="#cb67-31"></a>    product_sale_ranking r2</span>
<span id="cb67-32"><a href="#cb67-32"></a>    <span class="kw">ON</span> m.<span class="fu">rank</span> <span class="op">=</span> r2.<span class="fu">rank</span></span>
<span id="cb67-33"><a href="#cb67-33"></a>    <span class="kw">AND</span> r2.category_name <span class="op">=</span> <span class="st">'cd'</span></span>
<span id="cb67-34"><a href="#cb67-34"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb67-35"><a href="#cb67-35"></a>    product_sale_ranking <span class="kw">as</span> r3</span>
<span id="cb67-36"><a href="#cb67-36"></a>    <span class="kw">ON</span> m.<span class="fu">rank</span> <span class="op">=</span> r3.<span class="fu">rank</span></span>
<span id="cb67-37"><a href="#cb67-37"></a>    <span class="kw">AND</span> r3.category_name <span class="op">=</span> <span class="st">'book'</span></span>
<span id="cb67-38"><a href="#cb67-38"></a><span class="kw">ORDER</span> <span class="kw">BY</span> m.<span class="fu">rank</span></span>
<span id="cb67-39"><a href="#cb67-39"></a></span>
<span id="cb67-40"><a href="#cb67-40"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>4 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">rank</th>
<th style="text-align: left;">dvd</th>
<th style="text-align: right;">dvd_sales</th>
<th style="text-align: left;">cd</th>
<th style="text-align: right;">cd_sales</th>
<th style="text-align: left;">book</th>
<th style="text-align: right;">book_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">D001</td>
<td style="text-align: right;">50000</td>
<td style="text-align: left;">C001</td>
<td style="text-align: right;">30000</td>
<td style="text-align: left;">B001</td>
<td style="text-align: right;">20000</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">D002</td>
<td style="text-align: right;">20000</td>
<td style="text-align: left;">C002</td>
<td style="text-align: right;">20000</td>
<td style="text-align: left;">B002</td>
<td style="text-align: right;">15000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">D003</td>
<td style="text-align: right;">10000</td>
<td style="text-align: left;">C003</td>
<td style="text-align: right;">10000</td>
<td style="text-align: left;">B003</td>
<td style="text-align: right;">10000</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">B004</td>
<td style="text-align: right;">5000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="擬似的なテーブルを作成する" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="擬似的なテーブルを作成する"><span class="header-section-number">5.5</span> 擬似的なテーブルを作成する</h2>
<p>ダミーでテーブルを作成して、実際に集計を試す。</p>
<section id="任意のレコードを持つ" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="任意のレコードを持つ"><span class="header-section-number">5.5.1</span> 任意のレコードを持つ</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb68-1"><a href="#cb68-1"></a><span class="kw">WITH</span></span>
<span id="cb68-2"><a href="#cb68-2"></a>mst_devices <span class="kw">as</span> (</span>
<span id="cb68-3"><a href="#cb68-3"></a>            <span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">as</span> device_id, <span class="st">'pc'</span> <span class="kw">as</span> device_name</span>
<span id="cb68-4"><a href="#cb68-4"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">SELECT</span> <span class="dv">2</span> <span class="kw">as</span> device_id, <span class="st">'sp'</span> <span class="kw">as</span> device_name</span>
<span id="cb68-5"><a href="#cb68-5"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">SELECT</span> <span class="dv">3</span> <span class="kw">as</span> device_id, <span class="st">'アプリ'</span> <span class="kw">as</span> device_name</span>
<span id="cb68-6"><a href="#cb68-6"></a>)</span>
<span id="cb68-7"><a href="#cb68-7"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb68-8"><a href="#cb68-8"></a><span class="kw">FROM</span> mst_devices;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">device_id</th>
<th style="text-align: left;">device_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">pc</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: left;">sp</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">アプリ</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><code>VALUES</code>で作成することも可能である。 <code>vALUES</code>は<code>INSERT</code>とことなりまとめてロードが行える</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb69-1"><a href="#cb69-1"></a><span class="kw">WITH</span></span>
<span id="cb69-2"><a href="#cb69-2"></a>mst_devices(device_id, device_name) <span class="kw">AS</span>(</span>
<span id="cb69-3"><a href="#cb69-3"></a>  <span class="kw">VALUES</span></span>
<span id="cb69-4"><a href="#cb69-4"></a>    (<span class="dv">1</span>, <span class="st">'PC'</span>)</span>
<span id="cb69-5"><a href="#cb69-5"></a>)</span>
<span id="cb69-6"><a href="#cb69-6"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb69-7"><a href="#cb69-7"></a><span class="kw">FROM</span> mst_devices;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: right;">device_id</th>
<th style="text-align: left;">device_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">PC</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>配列型テーブル関数を用いた疑似テーブルの作成ができるミドルウェアもある。</p>
</section>
<section id="連番を用いてテーブルを作成する" class="level3" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="連番を用いてテーブルを作成する"><span class="header-section-number">5.5.2</span> 連番を用いてテーブルを作成する</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb70-1"><a href="#cb70-1"></a><span class="kw">WITH</span> </span>
<span id="cb70-2"><a href="#cb70-2"></a>series <span class="kw">as</span> (</span>
<span id="cb70-3"><a href="#cb70-3"></a>  <span class="kw">SELECT</span> unnest(generate_series(<span class="dv">1</span>, <span class="dv">5</span>)) idx</span>
<span id="cb70-4"><a href="#cb70-4"></a>)</span>
<span id="cb70-5"><a href="#cb70-5"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb70-6"><a href="#cb70-6"></a><span class="kw">FROM</span> series;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>5 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">idx</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
<section id="disconnect" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Disconnect</h1>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="fu">dbDisconnect</span>(con, <span class="at">shutdown=</span><span class="cn">TRUE</span>)</span>
<span id="cb71-2"><a href="#cb71-2"></a><span class="co">#&gt; Warning: Connection already closed.</span></span>
<span id="cb71-3"><a href="#cb71-3"></a><span class="co">#&gt; Warning in duckdb_shutdown(conn@driver): invalid driver object, already closed?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../../../contents/sql/duckdb/sql-bigdata/index.html" class="pagination-link" aria-label="はじめに">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">はじめに</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../../contents/sql/duckdb/sql-bigdata/chap04_.html" class="pagination-link" aria-label="売上を把握するためのデータ抽出">
        <span class="nav-page-text">売上を把握するためのデータ抽出</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb72" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb72-1"><a href="#cb72-1"></a><span class="co">---</span></span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="an">title:</span><span class="co"> "データ加工のためのSQL"</span></span>
<span id="cb72-3"><a href="#cb72-3"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb72-4"><a href="#cb72-4"></a><span class="co">  cache: true</span></span>
<span id="cb72-5"><a href="#cb72-5"></a><span class="an">date-modified:</span><span class="co"> last-modified</span></span>
<span id="cb72-6"><a href="#cb72-6"></a><span class="an">filters:</span></span>
<span id="cb72-7"><a href="#cb72-7"></a><span class="co">   - lightbox</span></span>
<span id="cb72-8"><a href="#cb72-8"></a><span class="an">lightbox:</span><span class="co"> auto</span></span>
<span id="cb72-9"><a href="#cb72-9"></a><span class="co">---</span></span>
<span id="cb72-10"><a href="#cb72-10"></a></span>
<span id="cb72-11"><a href="#cb72-11"></a></span>
<span id="cb72-14"><a href="#cb72-14"></a><span class="in">```{r}</span></span>
<span id="cb72-15"><a href="#cb72-15"></a>renv<span class="sc">::</span><span class="fu">activate</span>(here<span class="sc">::</span><span class="fu">here</span>())</span>
<span id="cb72-16"><a href="#cb72-16"></a><span class="in">```</span></span>
<span id="cb72-17"><a href="#cb72-17"></a></span>
<span id="cb72-18"><a href="#cb72-18"></a></span>
<span id="cb72-21"><a href="#cb72-21"></a><span class="in">```{r}</span></span>
<span id="cb72-22"><a href="#cb72-22"></a><span class="co">#| warning: false</span></span>
<span id="cb72-23"><a href="#cb72-23"></a><span class="co">#| message: false</span></span>
<span id="cb72-24"><a href="#cb72-24"></a></span>
<span id="cb72-25"><a href="#cb72-25"></a></span>
<span id="cb72-26"><a href="#cb72-26"></a>cur_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"contents/sql/duckdb/sql-bigdata"</span>)</span>
<span id="cb72-27"><a href="#cb72-27"></a></span>
<span id="cb72-28"><a href="#cb72-28"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb72-29"><a href="#cb72-29"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb72-30"><a href="#cb72-30"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb72-31"><a href="#cb72-31"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb72-32"><a href="#cb72-32"></a><span class="fu">library</span>(DBI)</span>
<span id="cb72-33"><a href="#cb72-33"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb72-34"><a href="#cb72-34"></a><span class="fu">library</span>(arrow)</span>
<span id="cb72-35"><a href="#cb72-35"></a><span class="fu">library</span>(showtext)</span>
<span id="cb72-36"><a href="#cb72-36"></a><span class="fu">library</span>(here)</span>
<span id="cb72-37"><a href="#cb72-37"></a><span class="fu">showtext_auto</span>()</span>
<span id="cb72-38"><a href="#cb72-38"></a><span class="fu">font_add_google</span>(<span class="st">"Noto Sans"</span>)</span>
<span id="cb72-39"><a href="#cb72-39"></a><span class="in">```</span></span>
<span id="cb72-40"><a href="#cb72-40"></a></span>
<span id="cb72-41"><a href="#cb72-41"></a><span class="fu"># Setup </span></span>
<span id="cb72-42"><a href="#cb72-42"></a></span>
<span id="cb72-45"><a href="#cb72-45"></a><span class="in">```{r}</span></span>
<span id="cb72-46"><a href="#cb72-46"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>())</span>
<span id="cb72-47"><a href="#cb72-47"></a><span class="in">```</span></span>
<span id="cb72-48"><a href="#cb72-48"></a></span>
<span id="cb72-51"><a href="#cb72-51"></a><span class="in">```{r}</span></span>
<span id="cb72-52"><a href="#cb72-52"></a>sqlfiles <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb72-53"><a href="#cb72-53"></a>  <span class="fu">here</span>(cur_dir, <span class="st">"sql/SQL_Recipe_sample-code_20170325/Chapter3"</span>), </span>
<span id="cb72-54"><a href="#cb72-54"></a>  <span class="at">pattern =</span> <span class="st">"*.sql"</span>, </span>
<span id="cb72-55"><a href="#cb72-55"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb72-56"><a href="#cb72-56"></a>)</span>
<span id="cb72-57"><a href="#cb72-57"></a></span>
<span id="cb72-58"><a href="#cb72-58"></a><span class="cf">for</span> (sql <span class="cf">in</span> sqlfiles) {</span>
<span id="cb72-59"><a href="#cb72-59"></a>  x <span class="ot">&lt;-</span> <span class="fu">read_file</span>(sql)</span>
<span id="cb72-60"><a href="#cb72-60"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">str_detect</span>(x, <span class="st">"-- 必要なテーブルはありません"</span>)) {</span>
<span id="cb72-61"><a href="#cb72-61"></a>    x <span class="ot">&lt;-</span> <span class="fu">str_remove</span>(x, <span class="st">"SET CLIENT_ENCODING = 'UTF8';"</span>)</span>
<span id="cb72-62"><a href="#cb72-62"></a>    <span class="fu">dbExecute</span>(con, x)</span>
<span id="cb72-63"><a href="#cb72-63"></a>  }</span>
<span id="cb72-64"><a href="#cb72-64"></a>}</span>
<span id="cb72-65"><a href="#cb72-65"></a><span class="in">```</span></span>
<span id="cb72-66"><a href="#cb72-66"></a></span>
<span id="cb72-69"><a href="#cb72-69"></a><span class="in">```{sql}</span></span>
<span id="cb72-70"><a href="#cb72-70"></a><span class="co">#| connection: con</span></span>
<span id="cb72-71"><a href="#cb72-71"></a>INSTALL icu;</span>
<span id="cb72-72"><a href="#cb72-72"></a><span class="kw">LOAD</span> icu;</span>
<span id="cb72-73"><a href="#cb72-73"></a><span class="in">```</span></span>
<span id="cb72-74"><a href="#cb72-74"></a></span>
<span id="cb72-75"><a href="#cb72-75"></a></span>
<span id="cb72-78"><a href="#cb72-78"></a><span class="in">```{sql}</span></span>
<span id="cb72-79"><a href="#cb72-79"></a><span class="co">#| connection: con</span></span>
<span id="cb72-80"><a href="#cb72-80"></a><span class="kw">SHOW</span> <span class="kw">ALL</span> <span class="kw">TABLES</span>;</span>
<span id="cb72-81"><a href="#cb72-81"></a><span class="in">```</span></span>
<span id="cb72-82"><a href="#cb72-82"></a></span>
<span id="cb72-83"><a href="#cb72-83"></a></span>
<span id="cb72-84"><a href="#cb72-84"></a></span>
<span id="cb72-87"><a href="#cb72-87"></a><span class="in">```{sql}</span></span>
<span id="cb72-88"><a href="#cb72-88"></a><span class="co">#| connection: con</span></span>
<span id="cb72-89"><a href="#cb72-89"></a></span>
<span id="cb72-90"><a href="#cb72-90"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="op">*</span> <span class="kw">FROM</span> duckdb_functions() <span class="kw">WHERE</span> function_name <span class="kw">LIKE</span> <span class="st">'generate_%'</span> <span class="kw">ORDER</span> <span class="kw">BY</span> function_name;</span>
<span id="cb72-91"><a href="#cb72-91"></a></span>
<span id="cb72-92"><a href="#cb72-92"></a><span class="in">```</span></span>
<span id="cb72-93"><a href="#cb72-93"></a></span>
<span id="cb72-94"><a href="#cb72-94"></a></span>
<span id="cb72-95"><a href="#cb72-95"></a></span>
<span id="cb72-96"><a href="#cb72-96"></a></span>
<span id="cb72-97"><a href="#cb72-97"></a><span class="fu"># 1つの値に対する操作</span></span>
<span id="cb72-98"><a href="#cb72-98"></a><span class="fu">## コード値をラベルに置き換える</span></span>
<span id="cb72-99"><a href="#cb72-99"></a></span>
<span id="cb72-100"><a href="#cb72-100"></a></span>
<span id="cb72-103"><a href="#cb72-103"></a><span class="in">```{sql}</span></span>
<span id="cb72-104"><a href="#cb72-104"></a><span class="co">#| connection: con</span></span>
<span id="cb72-105"><a href="#cb72-105"></a><span class="kw">SELECT</span></span>
<span id="cb72-106"><a href="#cb72-106"></a>  user_id</span>
<span id="cb72-107"><a href="#cb72-107"></a>  , <span class="cf">CASE</span> </span>
<span id="cb72-108"><a href="#cb72-108"></a>      <span class="cf">WHEN</span> register_device <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> <span class="st">'PC'</span></span>
<span id="cb72-109"><a href="#cb72-109"></a>      <span class="cf">WHEN</span> register_device <span class="op">=</span> <span class="dv">2</span> <span class="cf">THEN</span> <span class="st">'SP'</span></span>
<span id="cb72-110"><a href="#cb72-110"></a>      <span class="cf">WHEN</span> register_device <span class="op">=</span> <span class="dv">3</span> <span class="cf">THEN</span> <span class="st">'アプリ'</span></span>
<span id="cb72-111"><a href="#cb72-111"></a>    <span class="cf">END</span> device_name</span>
<span id="cb72-112"><a href="#cb72-112"></a><span class="kw">FROM</span> mst_users;</span>
<span id="cb72-113"><a href="#cb72-113"></a><span class="in">```</span></span>
<span id="cb72-114"><a href="#cb72-114"></a></span>
<span id="cb72-115"><a href="#cb72-115"></a><span class="fu">## URLから要素を取り出す</span></span>
<span id="cb72-116"><a href="#cb72-116"></a></span>
<span id="cb72-117"><a href="#cb72-117"></a></span>
<span id="cb72-120"><a href="#cb72-120"></a><span class="in">```{sql}</span></span>
<span id="cb72-121"><a href="#cb72-121"></a><span class="co">#| connection: con</span></span>
<span id="cb72-122"><a href="#cb72-122"></a><span class="kw">SELECT</span></span>
<span id="cb72-123"><a href="#cb72-123"></a>  <span class="op">*</span></span>
<span id="cb72-124"><a href="#cb72-124"></a><span class="kw">FROM</span> access_log;</span>
<span id="cb72-125"><a href="#cb72-125"></a><span class="in">```</span></span>
<span id="cb72-126"><a href="#cb72-126"></a></span>
<span id="cb72-127"><a href="#cb72-127"></a>正規表現を使うことが出来る。</span>
<span id="cb72-128"><a href="#cb72-128"></a></span>
<span id="cb72-131"><a href="#cb72-131"></a><span class="in">```{sql}</span></span>
<span id="cb72-132"><a href="#cb72-132"></a><span class="co">#| connection: con</span></span>
<span id="cb72-133"><a href="#cb72-133"></a><span class="kw">SELECT</span></span>
<span id="cb72-134"><a href="#cb72-134"></a>  stamp</span>
<span id="cb72-135"><a href="#cb72-135"></a>  , regexp_extract(referrer , <span class="st">'https?://([^/]*)'</span>) referrer_host</span>
<span id="cb72-136"><a href="#cb72-136"></a><span class="kw">FROM</span> access_log;</span>
<span id="cb72-137"><a href="#cb72-137"></a><span class="in">```</span></span>
<span id="cb72-138"><a href="#cb72-138"></a></span>
<span id="cb72-139"><a href="#cb72-139"></a><span class="fu">### URLからパスやクエリパラメータを取り出す</span></span>
<span id="cb72-140"><a href="#cb72-140"></a></span>
<span id="cb72-141"><a href="#cb72-141"></a>インデックスで取り出す必要がある。</span>
<span id="cb72-142"><a href="#cb72-142"></a></span>
<span id="cb72-145"><a href="#cb72-145"></a><span class="in">```{sql}</span></span>
<span id="cb72-146"><a href="#cb72-146"></a><span class="co">#| connection: con</span></span>
<span id="cb72-147"><a href="#cb72-147"></a><span class="kw">SELECT</span> </span>
<span id="cb72-148"><a href="#cb72-148"></a>  stamp</span>
<span id="cb72-149"><a href="#cb72-149"></a>  , url</span>
<span id="cb72-150"><a href="#cb72-150"></a>  , regexp_extract(url, <span class="st">'//[^/]+(?P&lt;name&gt;[^?#]+)'</span>, <span class="dv">1</span>) path</span>
<span id="cb72-151"><a href="#cb72-151"></a>  , regexp_extract(url, <span class="st">'id=([^</span><span class="ch">&amp;</span><span class="st">]*)'</span>, <span class="dv">1</span>) id</span>
<span id="cb72-152"><a href="#cb72-152"></a><span class="kw">FROM</span> access_log;</span>
<span id="cb72-153"><a href="#cb72-153"></a></span>
<span id="cb72-154"><a href="#cb72-154"></a><span class="in">```</span></span>
<span id="cb72-155"><a href="#cb72-155"></a></span>
<span id="cb72-156"><a href="#cb72-156"></a><span class="fu">## 文字列を配列に分解する</span></span>
<span id="cb72-157"><a href="#cb72-157"></a></span>
<span id="cb72-158"><a href="#cb72-158"></a><span class="in">`regex_extract`</span>でホストと以下の部分を取得して, <span class="in">`split_part`</span>で分割をおこなう。</span>
<span id="cb72-159"><a href="#cb72-159"></a></span>
<span id="cb72-162"><a href="#cb72-162"></a><span class="in">```{sql}</span></span>
<span id="cb72-163"><a href="#cb72-163"></a><span class="co">#| connection: con</span></span>
<span id="cb72-164"><a href="#cb72-164"></a><span class="kw">SELECT</span> </span>
<span id="cb72-165"><a href="#cb72-165"></a>  stamp</span>
<span id="cb72-166"><a href="#cb72-166"></a>  , url</span>
<span id="cb72-167"><a href="#cb72-167"></a>  , regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>) <span class="kw">as</span> A</span>
<span id="cb72-168"><a href="#cb72-168"></a>  , split_part(regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>), <span class="st">'/'</span>, <span class="dv">2</span>) path1</span>
<span id="cb72-169"><a href="#cb72-169"></a>  , split_part(regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>), <span class="st">'/'</span>, <span class="dv">3</span>) path2</span>
<span id="cb72-170"><a href="#cb72-170"></a><span class="kw">FROM</span> </span>
<span id="cb72-171"><a href="#cb72-171"></a>  access_log;</span>
<span id="cb72-172"><a href="#cb72-172"></a><span class="in">```</span></span>
<span id="cb72-173"><a href="#cb72-173"></a></span>
<span id="cb72-174"><a href="#cb72-174"></a>非効率に見えるので次でもいいと思う。</span>
<span id="cb72-175"><a href="#cb72-175"></a></span>
<span id="cb72-178"><a href="#cb72-178"></a><span class="in">```{sql}</span></span>
<span id="cb72-179"><a href="#cb72-179"></a><span class="co">#| connection: con</span></span>
<span id="cb72-180"><a href="#cb72-180"></a><span class="kw">WITH</span> path_extracted <span class="kw">AS</span> (</span>
<span id="cb72-181"><a href="#cb72-181"></a>  <span class="kw">SELECT</span></span>
<span id="cb72-182"><a href="#cb72-182"></a>    stamp,</span>
<span id="cb72-183"><a href="#cb72-183"></a>    url,</span>
<span id="cb72-184"><a href="#cb72-184"></a>    regexp_extract(url, <span class="st">'//[^/]+([^?#]+)'</span>, <span class="dv">1</span>) <span class="kw">AS</span> extracted_path</span>
<span id="cb72-185"><a href="#cb72-185"></a>  <span class="kw">FROM</span></span>
<span id="cb72-186"><a href="#cb72-186"></a>    access_log</span>
<span id="cb72-187"><a href="#cb72-187"></a>)</span>
<span id="cb72-188"><a href="#cb72-188"></a><span class="kw">SELECT</span></span>
<span id="cb72-189"><a href="#cb72-189"></a>  stamp,</span>
<span id="cb72-190"><a href="#cb72-190"></a>  url,</span>
<span id="cb72-191"><a href="#cb72-191"></a>  extracted_path <span class="kw">AS</span> A,</span>
<span id="cb72-192"><a href="#cb72-192"></a>  split_part(extracted_path, <span class="st">'/'</span>, <span class="dv">2</span>) <span class="kw">AS</span> path1,</span>
<span id="cb72-193"><a href="#cb72-193"></a>  split_part(extracted_path, <span class="st">'/'</span>, <span class="dv">3</span>) <span class="kw">AS</span> path2</span>
<span id="cb72-194"><a href="#cb72-194"></a><span class="kw">FROM</span></span>
<span id="cb72-195"><a href="#cb72-195"></a>  path_extracted;</span>
<span id="cb72-196"><a href="#cb72-196"></a><span class="in">```</span></span>
<span id="cb72-197"><a href="#cb72-197"></a></span>
<span id="cb72-198"><a href="#cb72-198"></a></span>
<span id="cb72-199"><a href="#cb72-199"></a><span class="fu">## 日付やタイムスタンプを扱う</span></span>
<span id="cb72-200"><a href="#cb72-200"></a></span>
<span id="cb72-201"><a href="#cb72-201"></a><span class="in">```sql</span></span>
<span id="cb72-202"><a href="#cb72-202"></a>INSTALL icu;</span>
<span id="cb72-203"><a href="#cb72-203"></a><span class="kw">LOAD</span> icu;</span>
<span id="cb72-204"><a href="#cb72-204"></a><span class="in">```</span></span>
<span id="cb72-205"><a href="#cb72-205"></a></span>
<span id="cb72-206"><a href="#cb72-206"></a>タイムゾーンの設定はAisa/TokyoだけどTodayなどを使うとUTCの時間が取得される。</span>
<span id="cb72-207"><a href="#cb72-207"></a>現地の時間が欲しければローカルタイムを使うこと。</span>
<span id="cb72-208"><a href="#cb72-208"></a></span>
<span id="cb72-211"><a href="#cb72-211"></a><span class="in">```{sql}</span></span>
<span id="cb72-212"><a href="#cb72-212"></a><span class="co">#| connection: con</span></span>
<span id="cb72-213"><a href="#cb72-213"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> duckdb_settings() <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">'TimeZone'</span>;</span>
<span id="cb72-214"><a href="#cb72-214"></a></span>
<span id="cb72-215"><a href="#cb72-215"></a><span class="in">```</span></span>
<span id="cb72-216"><a href="#cb72-216"></a></span>
<span id="cb72-217"><a href="#cb72-217"></a>タイムゾーンの変更をおこなう。</span>
<span id="cb72-218"><a href="#cb72-218"></a></span>
<span id="cb72-221"><a href="#cb72-221"></a><span class="in">```{sql}</span></span>
<span id="cb72-222"><a href="#cb72-222"></a><span class="co">#| connection: con</span></span>
<span id="cb72-223"><a href="#cb72-223"></a><span class="kw">SET</span> TimeZone<span class="op">=</span><span class="st">'Asia/Tokyo'</span>;</span>
<span id="cb72-224"><a href="#cb72-224"></a><span class="in">```</span></span>
<span id="cb72-225"><a href="#cb72-225"></a></span>
<span id="cb72-226"><a href="#cb72-226"></a></span>
<span id="cb72-229"><a href="#cb72-229"></a><span class="in">```{sql}</span></span>
<span id="cb72-230"><a href="#cb72-230"></a><span class="co">#| connection: con</span></span>
<span id="cb72-231"><a href="#cb72-231"></a><span class="kw">SELECT</span> </span>
<span id="cb72-232"><a href="#cb72-232"></a>  <span class="kw">CURRENT_DATE</span> <span class="kw">as</span> dt</span>
<span id="cb72-233"><a href="#cb72-233"></a>  , <span class="kw">CURRENT_TIMESTAMP</span> <span class="kw">as</span> stamp</span>
<span id="cb72-234"><a href="#cb72-234"></a>  , LOCALTIMESTAMP <span class="kw">as</span> lstamp</span>
<span id="cb72-235"><a href="#cb72-235"></a>  , <span class="fu">now</span>() <span class="kw">as</span> <span class="fu">now</span></span>
<span id="cb72-236"><a href="#cb72-236"></a>  , today() <span class="kw">as</span> tdy</span>
<span id="cb72-237"><a href="#cb72-237"></a>;</span>
<span id="cb72-238"><a href="#cb72-238"></a><span class="in">```</span></span>
<span id="cb72-239"><a href="#cb72-239"></a></span>
<span id="cb72-240"><a href="#cb72-240"></a></span>
<span id="cb72-241"><a href="#cb72-241"></a></span>
<span id="cb72-242"><a href="#cb72-242"></a></span>
<span id="cb72-243"><a href="#cb72-243"></a><span class="fu">### 文字列の日付や時刻データを変換する</span></span>
<span id="cb72-244"><a href="#cb72-244"></a></span>
<span id="cb72-245"><a href="#cb72-245"></a><span class="in">`CAST`</span>のなかの<span class="in">`As`</span>は必要なことに注意する。</span>
<span id="cb72-246"><a href="#cb72-246"></a></span>
<span id="cb72-249"><a href="#cb72-249"></a><span class="in">```{sql}</span></span>
<span id="cb72-250"><a href="#cb72-250"></a><span class="co">#| connection: con</span></span>
<span id="cb72-251"><a href="#cb72-251"></a><span class="kw">SELECT</span></span>
<span id="cb72-252"><a href="#cb72-252"></a>    <span class="co">-- ■ PostgreSQL, Hive, Redshift, BigQuery, SparkSQLのすべてで、</span></span>
<span id="cb72-253"><a href="#cb72-253"></a>    <span class="co">--   「CAST(value AS type)」の形式が利用できる</span></span>
<span id="cb72-254"><a href="#cb72-254"></a>    <span class="fu">CAST</span>(<span class="st">'2016-01-30'</span> <span class="kw">AS</span> <span class="dt">date</span>) <span class="kw">AS</span> dt</span>
<span id="cb72-255"><a href="#cb72-255"></a>  , <span class="fu">CAST</span>(<span class="st">'2016-01-30 12:00:00'</span> <span class="kw">AS</span> <span class="dt">timestamp</span>) <span class="kw">AS</span> stamp;</span>
<span id="cb72-256"><a href="#cb72-256"></a></span>
<span id="cb72-257"><a href="#cb72-257"></a><span class="in">```</span></span>
<span id="cb72-258"><a href="#cb72-258"></a></span>
<span id="cb72-261"><a href="#cb72-261"></a><span class="in">```{sql}</span></span>
<span id="cb72-262"><a href="#cb72-262"></a><span class="co">#| connection: con</span></span>
<span id="cb72-263"><a href="#cb72-263"></a><span class="kw">WITH</span> tmp <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb72-264"><a href="#cb72-264"></a>    <span class="co">-- ■ PostgreSQL, Hive, Redshift, BigQuery, SparkSQLのすべてで、</span></span>
<span id="cb72-265"><a href="#cb72-265"></a>    <span class="co">--   「CAST(value AS type)」の形式が利用できる</span></span>
<span id="cb72-266"><a href="#cb72-266"></a>    strptime(<span class="st">'2016-01-30'</span>, <span class="st">'%Y-%m-%d'</span>) <span class="kw">AS</span> dt</span>
<span id="cb72-267"><a href="#cb72-267"></a>  , strptime(<span class="st">'2016-01-30 12:00:00'</span>, <span class="st">'%Y-%m-%d %H:%M:%S'</span>) <span class="kw">AS</span> stamp</span>
<span id="cb72-268"><a href="#cb72-268"></a>) </span>
<span id="cb72-269"><a href="#cb72-269"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb72-270"><a href="#cb72-270"></a><span class="kw">FROM</span> tmp;</span>
<span id="cb72-271"><a href="#cb72-271"></a><span class="in">```</span></span>
<span id="cb72-272"><a href="#cb72-272"></a></span>
<span id="cb72-273"><a href="#cb72-273"></a></span>
<span id="cb72-276"><a href="#cb72-276"></a><span class="in">```{sql}</span></span>
<span id="cb72-277"><a href="#cb72-277"></a><span class="co">#| connection: con</span></span>
<span id="cb72-278"><a href="#cb72-278"></a><span class="kw">WITH</span> tmp <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb72-279"><a href="#cb72-279"></a>    <span class="co">-- ■ PostgreSQL, Hive, Redshift, BigQuery, SparkSQLのすべてで、</span></span>
<span id="cb72-280"><a href="#cb72-280"></a>    <span class="co">--   「CAST(value AS type)」の形式が利用できる</span></span>
<span id="cb72-281"><a href="#cb72-281"></a>    <span class="st">'2016-01-30'</span><span class="ch">::</span><span class="dt">date</span> <span class="kw">AS</span> dt</span>
<span id="cb72-282"><a href="#cb72-282"></a>  , <span class="st">'2016-01-30 12:00:00'</span><span class="ch">::</span><span class="dt">timestamp</span> <span class="kw">AS</span> stamp</span>
<span id="cb72-283"><a href="#cb72-283"></a>) </span>
<span id="cb72-284"><a href="#cb72-284"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb72-285"><a href="#cb72-285"></a><span class="kw">FROM</span> tmp;</span>
<span id="cb72-286"><a href="#cb72-286"></a></span>
<span id="cb72-287"><a href="#cb72-287"></a><span class="in">```</span></span>
<span id="cb72-288"><a href="#cb72-288"></a></span>
<span id="cb72-289"><a href="#cb72-289"></a><span class="fu">### 日付/時刻から特定のフィールドを取り出す</span></span>
<span id="cb72-290"><a href="#cb72-290"></a></span>
<span id="cb72-291"><a href="#cb72-291"></a></span>
<span id="cb72-294"><a href="#cb72-294"></a><span class="in">```{sql}</span></span>
<span id="cb72-295"><a href="#cb72-295"></a><span class="co">#| connection: con</span></span>
<span id="cb72-296"><a href="#cb72-296"></a><span class="kw">SELECT</span></span>
<span id="cb72-297"><a href="#cb72-297"></a>  stamp</span>
<span id="cb72-298"><a href="#cb72-298"></a>  , <span class="fu">EXTRACT</span>(<span class="fu">YEAR</span>  <span class="kw">FROM</span> stamp) <span class="kw">AS</span> <span class="fu">year</span></span>
<span id="cb72-299"><a href="#cb72-299"></a>  , <span class="fu">EXTRACT</span>(<span class="fu">MONTH</span> <span class="kw">FROM</span> stamp) <span class="kw">AS</span> <span class="fu">month</span></span>
<span id="cb72-300"><a href="#cb72-300"></a>  , <span class="fu">EXTRACT</span>(DAY   <span class="kw">FROM</span> stamp) <span class="kw">AS</span> day</span>
<span id="cb72-301"><a href="#cb72-301"></a>  , <span class="fu">EXTRACT</span>(<span class="fu">HOUR</span>  <span class="kw">FROM</span> stamp) <span class="kw">AS</span> <span class="fu">hour</span></span>
<span id="cb72-302"><a href="#cb72-302"></a><span class="kw">FROM</span>  (<span class="kw">SELECT</span> <span class="fu">CAST</span>(<span class="st">'2016-01-30 12:00:00'</span> <span class="kw">AS</span> <span class="dt">timestamp</span>) <span class="kw">as</span> stamp) <span class="kw">AS</span> t ;</span>
<span id="cb72-303"><a href="#cb72-303"></a><span class="in">```</span></span>
<span id="cb72-304"><a href="#cb72-304"></a></span>
<span id="cb72-305"><a href="#cb72-305"></a></span>
<span id="cb72-306"><a href="#cb72-306"></a><span class="fu">## 欠損値をデフォルト値に置き換える</span></span>
<span id="cb72-307"><a href="#cb72-307"></a></span>
<span id="cb72-310"><a href="#cb72-310"></a><span class="in">```{sql}</span></span>
<span id="cb72-311"><a href="#cb72-311"></a><span class="co">#| connection: con</span></span>
<span id="cb72-312"><a href="#cb72-312"></a><span class="kw">SELECT</span></span>
<span id="cb72-313"><a href="#cb72-313"></a>  purchase_id</span>
<span id="cb72-314"><a href="#cb72-314"></a>  , amount</span>
<span id="cb72-315"><a href="#cb72-315"></a>  , coupon</span>
<span id="cb72-316"><a href="#cb72-316"></a>  , amount <span class="op">-</span> coupon discount_amount1</span>
<span id="cb72-317"><a href="#cb72-317"></a>  , amount <span class="op">-</span> <span class="fu">COALESCE</span>(coupon, <span class="dv">0</span>) discount_amount2</span>
<span id="cb72-318"><a href="#cb72-318"></a><span class="kw">FROM</span> </span>
<span id="cb72-319"><a href="#cb72-319"></a>  purchase_log_with_coupon</span>
<span id="cb72-320"><a href="#cb72-320"></a>;</span>
<span id="cb72-321"><a href="#cb72-321"></a></span>
<span id="cb72-322"><a href="#cb72-322"></a></span>
<span id="cb72-323"><a href="#cb72-323"></a><span class="in">```</span></span>
<span id="cb72-324"><a href="#cb72-324"></a></span>
<span id="cb72-325"><a href="#cb72-325"></a></span>
<span id="cb72-326"><a href="#cb72-326"></a></span>
<span id="cb72-327"><a href="#cb72-327"></a></span>
<span id="cb72-328"><a href="#cb72-328"></a></span>
<span id="cb72-329"><a href="#cb72-329"></a></span>
<span id="cb72-330"><a href="#cb72-330"></a><span class="fu"># 複数の値に対する操作</span></span>
<span id="cb72-331"><a href="#cb72-331"></a></span>
<span id="cb72-332"><a href="#cb72-332"></a><span class="fu">## 文字列を連結する</span></span>
<span id="cb72-333"><a href="#cb72-333"></a></span>
<span id="cb72-334"><a href="#cb72-334"></a></span>
<span id="cb72-337"><a href="#cb72-337"></a><span class="in">```{sql}</span></span>
<span id="cb72-338"><a href="#cb72-338"></a><span class="co">#| connection: con</span></span>
<span id="cb72-339"><a href="#cb72-339"></a><span class="kw">SELECT</span></span>
<span id="cb72-340"><a href="#cb72-340"></a>  user_id</span>
<span id="cb72-341"><a href="#cb72-341"></a>  , <span class="fu">CONCAT</span>(pref_name, city_name) pref_city</span>
<span id="cb72-342"><a href="#cb72-342"></a>  , pref_name <span class="op">||</span> city_name pref_city2</span>
<span id="cb72-343"><a href="#cb72-343"></a>  , <span class="fu">CONCAT_WS</span>(<span class="st">'/'</span>, pref_name, city_name) pref_city3</span>
<span id="cb72-344"><a href="#cb72-344"></a><span class="kw">FROM</span></span>
<span id="cb72-345"><a href="#cb72-345"></a>  mst_user_location</span>
<span id="cb72-346"><a href="#cb72-346"></a>;</span>
<span id="cb72-347"><a href="#cb72-347"></a><span class="in">```</span></span>
<span id="cb72-348"><a href="#cb72-348"></a></span>
<span id="cb72-349"><a href="#cb72-349"></a></span>
<span id="cb72-350"><a href="#cb72-350"></a></span>
<span id="cb72-351"><a href="#cb72-351"></a></span>
<span id="cb72-352"><a href="#cb72-352"></a></span>
<span id="cb72-353"><a href="#cb72-353"></a></span>
<span id="cb72-354"><a href="#cb72-354"></a><span class="fu">## 複数の値を比較する</span></span>
<span id="cb72-355"><a href="#cb72-355"></a></span>
<span id="cb72-356"><a href="#cb72-356"></a>横持ちのデータを比較することを考える。</span>
<span id="cb72-357"><a href="#cb72-357"></a></span>
<span id="cb72-360"><a href="#cb72-360"></a><span class="in">```{sql}</span></span>
<span id="cb72-361"><a href="#cb72-361"></a><span class="co">#| connection: con</span></span>
<span id="cb72-362"><a href="#cb72-362"></a><span class="kw">SELECT</span></span>
<span id="cb72-363"><a href="#cb72-363"></a>  <span class="fu">year</span></span>
<span id="cb72-364"><a href="#cb72-364"></a>  , q1</span>
<span id="cb72-365"><a href="#cb72-365"></a>  , q2</span>
<span id="cb72-366"><a href="#cb72-366"></a>  , <span class="cf">CASE</span></span>
<span id="cb72-367"><a href="#cb72-367"></a>      <span class="cf">WHEN</span> q1 <span class="op">&lt;</span> q2 <span class="cf">THEN</span> <span class="st">'+'</span></span>
<span id="cb72-368"><a href="#cb72-368"></a>      <span class="cf">WHEN</span> q1 <span class="op">=</span> q2 <span class="cf">THEN</span> <span class="st">' '</span></span>
<span id="cb72-369"><a href="#cb72-369"></a>      <span class="cf">ELSE</span> <span class="st">'-'</span></span>
<span id="cb72-370"><a href="#cb72-370"></a>    <span class="cf">END</span> judge_q1_q2</span>
<span id="cb72-371"><a href="#cb72-371"></a>  , q2<span class="op">-</span>q1 diff_q2_q1</span>
<span id="cb72-372"><a href="#cb72-372"></a>  , <span class="fu">SIGN</span>(q2<span class="op">-</span>q1) sign_q2_q1</span>
<span id="cb72-373"><a href="#cb72-373"></a><span class="kw">FROM</span></span>
<span id="cb72-374"><a href="#cb72-374"></a>  quarterly_sales</span>
<span id="cb72-375"><a href="#cb72-375"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb72-376"><a href="#cb72-376"></a>  <span class="fu">year</span></span>
<span id="cb72-377"><a href="#cb72-377"></a>;</span>
<span id="cb72-378"><a href="#cb72-378"></a><span class="in">```</span></span>
<span id="cb72-379"><a href="#cb72-379"></a></span>
<span id="cb72-380"><a href="#cb72-380"></a></span>
<span id="cb72-381"><a href="#cb72-381"></a><span class="fu">### 年間の最大値をを見つける</span></span>
<span id="cb72-382"><a href="#cb72-382"></a></span>
<span id="cb72-383"><a href="#cb72-383"></a></span>
<span id="cb72-386"><a href="#cb72-386"></a><span class="in">```{sql}</span></span>
<span id="cb72-387"><a href="#cb72-387"></a><span class="co">#| connection: con</span></span>
<span id="cb72-388"><a href="#cb72-388"></a><span class="kw">SELECT</span></span>
<span id="cb72-389"><a href="#cb72-389"></a>  <span class="fu">year</span></span>
<span id="cb72-390"><a href="#cb72-390"></a>  , <span class="fu">greatest</span>(q1, q2, q3, q4) greatest_sales</span>
<span id="cb72-391"><a href="#cb72-391"></a>  , <span class="fu">least</span>(q1, q2, q3, q4) least_sales</span>
<span id="cb72-392"><a href="#cb72-392"></a><span class="kw">FROM</span></span>
<span id="cb72-393"><a href="#cb72-393"></a>  quarterly_sales</span>
<span id="cb72-394"><a href="#cb72-394"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb72-395"><a href="#cb72-395"></a>  <span class="fu">year</span></span>
<span id="cb72-396"><a href="#cb72-396"></a>;</span>
<span id="cb72-397"><a href="#cb72-397"></a></span>
<span id="cb72-398"><a href="#cb72-398"></a><span class="in">```</span></span>
<span id="cb72-399"><a href="#cb72-399"></a></span>
<span id="cb72-400"><a href="#cb72-400"></a><span class="fu">### 年間の平均四半期売上を計算する</span></span>
<span id="cb72-401"><a href="#cb72-401"></a></span>
<span id="cb72-404"><a href="#cb72-404"></a><span class="in">```{sql}</span></span>
<span id="cb72-405"><a href="#cb72-405"></a><span class="co">#| connection: con</span></span>
<span id="cb72-406"><a href="#cb72-406"></a><span class="kw">SELECT</span></span>
<span id="cb72-407"><a href="#cb72-407"></a>  <span class="fu">year</span></span>
<span id="cb72-408"><a href="#cb72-408"></a>  , (q1 <span class="op">+</span> q2 <span class="op">+</span> q3 <span class="op">+</span> q4) <span class="op">/</span> <span class="dv">4</span> average</span>
<span id="cb72-409"><a href="#cb72-409"></a><span class="kw">FROM</span></span>
<span id="cb72-410"><a href="#cb72-410"></a>  quarterly_sales</span>
<span id="cb72-411"><a href="#cb72-411"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb72-412"><a href="#cb72-412"></a>  <span class="fu">year</span></span>
<span id="cb72-413"><a href="#cb72-413"></a>;</span>
<span id="cb72-414"><a href="#cb72-414"></a></span>
<span id="cb72-415"><a href="#cb72-415"></a><span class="in">```</span></span>
<span id="cb72-416"><a href="#cb72-416"></a></span>
<span id="cb72-417"><a href="#cb72-417"></a></span>
<span id="cb72-418"><a href="#cb72-418"></a>これはだるいのだが・・・？縦持ちに変換できれば出来そうだけど。</span>
<span id="cb72-419"><a href="#cb72-419"></a></span>
<span id="cb72-420"><a href="#cb72-420"></a>次は行ごとにNULLでないカラムでの平均値を求める。</span>
<span id="cb72-421"><a href="#cb72-421"></a></span>
<span id="cb72-424"><a href="#cb72-424"></a><span class="in">```{sql}</span></span>
<span id="cb72-425"><a href="#cb72-425"></a><span class="co">#| connection: con</span></span>
<span id="cb72-426"><a href="#cb72-426"></a><span class="kw">SELECT</span></span>
<span id="cb72-427"><a href="#cb72-427"></a>  <span class="fu">year</span></span>
<span id="cb72-428"><a href="#cb72-428"></a>  , (<span class="fu">COALESCE</span>(q1, <span class="dv">0</span>) <span class="op">+</span> <span class="fu">COALESCE</span>(q2, <span class="dv">0</span>) <span class="op">+</span> <span class="fu">COALESCE</span>(q3, <span class="dv">0</span>) <span class="op">+</span> <span class="fu">COALESCE</span>(q4, <span class="dv">0</span>)) </span>
<span id="cb72-429"><a href="#cb72-429"></a>    <span class="op">/</span> (<span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q1, <span class="dv">0</span>)) <span class="op">+</span> <span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q2, <span class="dv">0</span>)) <span class="op">+</span> <span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q3, <span class="dv">0</span>)) <span class="op">+</span> <span class="fu">SIGN</span>(<span class="fu">COALESCE</span>(q4, <span class="dv">0</span>))) average</span>
<span id="cb72-430"><a href="#cb72-430"></a><span class="kw">FROM</span></span>
<span id="cb72-431"><a href="#cb72-431"></a>  quarterly_sales</span>
<span id="cb72-432"><a href="#cb72-432"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb72-433"><a href="#cb72-433"></a>  <span class="fu">year</span></span>
<span id="cb72-434"><a href="#cb72-434"></a>;</span>
<span id="cb72-435"><a href="#cb72-435"></a><span class="in">```</span></span>
<span id="cb72-436"><a href="#cb72-436"></a></span>
<span id="cb72-437"><a href="#cb72-437"></a>duckdbだと<span class="in">`PIVOT`</span>と<span class="in">`UNPIVOT`</span>があるので簡単におこなうことができる。</span>
<span id="cb72-438"><a href="#cb72-438"></a></span>
<span id="cb72-441"><a href="#cb72-441"></a><span class="in">```{sql}</span></span>
<span id="cb72-442"><a href="#cb72-442"></a><span class="co">#| connection: con</span></span>
<span id="cb72-443"><a href="#cb72-443"></a>UNPIVOT quarterly_sales</span>
<span id="cb72-444"><a href="#cb72-444"></a><span class="kw">ON</span> q1, q2, q3, q4</span>
<span id="cb72-445"><a href="#cb72-445"></a><span class="kw">INTO</span> </span>
<span id="cb72-446"><a href="#cb72-446"></a>  NAME <span class="fu">quarter</span></span>
<span id="cb72-447"><a href="#cb72-447"></a>  VALUE sales;</span>
<span id="cb72-448"><a href="#cb72-448"></a><span class="in">```</span></span>
<span id="cb72-449"><a href="#cb72-449"></a></span>
<span id="cb72-450"><a href="#cb72-450"></a>正規表現とかを使うことも可能である。</span>
<span id="cb72-451"><a href="#cb72-451"></a></span>
<span id="cb72-452"><a href="#cb72-452"></a></span>
<span id="cb72-453"><a href="#cb72-453"></a></span>
<span id="cb72-456"><a href="#cb72-456"></a><span class="in">```{sql}</span></span>
<span id="cb72-457"><a href="#cb72-457"></a><span class="co">#| connection: con</span></span>
<span id="cb72-458"><a href="#cb72-458"></a><span class="kw">SELECT</span> </span>
<span id="cb72-459"><a href="#cb72-459"></a>  <span class="kw">COLUMNS</span>(<span class="op">*</span>)</span>
<span id="cb72-460"><a href="#cb72-460"></a><span class="kw">FROM</span> (</span>
<span id="cb72-461"><a href="#cb72-461"></a>  UNPIVOT quarterly_sales</span>
<span id="cb72-462"><a href="#cb72-462"></a>  <span class="kw">ON</span> <span class="kw">COLUMNS</span>(<span class="st">'^q\d'</span>)</span>
<span id="cb72-463"><a href="#cb72-463"></a>  <span class="kw">INTO</span> </span>
<span id="cb72-464"><a href="#cb72-464"></a>    NAME <span class="fu">quarter</span></span>
<span id="cb72-465"><a href="#cb72-465"></a>    VALUE sales</span>
<span id="cb72-466"><a href="#cb72-466"></a>);</span>
<span id="cb72-467"><a href="#cb72-467"></a><span class="in">```</span></span>
<span id="cb72-468"><a href="#cb72-468"></a></span>
<span id="cb72-469"><a href="#cb72-469"></a></span>
<span id="cb72-470"><a href="#cb72-470"></a><span class="fu">## 2つの値の比率を計算する</span></span>
<span id="cb72-471"><a href="#cb72-471"></a></span>
<span id="cb72-474"><a href="#cb72-474"></a><span class="in">```{sql}</span></span>
<span id="cb72-475"><a href="#cb72-475"></a><span class="co">#| connection: con</span></span>
<span id="cb72-476"><a href="#cb72-476"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> advertising_stats;</span>
<span id="cb72-477"><a href="#cb72-477"></a><span class="in">```</span></span>
<span id="cb72-478"><a href="#cb72-478"></a></span>
<span id="cb72-479"><a href="#cb72-479"></a></span>
<span id="cb72-480"><a href="#cb72-480"></a></span>
<span id="cb72-481"><a href="#cb72-481"></a></span>
<span id="cb72-482"><a href="#cb72-482"></a></span>
<span id="cb72-483"><a href="#cb72-483"></a></span>
<span id="cb72-484"><a href="#cb72-484"></a></span>
<span id="cb72-485"><a href="#cb72-485"></a><span class="fu">### 整数型のデータの除算</span></span>
<span id="cb72-486"><a href="#cb72-486"></a></span>
<span id="cb72-487"><a href="#cb72-487"></a>CTR(Click Through Rate)を計算する。CTRの定義は「クリック数 / インプレッション数」である。</span>
<span id="cb72-488"><a href="#cb72-488"></a>整数型同士の乗算は事前に実数型に変換しておく必要がある。</span>
<span id="cb72-489"><a href="#cb72-489"></a></span>
<span id="cb72-492"><a href="#cb72-492"></a><span class="in">```{sql}</span></span>
<span id="cb72-493"><a href="#cb72-493"></a><span class="co">#| connection: con</span></span>
<span id="cb72-494"><a href="#cb72-494"></a><span class="kw">SELECT</span></span>
<span id="cb72-495"><a href="#cb72-495"></a>  dt</span>
<span id="cb72-496"><a href="#cb72-496"></a>  , ad_id</span>
<span id="cb72-497"><a href="#cb72-497"></a>  , clicks <span class="op">/</span> impressions ctr</span>
<span id="cb72-498"><a href="#cb72-498"></a>  , <span class="fl">100.</span> <span class="op">*</span> clicks <span class="op">/</span> impressions ctr_as_percent</span>
<span id="cb72-499"><a href="#cb72-499"></a>  , <span class="dv">100</span>  <span class="op">*</span> clicks <span class="op">/</span> impressions ctr_as_percent2</span>
<span id="cb72-500"><a href="#cb72-500"></a><span class="kw">FROM</span></span>
<span id="cb72-501"><a href="#cb72-501"></a>  advertising_stats</span>
<span id="cb72-502"><a href="#cb72-502"></a><span class="kw">WHERE</span></span>
<span id="cb72-503"><a href="#cb72-503"></a>  dt <span class="op">=</span> <span class="st">'2017-04-01'</span></span>
<span id="cb72-504"><a href="#cb72-504"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb72-505"><a href="#cb72-505"></a>  dt, ad_id</span>
<span id="cb72-506"><a href="#cb72-506"></a>;</span>
<span id="cb72-507"><a href="#cb72-507"></a></span>
<span id="cb72-508"><a href="#cb72-508"></a><span class="in">```</span></span>
<span id="cb72-509"><a href="#cb72-509"></a></span>
<span id="cb72-510"><a href="#cb72-510"></a></span>
<span id="cb72-511"><a href="#cb72-511"></a></span>
<span id="cb72-512"><a href="#cb72-512"></a></span>
<span id="cb72-513"><a href="#cb72-513"></a></span>
<span id="cb72-514"><a href="#cb72-514"></a></span>
<span id="cb72-515"><a href="#cb72-515"></a></span>
<span id="cb72-516"><a href="#cb72-516"></a><span class="fu">### 0除算を避ける</span></span>
<span id="cb72-517"><a href="#cb72-517"></a></span>
<span id="cb72-518"><a href="#cb72-518"></a>0除算を回避するにはCASE分を用いて分母の数が０かどうかを判定すること、</span>
<span id="cb72-519"><a href="#cb72-519"></a>または、NULLを伝搬させることがある。<span class="in">`NULLIF(x, default)`</span>は0のときに置き換える演算である。</span>
<span id="cb72-520"><a href="#cb72-520"></a></span>
<span id="cb72-521"><a href="#cb72-521"></a></span>
<span id="cb72-524"><a href="#cb72-524"></a><span class="in">```{sql}</span></span>
<span id="cb72-525"><a href="#cb72-525"></a><span class="co">#| connection: con</span></span>
<span id="cb72-526"><a href="#cb72-526"></a><span class="kw">SELECT</span></span>
<span id="cb72-527"><a href="#cb72-527"></a>  dt</span>
<span id="cb72-528"><a href="#cb72-528"></a>  , ad_id</span>
<span id="cb72-529"><a href="#cb72-529"></a>  , <span class="cf">CASE</span></span>
<span id="cb72-530"><a href="#cb72-530"></a>      <span class="cf">WHEN</span> impressions <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="fl">100.</span> <span class="op">*</span> clicks <span class="op">/</span> impressions</span>
<span id="cb72-531"><a href="#cb72-531"></a>      <span class="cf">END</span> ctr_as_percent_by_case</span>
<span id="cb72-532"><a href="#cb72-532"></a>  , <span class="fl">100.</span> <span class="op">*</span> clicks <span class="op">/</span> NULLIF(impressions, <span class="dv">0</span>) ctr_as_percent_by_null</span>
<span id="cb72-533"><a href="#cb72-533"></a><span class="kw">FROM</span> </span>
<span id="cb72-534"><a href="#cb72-534"></a>  advertising_stats</span>
<span id="cb72-535"><a href="#cb72-535"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb72-536"><a href="#cb72-536"></a>  dt, ad_id</span>
<span id="cb72-537"><a href="#cb72-537"></a>;</span>
<span id="cb72-538"><a href="#cb72-538"></a><span class="in">```</span></span>
<span id="cb72-539"><a href="#cb72-539"></a></span>
<span id="cb72-540"><a href="#cb72-540"></a></span>
<span id="cb72-541"><a href="#cb72-541"></a></span>
<span id="cb72-542"><a href="#cb72-542"></a><span class="fu">## 2つの値の距離を計算する</span></span>
<span id="cb72-543"><a href="#cb72-543"></a></span>
<span id="cb72-544"><a href="#cb72-544"></a><span class="fu">### RMS</span></span>
<span id="cb72-545"><a href="#cb72-545"></a></span>
<span id="cb72-548"><a href="#cb72-548"></a><span class="in">```{sql}</span></span>
<span id="cb72-549"><a href="#cb72-549"></a><span class="co">#| connection: con</span></span>
<span id="cb72-550"><a href="#cb72-550"></a><span class="kw">SELECT</span></span>
<span id="cb72-551"><a href="#cb72-551"></a>  <span class="fu">abs</span>(x1<span class="op">-</span>x2) <span class="fu">abs</span></span>
<span id="cb72-552"><a href="#cb72-552"></a>  , <span class="fu">sqrt</span>(<span class="fu">power</span>(x1<span class="op">-</span>x2, <span class="dv">2</span>)) rms</span>
<span id="cb72-553"><a href="#cb72-553"></a><span class="kw">FROM</span> location_1d;</span>
<span id="cb72-554"><a href="#cb72-554"></a><span class="in">```</span></span>
<span id="cb72-555"><a href="#cb72-555"></a></span>
<span id="cb72-558"><a href="#cb72-558"></a><span class="in">```{sql}</span></span>
<span id="cb72-559"><a href="#cb72-559"></a><span class="co">#| connection: con</span></span>
<span id="cb72-560"><a href="#cb72-560"></a><span class="kw">SELECT</span></span>
<span id="cb72-561"><a href="#cb72-561"></a>  x1</span>
<span id="cb72-562"><a href="#cb72-562"></a>  , <span class="fu">AVG</span>(x1) OVER()</span>
<span id="cb72-563"><a href="#cb72-563"></a>  , x1 <span class="op">-</span> <span class="fu">AVG</span>(x1) over()</span>
<span id="cb72-564"><a href="#cb72-564"></a>  , <span class="fu">POWER</span>(x1 <span class="op">-</span> <span class="fu">AVG</span>(x1) over(), <span class="dv">2</span>)</span>
<span id="cb72-565"><a href="#cb72-565"></a><span class="kw">FROM</span> location_1d;</span>
<span id="cb72-566"><a href="#cb72-566"></a><span class="in">```</span></span>
<span id="cb72-567"><a href="#cb72-567"></a></span>
<span id="cb72-568"><a href="#cb72-568"></a><span class="fu">### xy平面上で2点間のユークリッド距離を計算する</span></span>
<span id="cb72-569"><a href="#cb72-569"></a></span>
<span id="cb72-570"><a href="#cb72-570"></a>なし</span>
<span id="cb72-571"><a href="#cb72-571"></a></span>
<span id="cb72-572"><a href="#cb72-572"></a></span>
<span id="cb72-573"><a href="#cb72-573"></a><span class="fu">### arrayやlistを持ちいた距離</span></span>
<span id="cb72-574"><a href="#cb72-574"></a></span>
<span id="cb72-575"><a href="#cb72-575"></a>DBI経由だと計算できないが、コマンドラインからだと直接演算することが可能である。</span>
<span id="cb72-576"><a href="#cb72-576"></a>どうやらarrayは0.10から追加されて、その後に</span>
<span id="cb72-577"><a href="#cb72-577"></a></span>
<span id="cb72-578"><a href="#cb72-578"></a><span class="in">```sql</span></span>
<span id="cb72-579"><a href="#cb72-579"></a><span class="co">#| connection: con</span></span>
<span id="cb72-580"><a href="#cb72-580"></a></span>
<span id="cb72-581"><a href="#cb72-581"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> x;</span>
<span id="cb72-582"><a href="#cb72-582"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> y;</span>
<span id="cb72-583"><a href="#cb72-583"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> x (i <span class="dt">INT</span>, v <span class="dt">FLOAT</span>[<span class="dv">3</span>]);</span>
<span id="cb72-584"><a href="#cb72-584"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> y (i <span class="dt">INT</span>, v <span class="dt">FLOAT</span>[<span class="dv">3</span>]);</span>
<span id="cb72-585"><a href="#cb72-585"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> x <span class="kw">VALUES</span> (<span class="dv">1</span>, array_value(<span class="fl">1.0</span><span class="ch">::</span><span class="dt">FLOAT</span>, <span class="fl">2.0</span><span class="ch">::</span><span class="dt">FLOAT</span>, <span class="fl">3.0</span><span class="ch">::</span><span class="dt">FLOAT</span>));</span>
<span id="cb72-586"><a href="#cb72-586"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> y <span class="kw">VALUES</span> (<span class="dv">1</span>, array_value(<span class="fl">2.0</span><span class="ch">::</span><span class="dt">FLOAT</span>, <span class="fl">3.0</span><span class="ch">::</span><span class="dt">FLOAT</span>, <span class="fl">4.0</span><span class="ch">::</span><span class="dt">FLOAT</span>));</span>
<span id="cb72-587"><a href="#cb72-587"></a><span class="co">-- compute cross product</span></span>
<span id="cb72-588"><a href="#cb72-588"></a><span class="kw">SELECT</span> array_cross_product(x<span class="ch">.</span>v, y<span class="ch">.</span>v)</span>
<span id="cb72-589"><a href="#cb72-589"></a><span class="kw">FROM</span> x, y</span>
<span id="cb72-590"><a href="#cb72-590"></a><span class="kw">WHERE</span> x<span class="ch">.</span>i <span class="op">=</span> y<span class="ch">.</span>i;</span>
<span id="cb72-591"><a href="#cb72-591"></a><span class="in">```</span></span>
<span id="cb72-592"><a href="#cb72-592"></a></span>
<span id="cb72-593"><a href="#cb72-593"></a>リストは使えるのでリスで計算すればいいのかもしれない？？？</span>
<span id="cb72-594"><a href="#cb72-594"></a></span>
<span id="cb72-597"><a href="#cb72-597"></a><span class="in">```{sql}</span></span>
<span id="cb72-598"><a href="#cb72-598"></a><span class="co">#| connection: con</span></span>
<span id="cb72-599"><a href="#cb72-599"></a></span>
<span id="cb72-600"><a href="#cb72-600"></a><span class="kw">select</span> list_value(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
<span id="cb72-601"><a href="#cb72-601"></a></span>
<span id="cb72-602"><a href="#cb72-602"></a><span class="in">```</span></span>
<span id="cb72-603"><a href="#cb72-603"></a></span>
<span id="cb72-604"><a href="#cb72-604"></a></span>
<span id="cb72-605"><a href="#cb72-605"></a></span>
<span id="cb72-606"><a href="#cb72-606"></a></span>
<span id="cb72-607"><a href="#cb72-607"></a><span class="fu">## 日付・時刻を計算する</span></span>
<span id="cb72-608"><a href="#cb72-608"></a></span>
<span id="cb72-609"><a href="#cb72-609"></a></span>
<span id="cb72-610"><a href="#cb72-610"></a>2つの日付・時刻データの差分を計算したり、１時間後の時刻を計算するなど、の手法をみる。</span>
<span id="cb72-611"><a href="#cb72-611"></a></span>
<span id="cb72-612"><a href="#cb72-612"></a></span>
<span id="cb72-615"><a href="#cb72-615"></a><span class="in">```{sql}</span></span>
<span id="cb72-616"><a href="#cb72-616"></a><span class="co">#| connection: con</span></span>
<span id="cb72-617"><a href="#cb72-617"></a><span class="kw">SELECT</span></span>
<span id="cb72-618"><a href="#cb72-618"></a>  <span class="op">*</span></span>
<span id="cb72-619"><a href="#cb72-619"></a><span class="kw">FROM</span> mst_users_with_birthday;</span>
<span id="cb72-620"><a href="#cb72-620"></a></span>
<span id="cb72-621"><a href="#cb72-621"></a><span class="in">```</span></span>
<span id="cb72-622"><a href="#cb72-622"></a></span>
<span id="cb72-623"><a href="#cb72-623"></a></span>
<span id="cb72-624"><a href="#cb72-624"></a><span class="fu">### 日付・時刻データと定数の足し算・引き算</span></span>
<span id="cb72-625"><a href="#cb72-625"></a></span>
<span id="cb72-628"><a href="#cb72-628"></a><span class="in">```{sql}</span></span>
<span id="cb72-629"><a href="#cb72-629"></a><span class="co">#| connection: con</span></span>
<span id="cb72-630"><a href="#cb72-630"></a><span class="kw">SELECT</span></span>
<span id="cb72-631"><a href="#cb72-631"></a>  user_id</span>
<span id="cb72-632"><a href="#cb72-632"></a>  , register_stamp<span class="ch">::</span><span class="dt">timestamp</span> register_stamp</span>
<span id="cb72-633"><a href="#cb72-633"></a>  , register_stamp<span class="ch">::</span><span class="dt">timestamp</span> <span class="op">+</span> <span class="st">'1 hour'</span><span class="ch">::</span><span class="kw">interval</span> after_1_hour</span>
<span id="cb72-634"><a href="#cb72-634"></a>  , register_stamp<span class="ch">::</span><span class="dt">timestamp</span> <span class="op">-</span> <span class="st">'30 minutes'</span><span class="ch">::</span><span class="kw">interval</span> before_30_minutes</span>
<span id="cb72-635"><a href="#cb72-635"></a>  , register_stamp<span class="ch">::</span><span class="dt">date</span> register_date</span>
<span id="cb72-636"><a href="#cb72-636"></a>  , (register_stamp<span class="ch">::</span><span class="dt">date</span> <span class="op">+</span> <span class="st">'1 day'</span><span class="ch">::</span><span class="kw">interval</span>)<span class="ch">::</span><span class="dt">date</span> <span class="kw">AS</span> after_1_day</span>
<span id="cb72-637"><a href="#cb72-637"></a>  , (register_stamp<span class="ch">::</span><span class="dt">date</span> <span class="op">-</span> <span class="st">'1 month'</span><span class="ch">::</span><span class="kw">interval</span>)<span class="ch">::</span><span class="dt">date</span> <span class="kw">AS</span> before_1_month</span>
<span id="cb72-638"><a href="#cb72-638"></a>  , <span class="fu">date_add</span>(register_stamp<span class="ch">::</span><span class="dt">date</span>, <span class="st">'1 week'</span><span class="ch">::</span><span class="kw">interval</span>) <span class="kw">as</span> after_1_week</span>
<span id="cb72-639"><a href="#cb72-639"></a>  , date_trunc(<span class="st">'month'</span>, register_stamp<span class="ch">::</span><span class="dt">date</span>) <span class="kw">as</span> trunc_month</span>
<span id="cb72-640"><a href="#cb72-640"></a><span class="kw">FROM</span> mst_users_with_birthday;</span>
<span id="cb72-641"><a href="#cb72-641"></a></span>
<span id="cb72-642"><a href="#cb72-642"></a><span class="in">```</span></span>
<span id="cb72-643"><a href="#cb72-643"></a></span>
<span id="cb72-644"><a href="#cb72-644"></a></span>
<span id="cb72-645"><a href="#cb72-645"></a><span class="fu">### 日付データ同士の差分を計算する</span></span>
<span id="cb72-646"><a href="#cb72-646"></a></span>
<span id="cb72-649"><a href="#cb72-649"></a><span class="in">```{sql}</span></span>
<span id="cb72-650"><a href="#cb72-650"></a><span class="co">#| connection: con</span></span>
<span id="cb72-651"><a href="#cb72-651"></a><span class="kw">SELECT</span></span>
<span id="cb72-652"><a href="#cb72-652"></a>  user_id</span>
<span id="cb72-653"><a href="#cb72-653"></a>  , <span class="kw">CURRENT_DATE</span> today</span>
<span id="cb72-654"><a href="#cb72-654"></a>  , register_stamp<span class="ch">::</span><span class="dt">date</span> register_date</span>
<span id="cb72-655"><a href="#cb72-655"></a>  , <span class="kw">CURRENT_DATE</span> <span class="op">-</span> register_stamp<span class="ch">::</span><span class="dt">date</span> diff_days</span>
<span id="cb72-656"><a href="#cb72-656"></a><span class="kw">FROM</span> mst_users_with_birthday;</span>
<span id="cb72-657"><a href="#cb72-657"></a><span class="in">```</span></span>
<span id="cb72-658"><a href="#cb72-658"></a></span>
<span id="cb72-659"><a href="#cb72-659"></a></span>
<span id="cb72-660"><a href="#cb72-660"></a><span class="fu">### ユーザーの生年月日から年齢を計算する</span></span>
<span id="cb72-661"><a href="#cb72-661"></a></span>
<span id="cb72-662"><a href="#cb72-662"></a></span>
<span id="cb72-665"><a href="#cb72-665"></a><span class="in">```{sql}</span></span>
<span id="cb72-666"><a href="#cb72-666"></a><span class="co">#| connection: con</span></span>
<span id="cb72-667"><a href="#cb72-667"></a><span class="kw">SELECT</span></span>
<span id="cb72-668"><a href="#cb72-668"></a>  user_id</span>
<span id="cb72-669"><a href="#cb72-669"></a>  , <span class="kw">CURRENT_DATE</span> today</span>
<span id="cb72-670"><a href="#cb72-670"></a>  , register_stamp<span class="ch">::</span><span class="dt">date</span> register_date</span>
<span id="cb72-671"><a href="#cb72-671"></a>  , birth_date<span class="ch">::</span><span class="dt">date</span> birth_date</span>
<span id="cb72-672"><a href="#cb72-672"></a>  , age(birth_date<span class="ch">::</span><span class="dt">date</span>) age</span>
<span id="cb72-673"><a href="#cb72-673"></a>  , age(register_stamp<span class="ch">::</span><span class="dt">date</span>, birth_date<span class="ch">::</span><span class="dt">date</span>) age2</span>
<span id="cb72-674"><a href="#cb72-674"></a>  , <span class="fu">EXTRACT</span>(<span class="fu">YEAR</span> <span class="kw">FROM</span> age(birth_date<span class="ch">::</span><span class="dt">date</span>)) current_age</span>
<span id="cb72-675"><a href="#cb72-675"></a>  , <span class="fu">EXTRACT</span>(<span class="fu">YEAR</span> <span class="kw">FROM</span> age(register_stamp<span class="ch">::</span><span class="dt">date</span>, birth_date<span class="ch">::</span><span class="dt">date</span>)) register_age</span>
<span id="cb72-676"><a href="#cb72-676"></a><span class="kw">FROM</span> mst_users_with_birthday;</span>
<span id="cb72-677"><a href="#cb72-677"></a></span>
<span id="cb72-678"><a href="#cb72-678"></a><span class="in">```</span></span>
<span id="cb72-679"><a href="#cb72-679"></a></span>
<span id="cb72-680"><a href="#cb72-680"></a></span>
<span id="cb72-681"><a href="#cb72-681"></a><span class="fu">## IPアドレスを扱う</span></span>
<span id="cb72-682"><a href="#cb72-682"></a></span>
<span id="cb72-683"><a href="#cb72-683"></a>duckdbには<span class="in">`inet`</span>型はないみたいである。</span>
<span id="cb72-684"><a href="#cb72-684"></a></span>
<span id="cb72-685"><a href="#cb72-685"></a><span class="in">```sql</span></span>
<span id="cb72-686"><a href="#cb72-686"></a><span class="co">#| connection: con</span></span>
<span id="cb72-687"><a href="#cb72-687"></a><span class="kw">SELECT</span></span>
<span id="cb72-688"><a href="#cb72-688"></a>  <span class="fu">CAST</span>(<span class="st">'172.16.4.46'</span> <span class="kw">as</span> inet) <span class="op">&lt;</span> <span class="fu">cast</span>(<span class="st">'172.17.49.127'</span> <span class="kw">as</span> inet ) <span class="kw">as</span> lt;</span>
<span id="cb72-689"><a href="#cb72-689"></a><span class="in">```</span></span>
<span id="cb72-690"><a href="#cb72-690"></a></span>
<span id="cb72-691"><a href="#cb72-691"></a><span class="fu">### 整数値や文字列としてIPアドレスを扱う</span></span>
<span id="cb72-692"><a href="#cb72-692"></a></span>
<span id="cb72-693"><a href="#cb72-693"></a>BIT型が存在しているらしいがここでは使うことができなかった。ｓｓ</span>
<span id="cb72-694"><a href="#cb72-694"></a></span>
<span id="cb72-695"><a href="#cb72-695"></a></span>
<span id="cb72-698"><a href="#cb72-698"></a><span class="in">```{sql}</span></span>
<span id="cb72-699"><a href="#cb72-699"></a><span class="co">#| connection: con</span></span>
<span id="cb72-700"><a href="#cb72-700"></a><span class="kw">SELECT</span></span>
<span id="cb72-701"><a href="#cb72-701"></a>  ip</span>
<span id="cb72-702"><a href="#cb72-702"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">1</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_1</span>
<span id="cb72-703"><a href="#cb72-703"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">2</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_2</span>
<span id="cb72-704"><a href="#cb72-704"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">3</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_3</span>
<span id="cb72-705"><a href="#cb72-705"></a>  , <span class="fu">CAST</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">4</span>) <span class="kw">AS</span> <span class="dt">integer</span>) part_4</span>
<span id="cb72-706"><a href="#cb72-706"></a>  </span>
<span id="cb72-707"><a href="#cb72-707"></a>  <span class="co">-- ０パディング</span></span>
<span id="cb72-708"><a href="#cb72-708"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">1</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_1</span>
<span id="cb72-709"><a href="#cb72-709"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">2</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_2</span>
<span id="cb72-710"><a href="#cb72-710"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">3</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_3</span>
<span id="cb72-711"><a href="#cb72-711"></a>  , <span class="fu">lpad</span>(split_part(ip, <span class="st">'.'</span>,  <span class="dv">4</span>), <span class="dv">3</span>, <span class="st">'0'</span>) part_4</span>
<span id="cb72-712"><a href="#cb72-712"></a>  </span>
<span id="cb72-713"><a href="#cb72-713"></a>  <span class="co">-- , CAST(split_part(ip, '.',  1) AS integer) bit_part_1</span></span>
<span id="cb72-714"><a href="#cb72-714"></a>  <span class="co">-- , CAST(split_part(ip, '.',  2) AS integer)::BIT bit_part_2</span></span>
<span id="cb72-715"><a href="#cb72-715"></a>  <span class="co">-- , CAST(split_part(ip, '.',  3) AS integer)::BIT bit_part_3</span></span>
<span id="cb72-716"><a href="#cb72-716"></a>  <span class="co">-- , CAST(split_part(ip, '.',  4) AS integer)::BIT bit_part_4</span></span>
<span id="cb72-717"><a href="#cb72-717"></a><span class="kw">FROM</span> (</span>
<span id="cb72-718"><a href="#cb72-718"></a>  <span class="kw">SELECT</span> <span class="st">'192.168.0.1'</span> <span class="kw">AS</span> ip</span>
<span id="cb72-719"><a href="#cb72-719"></a>) <span class="kw">as</span> t</span>
<span id="cb72-720"><a href="#cb72-720"></a><span class="in">```</span></span>
<span id="cb72-721"><a href="#cb72-721"></a></span>
<span id="cb72-722"><a href="#cb72-722"></a><span class="fu"># 1つのテーブルに対する操作</span></span>
<span id="cb72-723"><a href="#cb72-723"></a></span>
<span id="cb72-724"><a href="#cb72-724"></a><span class="in">`SQL:2003`</span>から複数レコードにまたがるデータを同時に取り合うことができる。</span>
<span id="cb72-725"><a href="#cb72-725"></a></span>
<span id="cb72-726"><a href="#cb72-726"></a><span class="fu">## グループの特徴を捉える。</span></span>
<span id="cb72-727"><a href="#cb72-727"></a></span>
<span id="cb72-730"><a href="#cb72-730"></a><span class="in">```{sql}</span></span>
<span id="cb72-731"><a href="#cb72-731"></a><span class="co">#| connection: con</span></span>
<span id="cb72-732"><a href="#cb72-732"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> review;</span>
<span id="cb72-733"><a href="#cb72-733"></a><span class="in">```</span></span>
<span id="cb72-734"><a href="#cb72-734"></a></span>
<span id="cb72-735"><a href="#cb72-735"></a></span>
<span id="cb72-736"><a href="#cb72-736"></a><span class="fu">### テーブル全体の特徴量</span></span>
<span id="cb72-737"><a href="#cb72-737"></a></span>
<span id="cb72-740"><a href="#cb72-740"></a><span class="in">```{sql}</span></span>
<span id="cb72-741"><a href="#cb72-741"></a><span class="co">#| connection: con</span></span>
<span id="cb72-742"><a href="#cb72-742"></a><span class="kw">SELECT</span></span>
<span id="cb72-743"><a href="#cb72-743"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) total_count</span>
<span id="cb72-744"><a href="#cb72-744"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> user_id) user_count</span>
<span id="cb72-745"><a href="#cb72-745"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> product_id) product_count</span>
<span id="cb72-746"><a href="#cb72-746"></a>  , <span class="fu">SUM</span>(score) <span class="fu">sum</span></span>
<span id="cb72-747"><a href="#cb72-747"></a>  , <span class="fu">AVG</span>(score) <span class="fu">avg</span></span>
<span id="cb72-748"><a href="#cb72-748"></a>  , <span class="fu">MIN</span>(score) <span class="fu">min</span></span>
<span id="cb72-749"><a href="#cb72-749"></a>  , <span class="fu">MAX</span>(score) <span class="fu">max</span></span>
<span id="cb72-750"><a href="#cb72-750"></a>  , <span class="fu">LN</span>(<span class="fu">SUM</span>(<span class="fu">EXP</span>(score))) log_sum_exp</span>
<span id="cb72-751"><a href="#cb72-751"></a><span class="kw">FROM</span> </span>
<span id="cb72-752"><a href="#cb72-752"></a>  review</span>
<span id="cb72-753"><a href="#cb72-753"></a>;</span>
<span id="cb72-754"><a href="#cb72-754"></a><span class="in">```</span></span>
<span id="cb72-755"><a href="#cb72-755"></a></span>
<span id="cb72-756"><a href="#cb72-756"></a></span>
<span id="cb72-757"><a href="#cb72-757"></a></span>
<span id="cb72-758"><a href="#cb72-758"></a><span class="fu">### グルーピングしたテーブル全体の特徴量</span></span>
<span id="cb72-759"><a href="#cb72-759"></a></span>
<span id="cb72-762"><a href="#cb72-762"></a><span class="in">```{sql}</span></span>
<span id="cb72-763"><a href="#cb72-763"></a><span class="co">#| connection: con</span></span>
<span id="cb72-764"><a href="#cb72-764"></a><span class="kw">SELECT</span></span>
<span id="cb72-765"><a href="#cb72-765"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) total_count</span>
<span id="cb72-766"><a href="#cb72-766"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> user_id) user_count</span>
<span id="cb72-767"><a href="#cb72-767"></a>  , <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> product_id) product_count</span>
<span id="cb72-768"><a href="#cb72-768"></a>  , <span class="fu">SUM</span>(score) <span class="fu">sum</span></span>
<span id="cb72-769"><a href="#cb72-769"></a>  , <span class="fu">AVG</span>(score) <span class="fu">avg</span></span>
<span id="cb72-770"><a href="#cb72-770"></a>  , <span class="fu">MIN</span>(score) <span class="fu">min</span></span>
<span id="cb72-771"><a href="#cb72-771"></a>  , <span class="fu">MAX</span>(score) <span class="fu">max</span></span>
<span id="cb72-772"><a href="#cb72-772"></a>  , <span class="fu">LN</span>(<span class="fu">SUM</span>(<span class="fu">EXP</span>(score))) log_sum_exp</span>
<span id="cb72-773"><a href="#cb72-773"></a><span class="kw">FROM</span> </span>
<span id="cb72-774"><a href="#cb72-774"></a>  review</span>
<span id="cb72-775"><a href="#cb72-775"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb72-776"><a href="#cb72-776"></a>  user_id</span>
<span id="cb72-777"><a href="#cb72-777"></a>;</span>
<span id="cb72-778"><a href="#cb72-778"></a><span class="in">```</span></span>
<span id="cb72-779"><a href="#cb72-779"></a></span>
<span id="cb72-780"><a href="#cb72-780"></a></span>
<span id="cb72-781"><a href="#cb72-781"></a><span class="fu">### 集約関数を適用した値と集約前の値を同時に扱う</span></span>
<span id="cb72-782"><a href="#cb72-782"></a></span>
<span id="cb72-785"><a href="#cb72-785"></a><span class="in">```{sql}</span></span>
<span id="cb72-786"><a href="#cb72-786"></a><span class="co">#| connection: con</span></span>
<span id="cb72-787"><a href="#cb72-787"></a><span class="kw">SELECT</span></span>
<span id="cb72-788"><a href="#cb72-788"></a>  user_id</span>
<span id="cb72-789"><a href="#cb72-789"></a>  , product_id</span>
<span id="cb72-790"><a href="#cb72-790"></a>  , score</span>
<span id="cb72-791"><a href="#cb72-791"></a>  , <span class="fu">AVG</span>(score) OVER() avg_score</span>
<span id="cb72-792"><a href="#cb72-792"></a>  , <span class="fu">AVG</span>(score) OVER(PARTITION <span class="kw">BY</span> user_id) user_avg_score</span>
<span id="cb72-793"><a href="#cb72-793"></a>  , score <span class="op">-</span> <span class="fu">AVG</span>(score) OVER(PARTITION <span class="kw">BY</span> user_id) user_avg_score_diff</span>
<span id="cb72-794"><a href="#cb72-794"></a><span class="kw">FROM</span> </span>
<span id="cb72-795"><a href="#cb72-795"></a>  review</span>
<span id="cb72-796"><a href="#cb72-796"></a>;</span>
<span id="cb72-797"><a href="#cb72-797"></a></span>
<span id="cb72-798"><a href="#cb72-798"></a><span class="in">```</span></span>
<span id="cb72-799"><a href="#cb72-799"></a></span>
<span id="cb72-800"><a href="#cb72-800"></a><span class="fu">## グループの中での順序を扱う</span></span>
<span id="cb72-801"><a href="#cb72-801"></a></span>
<span id="cb72-804"><a href="#cb72-804"></a><span class="in">```{sql}</span></span>
<span id="cb72-805"><a href="#cb72-805"></a><span class="co">#| connection: con</span></span>
<span id="cb72-806"><a href="#cb72-806"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> popular_products;</span>
<span id="cb72-807"><a href="#cb72-807"></a></span>
<span id="cb72-808"><a href="#cb72-808"></a><span class="in">```</span></span>
<span id="cb72-809"><a href="#cb72-809"></a></span>
<span id="cb72-810"><a href="#cb72-810"></a></span>
<span id="cb72-811"><a href="#cb72-811"></a><span class="fu">### ORDER BYを使う</span></span>
<span id="cb72-812"><a href="#cb72-812"></a></span>
<span id="cb72-813"><a href="#cb72-813"></a>ウインドウ関数のなかで「ORDER BY」を使う。</span>
<span id="cb72-814"><a href="#cb72-814"></a></span>
<span id="cb72-817"><a href="#cb72-817"></a><span class="in">```{sql}</span></span>
<span id="cb72-818"><a href="#cb72-818"></a><span class="co">#| connection: con</span></span>
<span id="cb72-819"><a href="#cb72-819"></a><span class="kw">SELECT</span></span>
<span id="cb72-820"><a href="#cb72-820"></a>  product_id</span>
<span id="cb72-821"><a href="#cb72-821"></a>  </span>
<span id="cb72-822"><a href="#cb72-822"></a>  , score</span>
<span id="cb72-823"><a href="#cb72-823"></a>  </span>
<span id="cb72-824"><a href="#cb72-824"></a>  , ROW_NUMBER() OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> row</span>
<span id="cb72-825"><a href="#cb72-825"></a>  </span>
<span id="cb72-826"><a href="#cb72-826"></a>  , RANK() OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> rank</span>
<span id="cb72-827"><a href="#cb72-827"></a>  </span>
<span id="cb72-828"><a href="#cb72-828"></a>  , DENSE_RANK() OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) dense_rank</span>
<span id="cb72-829"><a href="#cb72-829"></a>  </span>
<span id="cb72-830"><a href="#cb72-830"></a>  , LAG(product_id) OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lag1</span>
<span id="cb72-831"><a href="#cb72-831"></a>  </span>
<span id="cb72-832"><a href="#cb72-832"></a>  , LAG(product_id, <span class="dv">2</span>) OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lag2</span>
<span id="cb72-833"><a href="#cb72-833"></a>  </span>
<span id="cb72-834"><a href="#cb72-834"></a>  , LEAD(product_id) OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lead1</span>
<span id="cb72-835"><a href="#cb72-835"></a>  </span>
<span id="cb72-836"><a href="#cb72-836"></a>  , LEAD(product_id, <span class="dv">2</span>) OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) lead2</span>
<span id="cb72-837"><a href="#cb72-837"></a></span>
<span id="cb72-838"><a href="#cb72-838"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb72-839"><a href="#cb72-839"></a></span>
<span id="cb72-840"><a href="#cb72-840"></a><span class="kw">ORDER</span> <span class="kw">BY</span> row</span>
<span id="cb72-841"><a href="#cb72-841"></a></span>
<span id="cb72-842"><a href="#cb72-842"></a>;</span>
<span id="cb72-843"><a href="#cb72-843"></a></span>
<span id="cb72-844"><a href="#cb72-844"></a><span class="in">```</span></span>
<span id="cb72-845"><a href="#cb72-845"></a></span>
<span id="cb72-846"><a href="#cb72-846"></a></span>
<span id="cb72-847"><a href="#cb72-847"></a><span class="fu">### ORDER BYと集約組み合わせる</span></span>
<span id="cb72-848"><a href="#cb72-848"></a></span>
<span id="cb72-849"><a href="#cb72-849"></a></span>
<span id="cb72-852"><a href="#cb72-852"></a><span class="in">```{sql}</span></span>
<span id="cb72-853"><a href="#cb72-853"></a><span class="co">#| connection: con</span></span>
<span id="cb72-854"><a href="#cb72-854"></a><span class="kw">SELECT</span></span>
<span id="cb72-855"><a href="#cb72-855"></a>  product_id</span>
<span id="cb72-856"><a href="#cb72-856"></a>  </span>
<span id="cb72-857"><a href="#cb72-857"></a>  , score</span>
<span id="cb72-858"><a href="#cb72-858"></a>  </span>
<span id="cb72-859"><a href="#cb72-859"></a>  , ROW_NUMBER() OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> row</span>
<span id="cb72-860"><a href="#cb72-860"></a>  </span>
<span id="cb72-861"><a href="#cb72-861"></a>  , <span class="fu">SUM</span>(score) OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span></span>
<span id="cb72-862"><a href="#cb72-862"></a>                    ROWS <span class="kw">BETWEEN</span> UNBOUNDED PRECEDING <span class="kw">AND</span> CURRENT ROW) cum_score</span>
<span id="cb72-863"><a href="#cb72-863"></a>                    </span>
<span id="cb72-864"><a href="#cb72-864"></a>  , <span class="fu">AVG</span>(score) OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span> </span>
<span id="cb72-865"><a href="#cb72-865"></a>                    ROWS <span class="kw">BETWEEN</span> <span class="dv">1</span> PRECEDING <span class="kw">AND</span> <span class="dv">1</span> FOLLOWING) local_avg</span>
<span id="cb72-866"><a href="#cb72-866"></a>                    </span>
<span id="cb72-867"><a href="#cb72-867"></a>  <span class="co">-- ランキング上位の商品IDを取得する</span></span>
<span id="cb72-868"><a href="#cb72-868"></a>  , FIRST_VALUE(product_id) OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span></span>
<span id="cb72-869"><a href="#cb72-869"></a>                                 ROWS <span class="kw">BETWEEN</span> UNBOUNDED PRECEDING <span class="kw">AND</span> UNBOUNDED FOLLOWING) <span class="kw">as</span> first_value</span>
<span id="cb72-870"><a href="#cb72-870"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb72-871"><a href="#cb72-871"></a><span class="kw">ORDER</span> <span class="kw">BY</span> row;</span>
<span id="cb72-872"><a href="#cb72-872"></a></span>
<span id="cb72-873"><a href="#cb72-873"></a></span>
<span id="cb72-874"><a href="#cb72-874"></a><span class="in">```</span></span>
<span id="cb72-875"><a href="#cb72-875"></a></span>
<span id="cb72-876"><a href="#cb72-876"></a></span>
<span id="cb72-877"><a href="#cb72-877"></a>商品の集約をおこなおうことも可能である</span>
<span id="cb72-878"><a href="#cb72-878"></a></span>
<span id="cb72-879"><a href="#cb72-879"></a></span>
<span id="cb72-882"><a href="#cb72-882"></a><span class="in">```{sql}</span></span>
<span id="cb72-883"><a href="#cb72-883"></a><span class="co">#| connection: con</span></span>
<span id="cb72-884"><a href="#cb72-884"></a><span class="kw">SELECT</span></span>
<span id="cb72-885"><a href="#cb72-885"></a>  product_id</span>
<span id="cb72-886"><a href="#cb72-886"></a>  </span>
<span id="cb72-887"><a href="#cb72-887"></a>  , ROW_NUMBER() OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> row</span>
<span id="cb72-888"><a href="#cb72-888"></a>  </span>
<span id="cb72-889"><a href="#cb72-889"></a>  , list(product_id) </span>
<span id="cb72-890"><a href="#cb72-890"></a>      OVER(<span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span> </span>
<span id="cb72-891"><a href="#cb72-891"></a>           ROWS <span class="kw">BETWEEN</span> UNBOUNDED PRECEDING <span class="kw">AND</span> UNBOUNDED FOLLOWING) list</span>
<span id="cb72-892"><a href="#cb72-892"></a>  </span>
<span id="cb72-893"><a href="#cb72-893"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb72-894"><a href="#cb72-894"></a><span class="kw">WHERE</span> category <span class="op">=</span> <span class="st">'action'</span></span>
<span id="cb72-895"><a href="#cb72-895"></a><span class="kw">ORDER</span> <span class="kw">BY</span> row;</span>
<span id="cb72-896"><a href="#cb72-896"></a></span>
<span id="cb72-897"><a href="#cb72-897"></a></span>
<span id="cb72-898"><a href="#cb72-898"></a><span class="in">```</span></span>
<span id="cb72-899"><a href="#cb72-899"></a></span>
<span id="cb72-900"><a href="#cb72-900"></a>DuckdDBだと配列で距離を計算できる。version 0.10以降なのに注意する。</span>
<span id="cb72-901"><a href="#cb72-901"></a></span>
<span id="cb72-902"><a href="#cb72-902"></a></span>
<span id="cb72-903"><a href="#cb72-903"></a><span class="fu">### PARTITION BY と ORDER BYを組み合わせる</span></span>
<span id="cb72-904"><a href="#cb72-904"></a></span>
<span id="cb72-907"><a href="#cb72-907"></a><span class="in">```{sql}</span></span>
<span id="cb72-908"><a href="#cb72-908"></a><span class="co">#| connection: con</span></span>
<span id="cb72-909"><a href="#cb72-909"></a></span>
<span id="cb72-910"><a href="#cb72-910"></a><span class="kw">SELECT</span></span>
<span id="cb72-911"><a href="#cb72-911"></a>  category</span>
<span id="cb72-912"><a href="#cb72-912"></a>  , product_id</span>
<span id="cb72-913"><a href="#cb72-913"></a>  , score</span>
<span id="cb72-914"><a href="#cb72-914"></a>  , ROW_NUMBER() </span>
<span id="cb72-915"><a href="#cb72-915"></a>    OVER(</span>
<span id="cb72-916"><a href="#cb72-916"></a>        PARTITION <span class="kw">BY</span> category</span>
<span id="cb72-917"><a href="#cb72-917"></a>        <span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span>) <span class="kw">as</span> row</span>
<span id="cb72-918"><a href="#cb72-918"></a><span class="kw">FROM</span> popular_products</span>
<span id="cb72-919"><a href="#cb72-919"></a><span class="kw">WHERE</span> category <span class="op">=</span> <span class="st">'action'</span></span>
<span id="cb72-920"><a href="#cb72-920"></a><span class="kw">ORDER</span> <span class="kw">BY</span> row;</span>
<span id="cb72-921"><a href="#cb72-921"></a></span>
<span id="cb72-922"><a href="#cb72-922"></a></span>
<span id="cb72-923"><a href="#cb72-923"></a><span class="in">```</span></span>
<span id="cb72-924"><a href="#cb72-924"></a></span>
<span id="cb72-925"><a href="#cb72-925"></a></span>
<span id="cb72-926"><a href="#cb72-926"></a>カテゴリごとに最上位ランクの商品を取り出す。</span>
<span id="cb72-927"><a href="#cb72-927"></a></span>
<span id="cb72-930"><a href="#cb72-930"></a><span class="in">```{sql}</span></span>
<span id="cb72-931"><a href="#cb72-931"></a><span class="co">#| connection: con</span></span>
<span id="cb72-932"><a href="#cb72-932"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> </span>
<span id="cb72-933"><a href="#cb72-933"></a>  category</span>
<span id="cb72-934"><a href="#cb72-934"></a>  , FIRST_VALUE(product_id)</span>
<span id="cb72-935"><a href="#cb72-935"></a>      OVER(PARTITION <span class="kw">BY</span> category <span class="kw">ORDER</span> <span class="kw">BY</span> score <span class="kw">DESC</span></span>
<span id="cb72-936"><a href="#cb72-936"></a>           ROWS <span class="kw">BETWEEN</span> UNBOUNDED PRECEDING <span class="kw">AND</span> UNBOUNDED FOLLOWING)</span>
<span id="cb72-937"><a href="#cb72-937"></a>      product_id</span>
<span id="cb72-938"><a href="#cb72-938"></a><span class="kw">FROM</span> popular_products;</span>
<span id="cb72-939"><a href="#cb72-939"></a></span>
<span id="cb72-940"><a href="#cb72-940"></a><span class="in">```</span></span>
<span id="cb72-941"><a href="#cb72-941"></a></span>
<span id="cb72-942"><a href="#cb72-942"></a><span class="fu">## 縦持ちのデータを横持ちに変換する</span></span>
<span id="cb72-943"><a href="#cb72-943"></a></span>
<span id="cb72-944"><a href="#cb72-944"></a>duckdbは<span class="in">`PIVOT`</span>を使えるので問題ない。他のSQLおこなう方法について示す。</span>
<span id="cb72-945"><a href="#cb72-945"></a></span>
<span id="cb72-948"><a href="#cb72-948"></a><span class="in">```{sql}</span></span>
<span id="cb72-949"><a href="#cb72-949"></a><span class="co">#| connection: con</span></span>
<span id="cb72-950"><a href="#cb72-950"></a></span>
<span id="cb72-951"><a href="#cb72-951"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> daily_kpi;</span>
<span id="cb72-952"><a href="#cb72-952"></a></span>
<span id="cb72-953"><a href="#cb72-953"></a><span class="in">```</span></span>
<span id="cb72-954"><a href="#cb72-954"></a></span>
<span id="cb72-955"><a href="#cb72-955"></a></span>
<span id="cb72-958"><a href="#cb72-958"></a><span class="in">```{sql}</span></span>
<span id="cb72-959"><a href="#cb72-959"></a><span class="co">#| connection: con</span></span>
<span id="cb72-960"><a href="#cb72-960"></a></span>
<span id="cb72-961"><a href="#cb72-961"></a><span class="kw">SELECT</span></span>
<span id="cb72-962"><a href="#cb72-962"></a>  dt</span>
<span id="cb72-963"><a href="#cb72-963"></a>  , <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> indicator <span class="op">=</span> <span class="st">'impressions'</span> <span class="cf">THEN</span> val <span class="cf">END</span>) impressions</span>
<span id="cb72-964"><a href="#cb72-964"></a>  , <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> indicator <span class="op">=</span> <span class="st">'sessions'</span> <span class="cf">THEN</span> val <span class="cf">END</span>) sessions</span>
<span id="cb72-965"><a href="#cb72-965"></a>  , <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> indicator <span class="op">=</span> <span class="st">'users'</span> <span class="cf">THEN</span> val <span class="cf">END</span>) users</span>
<span id="cb72-966"><a href="#cb72-966"></a><span class="kw">FROM</span> daily_kpi</span>
<span id="cb72-967"><a href="#cb72-967"></a><span class="kw">GROUP</span> <span class="kw">BY</span> dt</span>
<span id="cb72-968"><a href="#cb72-968"></a><span class="kw">ORDER</span> <span class="kw">BY</span> dt;</span>
<span id="cb72-969"><a href="#cb72-969"></a></span>
<span id="cb72-970"><a href="#cb72-970"></a></span>
<span id="cb72-971"><a href="#cb72-971"></a><span class="in">```</span></span>
<span id="cb72-972"><a href="#cb72-972"></a></span>
<span id="cb72-973"><a href="#cb72-973"></a></span>
<span id="cb72-974"><a href="#cb72-974"></a><span class="fu">### 行を区切りの文字列に集約する</span></span>
<span id="cb72-975"><a href="#cb72-975"></a></span>
<span id="cb72-978"><a href="#cb72-978"></a><span class="in">```{sql}</span></span>
<span id="cb72-979"><a href="#cb72-979"></a><span class="co">#| connection: con</span></span>
<span id="cb72-980"><a href="#cb72-980"></a></span>
<span id="cb72-981"><a href="#cb72-981"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> purchase_detail_log;</span>
<span id="cb72-982"><a href="#cb72-982"></a></span>
<span id="cb72-983"><a href="#cb72-983"></a><span class="in">```</span></span>
<span id="cb72-984"><a href="#cb72-984"></a></span>
<span id="cb72-987"><a href="#cb72-987"></a><span class="in">```{sql}</span></span>
<span id="cb72-988"><a href="#cb72-988"></a><span class="co">#| connection: con</span></span>
<span id="cb72-989"><a href="#cb72-989"></a></span>
<span id="cb72-990"><a href="#cb72-990"></a><span class="kw">SELECT</span></span>
<span id="cb72-991"><a href="#cb72-991"></a>  purchase_id</span>
<span id="cb72-992"><a href="#cb72-992"></a>  , string_agg(product_id, <span class="st">','</span>) prudct_ids</span>
<span id="cb72-993"><a href="#cb72-993"></a><span class="kw">FROM</span> purchase_detail_log</span>
<span id="cb72-994"><a href="#cb72-994"></a><span class="kw">GROUP</span> <span class="kw">BY</span> purchase_id</span>
<span id="cb72-995"><a href="#cb72-995"></a><span class="kw">ORDER</span> <span class="kw">BY</span> purchase_id</span>
<span id="cb72-996"><a href="#cb72-996"></a></span>
<span id="cb72-997"><a href="#cb72-997"></a><span class="in">```</span></span>
<span id="cb72-998"><a href="#cb72-998"></a></span>
<span id="cb72-999"><a href="#cb72-999"></a></span>
<span id="cb72-1002"><a href="#cb72-1002"></a><span class="in">```{sql}</span></span>
<span id="cb72-1003"><a href="#cb72-1003"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1004"><a href="#cb72-1004"></a></span>
<span id="cb72-1005"><a href="#cb72-1005"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="op">*</span> <span class="kw">FROM</span> duckdb_functions() <span class="kw">WHERE</span> function_name <span class="kw">LIKE</span> <span class="st">'%nest'</span> <span class="kw">ORDER</span> <span class="kw">BY</span> function_name;</span>
<span id="cb72-1006"><a href="#cb72-1006"></a></span>
<span id="cb72-1007"><a href="#cb72-1007"></a><span class="in">```</span></span>
<span id="cb72-1008"><a href="#cb72-1008"></a></span>
<span id="cb72-1009"><a href="#cb72-1009"></a></span>
<span id="cb72-1010"><a href="#cb72-1010"></a><span class="fu">## 横持ちデータを縦持ちデータに変換する</span></span>
<span id="cb72-1011"><a href="#cb72-1011"></a></span>
<span id="cb72-1012"><a href="#cb72-1012"></a>組合せを作成しておいて、1つ1つ設定することになる。</span>
<span id="cb72-1013"><a href="#cb72-1013"></a></span>
<span id="cb72-1014"><a href="#cb72-1014"></a>CROSS JOINをしているがつまりは直積集合であるのでFROM A, Bでも大丈夫ななず。</span>
<span id="cb72-1015"><a href="#cb72-1015"></a></span>
<span id="cb72-1018"><a href="#cb72-1018"></a><span class="in">```{sql}</span></span>
<span id="cb72-1019"><a href="#cb72-1019"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1020"><a href="#cb72-1020"></a><span class="kw">select</span></span>
<span id="cb72-1021"><a href="#cb72-1021"></a>    q<span class="ch">.</span><span class="fu">year</span></span>
<span id="cb72-1022"><a href="#cb72-1022"></a>    , <span class="cf">case</span></span>
<span id="cb72-1023"><a href="#cb72-1023"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span> <span class="st">'q1'</span></span>
<span id="cb72-1024"><a href="#cb72-1024"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span> <span class="st">'q2'</span></span>
<span id="cb72-1025"><a href="#cb72-1025"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">3</span> <span class="cf">then</span> <span class="st">'q3'</span></span>
<span id="cb72-1026"><a href="#cb72-1026"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">4</span> <span class="cf">then</span> <span class="st">'q4'</span></span>
<span id="cb72-1027"><a href="#cb72-1027"></a>    <span class="cf">end</span> <span class="kw">as</span> name</span>
<span id="cb72-1028"><a href="#cb72-1028"></a>    , <span class="cf">case</span></span>
<span id="cb72-1029"><a href="#cb72-1029"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span> q<span class="ch">.</span>q1</span>
<span id="cb72-1030"><a href="#cb72-1030"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span> q<span class="ch">.</span>q2</span>
<span id="cb72-1031"><a href="#cb72-1031"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">3</span> <span class="cf">then</span> q<span class="ch">.</span>q3</span>
<span id="cb72-1032"><a href="#cb72-1032"></a>        <span class="cf">when</span> p<span class="ch">.</span>idx <span class="op">=</span> <span class="dv">4</span> <span class="cf">then</span> q<span class="ch">.</span>q4</span>
<span id="cb72-1033"><a href="#cb72-1033"></a>    <span class="cf">end</span> <span class="kw">as</span> value</span>
<span id="cb72-1034"><a href="#cb72-1034"></a><span class="kw">from</span></span>
<span id="cb72-1035"><a href="#cb72-1035"></a>    quarterly_sales <span class="kw">as</span> q</span>
<span id="cb72-1036"><a href="#cb72-1036"></a>    <span class="kw">cross</span> <span class="kw">join</span> (</span>
<span id="cb72-1037"><a href="#cb72-1037"></a>        <span class="kw">select</span> <span class="dv">1</span> <span class="kw">as</span> idx</span>
<span id="cb72-1038"><a href="#cb72-1038"></a>        <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> <span class="dv">2</span> idx</span>
<span id="cb72-1039"><a href="#cb72-1039"></a>        <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> <span class="dv">3</span> idx</span>
<span id="cb72-1040"><a href="#cb72-1040"></a>        <span class="kw">union</span> <span class="kw">all</span> <span class="kw">select</span> <span class="dv">4</span> idx</span>
<span id="cb72-1041"><a href="#cb72-1041"></a>    ) <span class="kw">as</span> p</span>
<span id="cb72-1042"><a href="#cb72-1042"></a>;</span>
<span id="cb72-1043"><a href="#cb72-1043"></a></span>
<span id="cb72-1044"><a href="#cb72-1044"></a><span class="in">```</span></span>
<span id="cb72-1045"><a href="#cb72-1045"></a></span>
<span id="cb72-1046"><a href="#cb72-1046"></a></span>
<span id="cb72-1047"><a href="#cb72-1047"></a><span class="fu">### 任意長の配列を行に展開する</span></span>
<span id="cb72-1048"><a href="#cb72-1048"></a></span>
<span id="cb72-1051"><a href="#cb72-1051"></a><span class="in">```{sql}</span></span>
<span id="cb72-1052"><a href="#cb72-1052"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1053"><a href="#cb72-1053"></a><span class="kw">WITH</span> NESTED <span class="kw">AS</span> (</span>
<span id="cb72-1054"><a href="#cb72-1054"></a>  <span class="kw">SELECT</span></span>
<span id="cb72-1055"><a href="#cb72-1055"></a>    purchase_id</span>
<span id="cb72-1056"><a href="#cb72-1056"></a>    , string_agg(product_id, <span class="st">','</span>) prudct_ids</span>
<span id="cb72-1057"><a href="#cb72-1057"></a>  <span class="kw">FROM</span> purchase_detail_log</span>
<span id="cb72-1058"><a href="#cb72-1058"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> purchase_id</span>
<span id="cb72-1059"><a href="#cb72-1059"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> purchase_id</span>
<span id="cb72-1060"><a href="#cb72-1060"></a>)</span>
<span id="cb72-1061"><a href="#cb72-1061"></a><span class="kw">SELECT</span></span>
<span id="cb72-1062"><a href="#cb72-1062"></a>  purchase_id</span>
<span id="cb72-1063"><a href="#cb72-1063"></a>  , UNNEST(string_split(prudct_ids, <span class="st">','</span>)) product_id</span>
<span id="cb72-1064"><a href="#cb72-1064"></a><span class="kw">FROM</span> NESTED;</span>
<span id="cb72-1065"><a href="#cb72-1065"></a><span class="in">```</span></span>
<span id="cb72-1066"><a href="#cb72-1066"></a></span>
<span id="cb72-1067"><a href="#cb72-1067"></a></span>
<span id="cb72-1068"><a href="#cb72-1068"></a><span class="fu"># 複数のテーブルに対する操作</span></span>
<span id="cb72-1069"><a href="#cb72-1069"></a></span>
<span id="cb72-1070"><a href="#cb72-1070"></a></span>
<span id="cb72-1071"><a href="#cb72-1071"></a><span class="fu">## 縦に並べる</span></span>
<span id="cb72-1072"><a href="#cb72-1072"></a></span>
<span id="cb72-1073"><a href="#cb72-1073"></a><span class="in">`UNION`</span>か<span class="in">`UNION ALL`</span>句を使う。</span>
<span id="cb72-1074"><a href="#cb72-1074"></a></span>
<span id="cb72-1075"><a href="#cb72-1075"></a>結合するときには同じカラム構造にしておく必要がある。</span>
<span id="cb72-1076"><a href="#cb72-1076"></a></span>
<span id="cb72-1077"><a href="#cb72-1077"></a></span>
<span id="cb72-1080"><a href="#cb72-1080"></a><span class="in">```{sql}</span></span>
<span id="cb72-1081"><a href="#cb72-1081"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1082"><a href="#cb72-1082"></a><span class="kw">SELECT</span> <span class="st">'app1'</span> <span class="kw">AS</span> app_name, user_id, name, email <span class="kw">FROM</span> app1_mst_users</span>
<span id="cb72-1083"><a href="#cb72-1083"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb72-1084"><a href="#cb72-1084"></a><span class="kw">SELECT</span> <span class="st">'app2'</span> <span class="kw">AS</span> app_name, user_id, name, <span class="kw">NULL</span> <span class="kw">AS</span> email <span class="kw">FROM</span> app2_mst_users;</span>
<span id="cb72-1085"><a href="#cb72-1085"></a><span class="in">```</span></span>
<span id="cb72-1086"><a href="#cb72-1086"></a><span class="fu">## 複数のテーブルを横に並べる</span></span>
<span id="cb72-1087"><a href="#cb72-1087"></a></span>
<span id="cb72-1088"><a href="#cb72-1088"></a></span>
<span id="cb72-1089"><a href="#cb72-1089"></a><span class="in">`JOIN`</span>句を使う。一般に単に<span class="in">`JOIN`</span>とした場合には<span class="in">`inner JOIN`</span>がおこなわれる。</span>
<span id="cb72-1090"><a href="#cb72-1090"></a></span>
<span id="cb72-1093"><a href="#cb72-1093"></a><span class="in">```{sql}</span></span>
<span id="cb72-1094"><a href="#cb72-1094"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1095"><a href="#cb72-1095"></a><span class="kw">SELECT</span></span>
<span id="cb72-1096"><a href="#cb72-1096"></a>  m<span class="ch">.</span>category_id</span>
<span id="cb72-1097"><a href="#cb72-1097"></a>  , m<span class="ch">.</span>name</span>
<span id="cb72-1098"><a href="#cb72-1098"></a>  , s<span class="ch">.</span>sales</span>
<span id="cb72-1099"><a href="#cb72-1099"></a>  , r<span class="ch">.</span>product_id sales_product</span>
<span id="cb72-1100"><a href="#cb72-1100"></a><span class="kw">FROM</span></span>
<span id="cb72-1101"><a href="#cb72-1101"></a>  mst_categories <span class="kw">as</span> m</span>
<span id="cb72-1102"><a href="#cb72-1102"></a>  <span class="kw">JOIN</span></span>
<span id="cb72-1103"><a href="#cb72-1103"></a>    category_sales <span class="kw">as</span> s</span>
<span id="cb72-1104"><a href="#cb72-1104"></a>    <span class="kw">ON</span> m<span class="ch">.</span>category_id <span class="op">=</span> s<span class="ch">.</span>category_id</span>
<span id="cb72-1105"><a href="#cb72-1105"></a>  <span class="kw">JOIN</span></span>
<span id="cb72-1106"><a href="#cb72-1106"></a>    product_sale_ranking <span class="kw">as</span> r</span>
<span id="cb72-1107"><a href="#cb72-1107"></a>    <span class="kw">ON</span> m<span class="ch">.</span>category_id <span class="op">=</span> r<span class="ch">.</span>category_id</span>
<span id="cb72-1108"><a href="#cb72-1108"></a>;</span>
<span id="cb72-1109"><a href="#cb72-1109"></a></span>
<span id="cb72-1110"><a href="#cb72-1110"></a><span class="in">```</span></span>
<span id="cb72-1111"><a href="#cb72-1111"></a></span>
<span id="cb72-1112"><a href="#cb72-1112"></a></span>
<span id="cb72-1113"><a href="#cb72-1113"></a><span class="in">`相関サブクエリ`</span>が使える場合には、JOINをも居て複数のテーブルの値を横に並べることが可能である。</span>
<span id="cb72-1114"><a href="#cb72-1114"></a></span>
<span id="cb72-1115"><a href="#cb72-1115"></a></span>
<span id="cb72-1118"><a href="#cb72-1118"></a><span class="in">```{sql}</span></span>
<span id="cb72-1119"><a href="#cb72-1119"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1120"><a href="#cb72-1120"></a><span class="kw">SELECT</span></span>
<span id="cb72-1121"><a href="#cb72-1121"></a>  m<span class="ch">.</span>category_id</span>
<span id="cb72-1122"><a href="#cb72-1122"></a>  , m<span class="ch">.</span>name</span>
<span id="cb72-1123"><a href="#cb72-1123"></a>  <span class="co">---相関サブクエリを使いカテゴリー別の売上額を取得</span></span>
<span id="cb72-1124"><a href="#cb72-1124"></a>  , (<span class="kw">SELECT</span> s<span class="ch">.</span>sales <span class="kw">FROM</span> category_sales <span class="kw">as</span> s <span class="kw">WHERE</span> m<span class="ch">.</span>category_id <span class="op">=</span> s<span class="ch">.</span>category_id) sales</span>
<span id="cb72-1125"><a href="#cb72-1125"></a>  , (<span class="kw">SELECT</span> r<span class="ch">.</span>product_id <span class="kw">FROM</span> product_sale_ranking r <span class="kw">WHERE</span> m<span class="ch">.</span>category_id <span class="op">=</span> r<span class="ch">.</span>category_id</span>
<span id="cb72-1126"><a href="#cb72-1126"></a>     <span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">1</span>) top_sale_product</span>
<span id="cb72-1127"><a href="#cb72-1127"></a><span class="kw">FROM</span></span>
<span id="cb72-1128"><a href="#cb72-1128"></a>  mst_categories <span class="kw">as</span> m</span>
<span id="cb72-1129"><a href="#cb72-1129"></a>;</span>
<span id="cb72-1130"><a href="#cb72-1130"></a></span>
<span id="cb72-1131"><a href="#cb72-1131"></a><span class="in">```</span></span>
<span id="cb72-1132"><a href="#cb72-1132"></a></span>
<span id="cb72-1133"><a href="#cb72-1133"></a></span>
<span id="cb72-1134"><a href="#cb72-1134"></a><span class="fu">## 条件のフラグを0, 1で表現する</span></span>
<span id="cb72-1135"><a href="#cb72-1135"></a></span>
<span id="cb72-1136"><a href="#cb72-1136"></a></span>
<span id="cb72-1137"><a href="#cb72-1137"></a>CASE式で場合分けをするのが、SIGN関数で0と1に変換する方法がある。</span>
<span id="cb72-1138"><a href="#cb72-1138"></a></span>
<span id="cb72-1139"><a href="#cb72-1139"></a></span>
<span id="cb72-1140"><a href="#cb72-1140"></a></span>
<span id="cb72-1143"><a href="#cb72-1143"></a><span class="in">```{sql}</span></span>
<span id="cb72-1144"><a href="#cb72-1144"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1145"><a href="#cb72-1145"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mst_users_with_card_number;</span>
<span id="cb72-1146"><a href="#cb72-1146"></a><span class="in">```</span></span>
<span id="cb72-1147"><a href="#cb72-1147"></a></span>
<span id="cb72-1150"><a href="#cb72-1150"></a><span class="in">```{sql}</span></span>
<span id="cb72-1151"><a href="#cb72-1151"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1152"><a href="#cb72-1152"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> purchase_log;</span>
<span id="cb72-1153"><a href="#cb72-1153"></a><span class="in">```</span></span>
<span id="cb72-1154"><a href="#cb72-1154"></a></span>
<span id="cb72-1157"><a href="#cb72-1157"></a><span class="in">```{sql}</span></span>
<span id="cb72-1158"><a href="#cb72-1158"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1159"><a href="#cb72-1159"></a><span class="kw">SELECT</span></span>
<span id="cb72-1160"><a href="#cb72-1160"></a>  m<span class="ch">.</span>user_id</span>
<span id="cb72-1161"><a href="#cb72-1161"></a>  , m<span class="ch">.</span>card_number</span>
<span id="cb72-1162"><a href="#cb72-1162"></a>  , <span class="fu">COUNT</span>(p<span class="ch">.</span>user_id) <span class="kw">as</span> purchase_count</span>
<span id="cb72-1163"><a href="#cb72-1163"></a>  , <span class="cf">CASE</span> <span class="cf">WHEN</span> m<span class="ch">.</span>card_number <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span> <span class="kw">as</span> has_card</span>
<span id="cb72-1164"><a href="#cb72-1164"></a>  , <span class="fu">SIGN</span>(<span class="fu">COUNT</span>(p<span class="ch">.</span>user_id)) <span class="kw">as</span> has_purchased</span>
<span id="cb72-1165"><a href="#cb72-1165"></a><span class="kw">FROM</span> </span>
<span id="cb72-1166"><a href="#cb72-1166"></a>  mst_users_with_card_number <span class="kw">as</span> m</span>
<span id="cb72-1167"><a href="#cb72-1167"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb72-1168"><a href="#cb72-1168"></a>    purchase_log <span class="kw">as</span> p</span>
<span id="cb72-1169"><a href="#cb72-1169"></a>    <span class="kw">ON</span> m<span class="ch">.</span>user_id <span class="op">=</span> p<span class="ch">.</span>user_id</span>
<span id="cb72-1170"><a href="#cb72-1170"></a><span class="kw">GROUP</span> <span class="kw">BY</span> m<span class="ch">.</span>user_id, m<span class="ch">.</span>card_number</span>
<span id="cb72-1171"><a href="#cb72-1171"></a><span class="in">```</span></span>
<span id="cb72-1172"><a href="#cb72-1172"></a></span>
<span id="cb72-1173"><a href="#cb72-1173"></a></span>
<span id="cb72-1174"><a href="#cb72-1174"></a><span class="fu">## 計算したテーブルに名前を付けて再利用する</span></span>
<span id="cb72-1175"><a href="#cb72-1175"></a></span>
<span id="cb72-1176"><a href="#cb72-1176"></a>SQL99におけるCTE(Common Table Expression)を用いると１つのクエリの中で使える</span>
<span id="cb72-1177"><a href="#cb72-1177"></a>一時的なテーブルに名前を付けて利用できるため、クエリの可読性が大きく向上する。</span>
<span id="cb72-1178"><a href="#cb72-1178"></a></span>
<span id="cb72-1181"><a href="#cb72-1181"></a><span class="in">```{sql}</span></span>
<span id="cb72-1182"><a href="#cb72-1182"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1183"><a href="#cb72-1183"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> product_sales;</span>
<span id="cb72-1184"><a href="#cb72-1184"></a><span class="in">```</span></span>
<span id="cb72-1185"><a href="#cb72-1185"></a></span>
<span id="cb72-1186"><a href="#cb72-1186"></a>カテゴリーごとにランキングを付ける。そして、同じ順位の商品を横並びにする。</span>
<span id="cb72-1187"><a href="#cb72-1187"></a></span>
<span id="cb72-1190"><a href="#cb72-1190"></a><span class="in">```{sql}</span></span>
<span id="cb72-1191"><a href="#cb72-1191"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1192"><a href="#cb72-1192"></a></span>
<span id="cb72-1193"><a href="#cb72-1193"></a><span class="kw">WITH</span></span>
<span id="cb72-1194"><a href="#cb72-1194"></a></span>
<span id="cb72-1195"><a href="#cb72-1195"></a>product_sale_ranking <span class="kw">as</span> (</span>
<span id="cb72-1196"><a href="#cb72-1196"></a>  <span class="kw">SELECT</span></span>
<span id="cb72-1197"><a href="#cb72-1197"></a>    category_name</span>
<span id="cb72-1198"><a href="#cb72-1198"></a>    , product_id</span>
<span id="cb72-1199"><a href="#cb72-1199"></a>    , sales</span>
<span id="cb72-1200"><a href="#cb72-1200"></a>    , ROW_NUMBER() OVER(PARTITION <span class="kw">BY</span> category_name <span class="kw">ORDER</span> <span class="kw">BY</span> sales <span class="kw">DESC</span>) rank</span>
<span id="cb72-1201"><a href="#cb72-1201"></a>  <span class="kw">FROM</span> </span>
<span id="cb72-1202"><a href="#cb72-1202"></a>    product_sales</span>
<span id="cb72-1203"><a href="#cb72-1203"></a>)</span>
<span id="cb72-1204"><a href="#cb72-1204"></a>, mst_rank <span class="kw">as</span> (</span>
<span id="cb72-1205"><a href="#cb72-1205"></a>  <span class="kw">SELECT</span> <span class="kw">DISTINCT</span> rank</span>
<span id="cb72-1206"><a href="#cb72-1206"></a>  <span class="kw">FROM</span> product_sale_ranking</span>
<span id="cb72-1207"><a href="#cb72-1207"></a>)</span>
<span id="cb72-1208"><a href="#cb72-1208"></a><span class="kw">SELECT</span></span>
<span id="cb72-1209"><a href="#cb72-1209"></a>  m<span class="ch">.</span>rank</span>
<span id="cb72-1210"><a href="#cb72-1210"></a>  , r1<span class="ch">.</span>product_id <span class="kw">as</span> dvd</span>
<span id="cb72-1211"><a href="#cb72-1211"></a>  , r1<span class="ch">.</span>sales <span class="kw">as</span> dvd_sales</span>
<span id="cb72-1212"><a href="#cb72-1212"></a>  , r2<span class="ch">.</span>product_id <span class="kw">as</span> cd</span>
<span id="cb72-1213"><a href="#cb72-1213"></a>  , r2<span class="ch">.</span>sales <span class="kw">as</span> cd_sales</span>
<span id="cb72-1214"><a href="#cb72-1214"></a>  , r3<span class="ch">.</span>product_id <span class="kw">as</span> book</span>
<span id="cb72-1215"><a href="#cb72-1215"></a>  , r3<span class="ch">.</span>sales <span class="kw">as</span> book_sales</span>
<span id="cb72-1216"><a href="#cb72-1216"></a><span class="kw">FROM</span></span>
<span id="cb72-1217"><a href="#cb72-1217"></a>  mst_rank <span class="kw">as</span> m</span>
<span id="cb72-1218"><a href="#cb72-1218"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb72-1219"><a href="#cb72-1219"></a>    product_sale_ranking r1</span>
<span id="cb72-1220"><a href="#cb72-1220"></a>    <span class="kw">on</span> m<span class="ch">.</span>rank <span class="op">=</span> r1<span class="ch">.</span>rank</span>
<span id="cb72-1221"><a href="#cb72-1221"></a>    <span class="kw">AND</span> r1<span class="ch">.</span>category_name <span class="op">=</span> <span class="st">'dvd'</span></span>
<span id="cb72-1222"><a href="#cb72-1222"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb72-1223"><a href="#cb72-1223"></a>    product_sale_ranking r2</span>
<span id="cb72-1224"><a href="#cb72-1224"></a>    <span class="kw">ON</span> m<span class="ch">.</span>rank <span class="op">=</span> r2<span class="ch">.</span>rank</span>
<span id="cb72-1225"><a href="#cb72-1225"></a>    <span class="kw">AND</span> r2<span class="ch">.</span>category_name <span class="op">=</span> <span class="st">'cd'</span></span>
<span id="cb72-1226"><a href="#cb72-1226"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb72-1227"><a href="#cb72-1227"></a>    product_sale_ranking <span class="kw">as</span> r3</span>
<span id="cb72-1228"><a href="#cb72-1228"></a>    <span class="kw">ON</span> m<span class="ch">.</span>rank <span class="op">=</span> r3<span class="ch">.</span>rank</span>
<span id="cb72-1229"><a href="#cb72-1229"></a>    <span class="kw">AND</span> r3<span class="ch">.</span>category_name <span class="op">=</span> <span class="st">'book'</span></span>
<span id="cb72-1230"><a href="#cb72-1230"></a><span class="kw">ORDER</span> <span class="kw">BY</span> m<span class="ch">.</span>rank</span>
<span id="cb72-1231"><a href="#cb72-1231"></a></span>
<span id="cb72-1232"><a href="#cb72-1232"></a>;</span>
<span id="cb72-1233"><a href="#cb72-1233"></a><span class="in">```</span></span>
<span id="cb72-1234"><a href="#cb72-1234"></a></span>
<span id="cb72-1235"><a href="#cb72-1235"></a><span class="fu">## 擬似的なテーブルを作成する</span></span>
<span id="cb72-1236"><a href="#cb72-1236"></a></span>
<span id="cb72-1237"><a href="#cb72-1237"></a>ダミーでテーブルを作成して、実際に集計を試す。</span>
<span id="cb72-1238"><a href="#cb72-1238"></a></span>
<span id="cb72-1239"><a href="#cb72-1239"></a><span class="fu">### 任意のレコードを持つ</span></span>
<span id="cb72-1240"><a href="#cb72-1240"></a></span>
<span id="cb72-1243"><a href="#cb72-1243"></a><span class="in">```{sql}</span></span>
<span id="cb72-1244"><a href="#cb72-1244"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1245"><a href="#cb72-1245"></a><span class="kw">WITH</span></span>
<span id="cb72-1246"><a href="#cb72-1246"></a>mst_devices <span class="kw">as</span> (</span>
<span id="cb72-1247"><a href="#cb72-1247"></a>            <span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">as</span> device_id, <span class="st">'pc'</span> <span class="kw">as</span> device_name</span>
<span id="cb72-1248"><a href="#cb72-1248"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">SELECT</span> <span class="dv">2</span> <span class="kw">as</span> device_id, <span class="st">'sp'</span> <span class="kw">as</span> device_name</span>
<span id="cb72-1249"><a href="#cb72-1249"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">SELECT</span> <span class="dv">3</span> <span class="kw">as</span> device_id, <span class="st">'アプリ'</span> <span class="kw">as</span> device_name</span>
<span id="cb72-1250"><a href="#cb72-1250"></a>)</span>
<span id="cb72-1251"><a href="#cb72-1251"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb72-1252"><a href="#cb72-1252"></a><span class="kw">FROM</span> mst_devices;</span>
<span id="cb72-1253"><a href="#cb72-1253"></a></span>
<span id="cb72-1254"><a href="#cb72-1254"></a><span class="in">```</span></span>
<span id="cb72-1255"><a href="#cb72-1255"></a></span>
<span id="cb72-1256"><a href="#cb72-1256"></a><span class="in">`VALUES`</span>で作成することも可能である。</span>
<span id="cb72-1257"><a href="#cb72-1257"></a><span class="in">`vALUES`</span>は<span class="in">`INSERT`</span>とことなりまとめてロードが行える</span>
<span id="cb72-1258"><a href="#cb72-1258"></a></span>
<span id="cb72-1261"><a href="#cb72-1261"></a><span class="in">```{sql}</span></span>
<span id="cb72-1262"><a href="#cb72-1262"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1263"><a href="#cb72-1263"></a><span class="kw">WITH</span></span>
<span id="cb72-1264"><a href="#cb72-1264"></a>mst_devices(device_id, device_name) <span class="kw">AS</span>(</span>
<span id="cb72-1265"><a href="#cb72-1265"></a>  <span class="kw">VALUES</span></span>
<span id="cb72-1266"><a href="#cb72-1266"></a>    (<span class="dv">1</span>, <span class="st">'PC'</span>)</span>
<span id="cb72-1267"><a href="#cb72-1267"></a>)</span>
<span id="cb72-1268"><a href="#cb72-1268"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb72-1269"><a href="#cb72-1269"></a><span class="kw">FROM</span> mst_devices;</span>
<span id="cb72-1270"><a href="#cb72-1270"></a><span class="in">```</span></span>
<span id="cb72-1271"><a href="#cb72-1271"></a></span>
<span id="cb72-1272"><a href="#cb72-1272"></a>配列型テーブル関数を用いた疑似テーブルの作成ができるミドルウェアもある。</span>
<span id="cb72-1273"><a href="#cb72-1273"></a></span>
<span id="cb72-1274"><a href="#cb72-1274"></a></span>
<span id="cb72-1275"><a href="#cb72-1275"></a></span>
<span id="cb72-1276"><a href="#cb72-1276"></a><span class="fu">### 連番を用いてテーブルを作成する</span></span>
<span id="cb72-1277"><a href="#cb72-1277"></a></span>
<span id="cb72-1280"><a href="#cb72-1280"></a><span class="in">```{sql}</span></span>
<span id="cb72-1281"><a href="#cb72-1281"></a><span class="co">#| connection: con</span></span>
<span id="cb72-1282"><a href="#cb72-1282"></a><span class="kw">WITH</span> </span>
<span id="cb72-1283"><a href="#cb72-1283"></a>series <span class="kw">as</span> (</span>
<span id="cb72-1284"><a href="#cb72-1284"></a>  <span class="kw">SELECT</span> unnest(generate_series(<span class="dv">1</span>, <span class="dv">5</span>)) idx</span>
<span id="cb72-1285"><a href="#cb72-1285"></a>)</span>
<span id="cb72-1286"><a href="#cb72-1286"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb72-1287"><a href="#cb72-1287"></a><span class="kw">FROM</span> series;</span>
<span id="cb72-1288"><a href="#cb72-1288"></a></span>
<span id="cb72-1289"><a href="#cb72-1289"></a><span class="in">```</span></span>
<span id="cb72-1290"><a href="#cb72-1290"></a></span>
<span id="cb72-1291"><a href="#cb72-1291"></a></span>
<span id="cb72-1292"><a href="#cb72-1292"></a><span class="fu"># Disconnect</span></span>
<span id="cb72-1293"><a href="#cb72-1293"></a></span>
<span id="cb72-1296"><a href="#cb72-1296"></a><span class="in">```{r}</span></span>
<span id="cb72-1297"><a href="#cb72-1297"></a><span class="fu">dbDisconnect</span>(con, <span class="at">shutdown=</span><span class="cn">TRUE</span>)</span>
<span id="cb72-1298"><a href="#cb72-1298"></a><span class="in">```</span> </span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>